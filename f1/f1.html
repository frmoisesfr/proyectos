<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Simulator 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Racing+Sans+One&family=Rajdhani:wght@400;600;700&display=swap');
        
        :root {
            --f1-red: #e10600;
            --f1-dark: #15151e;
            --f1-silver: #c0c0c0;
            --f1-gold: #ffd700;
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a2e;
            --bg-card: #1a1a2e;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --accent-primary: #e10600;
            --accent-secondary: #ffd700;
        }

        /* Tema Deportivo */
        body[data-theme="sporty"] {
            --f1-red: #ff0000;
            --accent-primary: #ff0000;
            --accent-secondary: #00ff00;
            --bg-primary: #000000;
            --bg-secondary: #1a0000;
            --bg-card: #2a0000;
            --border-color: #ff0000;
        }

        /* Tema Retro */
        body[data-theme="retro"] {
            --f1-red: #ff6b35;
            --accent-primary: #ff6b35;
            --accent-secondary: #f7931e;
            --bg-primary: #2d1b00;
            --bg-secondary: #3d2914;
            --bg-card: #4a3728;
            --text-primary: #f5deb3;
            --text-secondary: #d2b48c;
            --border-color: #8b7355;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
            color: var(--text-primary);
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
            overflow-x: hidden;
        }
        
        h1, h2, h3 {
            font-family: 'Racing Sans One', cursive;
            letter-spacing: 2px;
        }
        
        button {
            min-height: 48px;
            touch-action: manipulation;
        }
   
        /* Estilos para los sliders de volumen */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #dc2626;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #dc2626;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 0 10px rgba(220, 38, 38, 0.5);
        }

        input[type="range"]:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        input[type="range"]:disabled::-webkit-slider-thumb {
            background: #6b7280;
            box-shadow: none;
        }

        input[type="range"]:disabled::-moz-range-thumb {
            background: #6b7280;
            box-shadow: none;
        }

        .racing-bg {
            position: relative;
            z-index: 1;
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(225, 6, 0, 0.03) 10px,
                    rgba(225, 6, 0, 0.03) 20px
                );
        }
        
        .racing-border {
            position: relative;
            border: 2px solid transparent;
            background: linear-gradient(#1a1a2e, #1a1a2e) padding-box,
                        linear-gradient(45deg, var(--f1-red), var(--f1-gold), var(--f1-red)) border-box;
        }

        .glow-red {
            box-shadow: 0 0 20px rgba(225, 6, 0, 0.5),
                        0 0 40px rgba(225, 6, 0, 0.3);
        }
        
        .news-bar {
            background: linear-gradient(90deg, 
                rgba(225,6,0,0.9) 0%, 
                rgba(20,20,30,0.95) 50%, 
                rgba(225,6,0,0.9) 100%);
            border-top: 2px solid var(--accent-primary);
            border-bottom: 2px solid var(--accent-primary);
            overflow: hidden;
        }
        
        .news-ticker {
            display: inline-block;
            animation: scroll-left 20s linear infinite;
            padding-left: 100%;
            font-weight: 700;
            font-size: 1rem;
            white-space: nowrap;
            text-transform: uppercase;
        }
        
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        .spinner {
            border-top-color: var(--f1-red);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(225, 6, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(225, 6, 0, 0.8); }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(225, 6, 0, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, #b30500 100%);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 95%;
            max-height: 90%;
            overflow-y: auto;
            border: 2px solid var(--f1-red);
            box-shadow: 0 0 50px rgba(225, 6, 0, 0.5);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, 
                var(--f1-red) 0%, 
                var(--f1-gold) 50%, 
                var(--f1-red) 100%);
            transition: width 0.3s ease;
        }
        
        .tire-soft { color: #ef4444; }
        .tire-medium { color: #f59e0b; }
        .tire-hard { color: #e5e7eb; }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb { background: var(--f1-red); border-radius: 5px; }
        
        .team-badge {
            border-radius: 50%;
            box-shadow: 0 0 15px currentColor;
        }
        
        .pos-1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #000; font-weight: 900; }
        .pos-2 { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); color: #000; font-weight: 900; }
        .pos-3 { background: linear-gradient(135deg, #cd7f32 0%, #e49b5f 100%); color: #fff; font-weight: 900; }
        
        .stat-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .stat-high { background: #10b981; color: white; }
        .stat-medium { background: #f59e0b; color: white; }
        .stat-low { background: #ef4444; color: white; }
        
        /* Circuito visual */
        .circuit-map {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f1419 100%);
            border: 2px solid #e10600;
            border-radius: 12px;
            padding: 20px;
        }
        
        .circuit-path {
            stroke: #e10600;
            stroke-width: 8;
            fill: none;
            filter: drop-shadow(0 0 10px rgba(225, 6, 0, 0.5));
        }
        
        .circuit-inner {
            stroke: #4a4a4a;
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 5,5;
        }
        
        .start-finish {
            fill: #10b981;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .direction-arrow {
            fill: #ffd700;
            animation: moveArrow 2s ease-in-out infinite;
        }
        
        @keyframes moveArrow {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(5px); }
        }
                
        @media (max-width: 640px) {
            .news-ticker { font-size: 0.875rem; }
            h1 { font-size: 2rem; }
            .main-game-grid {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 1024px) {
            .main-game-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        /* Sistema de pestañas */
        .tab-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #374151;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab-button.active {
            color: #e10600;
            border-bottom-color: #e10600;
        }

        .tab-button:hover {
            color: #f59e0b;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Layout más compacto */
        .compact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .compact-stat {
            background: var(--bg-card);
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .compact-stat-label {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 0.25rem;
        }

        .compact-stat-value {
            font-size: 1rem;
            font-weight: bold;
        }

        /* Mapa de circuito */
        .circuit-map-compact {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-primary) 100%);
            border: 2px solid var(--accent-primary);
            border-radius: 0.75rem;
            padding: 0.5rem;
            min-height: 300px;
            height: auto;
        }

        /* Neumáticos compactos */
        .tire-compact {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background: var(--bg-card);
            border-radius: 0.5rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tire-compact.selected {
            border-color: #3b82f6;
            background: #1e3a8a;
        }

        .tire-compact:hover {
            background: #374151;
        }

        /* Reducir espaciado general */
        .racing-border {
            padding: 1rem;
        }

        @media (min-width: 640px) {
            .main-game-grid {
                display: grid;
                grid-template-columns: 1.5fr 1fr 1fr;
                gap: 1rem;
            }
        }

        /* Estilos específicos para tema deportivo */
        body[data-theme="sporty"] .racing-border {
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 0, 0, 0.8); }
        }

        /* Estilos específicos para tema retro */
        body[data-theme="retro"] {
            font-family: 'Courier New', monospace;
        }

        body[data-theme="retro"] .racing-border {
            border-style: dashed;
        }

        body[data-theme="retro"] .btn-primary {
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.5);
        }

        body[data-theme="retro"] .btn-primary:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5);
        }

        /* Transiciones suaves para cambios de tema */
        body, .racing-border, .btn-primary, .compact-stat, .tire-compact {
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        /* Sistema de partículas mejorado */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            pointer-events: none;
        }

        /* Humo mejorado con múltiples capas */
        .smoke-particle {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(220,220,220,0.7) 0%, rgba(100,100,100,0.3) 50%, transparent 100%);
            border-radius: 50%;
            filter: blur(8px);
            animation: smokeRise 2.5s ease-out forwards;
        }

        .smoke-particle.dark {
            background: radial-gradient(circle, rgba(80,80,80,0.8) 0%, rgba(40,40,40,0.4) 50%, transparent 100%);
        }

        @keyframes smokeRise {
            0% {
                transform: translateY(0) translateX(0) scale(0.3) rotate(0deg);
                opacity: 0.9;
            }
            50% {
                transform: translateY(-120px) translateX(var(--drift)) scale(1.5) rotate(180deg);
                opacity: 0.6;
            }
            100% {
                transform: translateY(-250px) translateX(calc(var(--drift) * 2)) scale(2.5) rotate(360deg);
                opacity: 0;
            }
        }

        /* Líneas de velocidad para inicio */
        .speed-line {
            width: 150px;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.8) 50%, transparent 100%);
            animation: speedLine 0.8s ease-out forwards;
        }

        @keyframes speedLine {
            0% {
                transform: translateX(100vw) scaleX(1);
                opacity: 1;
            }
            100% {
                transform: translateX(-200px) scaleX(0.3);
                opacity: 0;
            }
        }

        /* Confeti mejorado con formas variadas */
        .confetti-particle {
            width: 12px;
            height: 12px;
            animation: confettiFall 4s ease-in-out forwards;
        }

        .confetti-particle.rect {
            width: 8px;
            height: 15px;
        }

        .confetti-particle.circle {
            border-radius: 50%;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100px) translateX(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) translateX(var(--drift)) rotate(var(--rotation));
                opacity: 0.3;
            }
        }

        /* Explosión de estrellas para pole */
        .star-particle {
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 10px solid #FFD700;
            position: relative;
            animation: starBurst 1.2s ease-out forwards;
        }

        .star-particle::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 10px solid #FFD700;
            top: 3px;
            left: -6px;
        }

        @keyframes starBurst {
            0% {
                transform: translate(0, 0) scale(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(var(--rotation));
                opacity: 0;
            }
        }

        /* Ondas de choque doradas */
        .shockwave {
            position: absolute;
            width: 50px;
            height: 50px;
            border: 3px solid #FFD700;
            border-radius: 50%;
            animation: shockwaveExpand 1s ease-out forwards;
        }

        @keyframes shockwaveExpand {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(15);
                opacity: 0;
            }
        }

        /* Texto celebratorio animado */
        .celebration-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255,215,0,0.8), 0 0 40px rgba(255,215,0,0.5);
            animation: celebrationPop 2s ease-out forwards;
            z-index: 10000;
            white-space: nowrap;
        }

        @keyframes celebrationPop {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-10deg);
                opacity: 0;
            }
            20% {
                transform: translate(-50%, -50%) scale(1.2) rotate(5deg);
                opacity: 1;
            }
            40% {
                transform: translate(-50%, -50%) scale(0.95) rotate(-2deg);
            }
            60% {
                transform: translate(-50%, -50%) scale(1.05) rotate(1deg);
            }
            80% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.1) rotate(0deg);
                opacity: 0;
            }
        }

        /* Flash mejorado */
        .pole-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,215,0,0.6) 0%, rgba(255,165,0,0.3) 50%, transparent 100%);
            pointer-events: none;
            z-index: 9998;
            animation: flashEffect 0.8s ease-out;
        }

        @keyframes flashEffect {
            0%, 100% { opacity: 0; }
            30% { opacity: 1; }
            70% { opacity: 0.5; }
        }

    </style>
</head>
<body class="min-h-screen text-white">
 
    <div id="app">
        <div class="text-center py-20 px-4">
            <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-600 via-yellow-500 to-red-600">
                CARGANDO F1 SIMULATOR...
            </h1>
            <div class="w-16 h-16 border-4 border-red-600 border-t-transparent rounded-full spinner mx-auto"></div>
        </div>
    </div>

    <div id="standingsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">
                    CLASIFICACIÓN DE PILOTOS
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="standingsContent"></div>
        </div>
    </div>

    <div id="raceTimesModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">
                    TIEMPOS DE CARRERA
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="raceTimesContent"></div>
        </div>
    </div>

    <div id="achievementsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-500 to-orange-500">
                    LOGROS
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="achievementsContent"></div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">
                    CONFIGURACIÓN
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="settingsContent"></div>
        </div>
    </div>

    

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-500">
                    HISTORIAL DE TEMPORADAS
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="historyContent"></div>
        </div>
    </div>

    <div id="seasonDetailsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-500">
                    DETALLES DE TEMPORADA
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="seasonDetailsContent"></div>
        </div>
    </div>    

    <div id="themeSelectorModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-500">
                    TEMAS VISUALES
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="themeSelectorContent"></div>
        </div>
    </div>

    <div id="audioSettingsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-blue-500">
                    CONFIGURACIÓN DE AUDIO
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="audioSettingsContent"></div>
        </div>
    </div>


    <script>
        let gameData = {
            state: 'main-menu',
            player: {
                name: '',
                age: 20,
                nationality: '',
                experience: 0,
                championships: 0,
                reputation: 50,
                points: 0,
                skills: {
                    speed: 50,
                    control: 50,
                    strategy: 50,
                    overtaking: 50,
                    streetSpecialist: 50,
                    ovalSpecialist: 50,
                    mountainSpecialist: 50,
                    rainMastery: 50
                }
            },
            selectedTeam: null,
            currentRace: 0,
            racePhase: 'practice',
            trainingDone: false,
            qualifyingPos: null,
            raceResults: [],
            raceClassification: [],
            raceTimes: [],
            isProcessing: false,
            selectedTireCompound: 'medium',
            pitStops: 0,
            tireWear: 0,
            currentWeather: 'sunny',
            driverStandings: {},
            devBudget: 500, // Nuevo
            carUpgrades: { // Nuevo
                power: 0,
                aerodynamics: 0,
                reliability: 0,
                chassis: 0
            },
            qualifyingPos: null,
            pitStopPlanned: false, // Nuevo
            pitStopLap: 0, // Nuevo
            pitStopNewTire: 'medium', // Nuevo
            currentLap: 0, // Nuevo
            totalLaps: 0, // Nuevo
            achievements: {}, // Nuevo
            newAchievements: [], // Nuevo - para mostrar logros recién desbloqueados
            difficulty: 'normal',
            activeTab: 'info', // Nuevo - para recordar qué pestaña está activa
            currentDamage: null, // Nuevo
            damageRepaired: false, // Nuevo
            seasonsHistory: [], // Nuevo
            pressEvents: [], 
            teamOffers: [] ,
            raceEvents: [] ,
            raceMode: 'auto',  // 'auto' o 'interactive'
            racePaused: false,
            currentLapView: 0,
            pendingDecision: null
        };

        // Sistema de noticias
        let newsItems = [];
        let newsRotationInterval = null;

        // Sistema de eventos aleatorios
        const raceEvents = {
            'safety-car': { 
                name: 'Safety Car', 
                icon: '🚨', 
                probability: 0.15,
                effect: (classification) => {
                    // Comprime el pelotón
                    classification.forEach((driver, idx) => {
                        driver.score += (20 - idx) * 0.5;
                    });
                    return 'Safety Car desplegado - El pelotón se comprime';
                }
            },
            'mechanical-failure': { 
                name: 'Fallo Mecánico', 
                icon: '⚙️', 
                probability: 0.08,
                effect: (classification, playerName) => {
                    const randomDriver = classification[Math.floor(Math.random() * Math.min(10, classification.length))];
                    if (randomDriver.name === playerName && Math.random() > 0.3) {
                        randomDriver.score -= 25;
                        return `¡Tu coche ha sufrido un problema mecánico!`;
                    } else if (randomDriver.name !== playerName) {
                        randomDriver.score -= 30;
                        return `${randomDriver.name} abandona por fallo mecánico`;
                    }
                    return null;
                }
            },
            'collision': { 
                name: 'Colisión', 
                icon: '💥', 
                probability: 0.10,
                effect: (classification, playerName) => {
                    const affectedDrivers = classification.slice(5, 12);
                    if (affectedDrivers.length > 0) {
                        const victim = affectedDrivers[Math.floor(Math.random() * affectedDrivers.length)];
                        victim.score -= 15;
                        if (victim.name === playerName) {
                            return '¡Has estado involucrado en un incidente!';
                        }
                        return `Incidente en pista - ${victim.name} afectado`;
                    }
                    return null;
                }
            },
            'perfect-lap': { 
                name: 'Vuelta Perfecta', 
                icon: '⭐', 
                probability: 0.12,
                effect: (classification, playerName) => {
                    const topDrivers = classification.slice(0, 5);
                    const luckyDriver = topDrivers[Math.floor(Math.random() * topDrivers.length)];
                    luckyDriver.score += 8;
                    if (luckyDriver.name === playerName) {
                        return '¡Has conseguido una vuelta perfecta!';
                    }
                    return `${luckyDriver.name} establece vuelta rápida`;
                }
            },
            'weather-change': { 
                name: 'Cambio de Clima', 
                icon: '🌦️', 
                probability: 0.08,
                effect: (classification, playerName, gameData) => {
                    const tire = tireCompounds[gameData.selectedTireCompound];
                    const isRaining = Math.random() > 0.5;
                    
                    if (isRaining && !tire.wetWeather) {
                        // Los que tienen neumáticos secos sufren
                        classification.forEach(driver => {
                            if (driver.name === playerName) {
                                driver.score -= 12;
                            } else {
                                driver.score -= Math.random() * 10;
                            }
                        });
                        return '¡Empieza a llover! Neumáticos incorrectos penalizan';
                    } else if (!isRaining && tire.wetWeather) {
                        const playerDriver = classification.find(d => d.name === playerName);
                        if (playerDriver) playerDriver.score -= 8;
                        return 'La pista se seca - Neumáticos de lluvia ya no son óptimos';
                    }
                    return null;
                }
            }
        };

        // Datos del compañero de equipo
        let teammateComparison = {
            qualifyingBattles: { player: 0, teammate: 0 },
            raceBattles: { player: 0, teammate: 0 },
            pointsGap: 0
        };

        const teams = {
            'red-bull': { name: 'Red Bull Racing', color: '#1E3A8A', drivers: ['Max Verstappen', 'Sergio Pérez'], power: 95, reputation: 95, aerodynamics: 92, reliability: 90 },
            'ferrari': { name: 'Scuderia Ferrari', color: '#DC2626', drivers: ['Charles Leclerc', 'Carlos Sainz'], power: 90, reputation: 90, aerodynamics: 94, reliability: 85 },
            'mercedes': { name: 'Mercedes-AMG', color: '#06B6D4', drivers: ['Lewis Hamilton', 'George Russell'], power: 88, reputation: 88, aerodynamics: 90, reliability: 92 },
            'mclaren': { name: 'McLaren', color: '#F97316', drivers: ['Lando Norris', 'Oscar Piastri'], power: 85, reputation: 85, aerodynamics: 88, reliability: 87 },
            'aston-martin': { name: 'Aston Martin', color: '#059669', drivers: ['Fernando Alonso', 'Lance Stroll'], power: 82, reputation: 82, aerodynamics: 85, reliability: 88 },
            'alpine': { name: 'Alpine', color: '#3B82F6', drivers: ['Pierre Gasly', 'Esteban Ocon'], power: 80, reputation: 80, aerodynamics: 82, reliability: 84 },
            'williams': { name: 'Williams', color: '#0EA5E9', drivers: ['Alex Albon', 'Logan Sargeant'], power: 75, reputation: 70, aerodynamics: 78, reliability: 82 },
            'alphatauri': { name: 'AlphaTauri', color: '#475569', drivers: ['Yuki Tsunoda', 'Nyck de Vries'], power: 78, reputation: 72, aerodynamics: 80, reliability: 80 },
            'alfa-romeo': { name: 'Alfa Romeo', color: '#991B1B', drivers: ['Valtteri Bottas', 'Zhou Guanyu'], power: 77, reputation: 70, aerodynamics: 79, reliability: 78 },
            'haas': { name: 'Haas F1', color: '#EF4444', drivers: ['Kevin Magnussen', 'Nico Hulkenberg'], power: 73, reputation: 65, aerodynamics: 75, reliability: 76 }
        };

        const circuitTypes = {
            'street': { name: 'Urbano', color: 'bg-gray-600', skillBonus: 'streetSpecialist', aeroImportance: 0.6, powerImportance: 0.4 },
            'oval': { name: 'Óvalo', color: 'bg-red-600', skillBonus: 'ovalSpecialist', aeroImportance: 0.3, powerImportance: 0.7 },
            'mountain': { name: 'Montaña', color: 'bg-green-600', skillBonus: 'mountainSpecialist', aeroImportance: 0.8, powerImportance: 0.2 },
            'traditional': { name: 'Tradicional', color: 'bg-blue-600', skillBonus: null, aeroImportance: 0.5, powerImportance: 0.5 }
        };

        const weatherConditions = {
            'sunny': { name: 'Soleado', icon: '☀️', modifier: 0, color: 'text-yellow-400', tireWearMultiplier: 1.0 },
            'cloudy': { name: 'Nublado', icon: '☁️', modifier: -2, color: 'text-gray-400', tireWearMultiplier: 0.9 },
            'rainy': { name: 'Lluvia', icon: '🌧️', modifier: -15, color: 'text-blue-400', skillBonus: 'rainMastery', tireWearMultiplier: 0.7 },
            'windy': { name: 'Viento', icon: '💨', modifier: -8, color: 'text-green-400', tireWearMultiplier: 1.1 },
            'hot': { name: 'Calor Extremo', icon: '🔥', modifier: -5, color: 'text-red-400', tireWearMultiplier: 1.3 }
        };

        const tireCompounds = {
            'soft': { name: 'Blando', color: 'text-red-400', speed: 18, durability: 20, degradation: 12, icon: '🔴', grip: 95 },
            'medium': { name: 'Medio', color: 'text-yellow-400', speed: 10, durability: 35, degradation: 6, icon: '🟡', grip: 85 },
            'hard': { name: 'Duro', color: 'text-gray-400', speed: 4, durability: 55, degradation: 3, icon: '⚪', grip: 75 },
            'intermediate': { name: 'Intermedio', color: 'text-green-400', speed: 8, durability: 40, degradation: 4, icon: '🟢', wetWeather: true, grip: 90 },
            'wet': { name: 'Lluvia', color: 'text-blue-400', speed: 0, durability: 45, degradation: 2, icon: '🔵', wetWeather: true, grip: 95 }
        };

        const calendar = [
            { name: 'GP de Bahrein', country: 'Bahrein', difficulty: 3, type: 'traditional', rainChance: 0.05, laps: 57 },
            { name: 'GP de Arabia Saudí', country: 'Arabia Saudí', difficulty: 4, type: 'street', rainChance: 0.02, laps: 50 },
            { name: 'GP de España', country: 'España', difficulty: 2, type: 'traditional', rainChance: 0.25, laps: 66 },
            { name: 'GP de Mónaco', country: 'Mónaco', difficulty: 5, type: 'street', rainChance: 0.15, laps: 78 },
            { name: 'GP de Italia', country: 'Italia', difficulty: 3, type: 'oval', rainChance: 0.20, laps: 53 },
            { name: 'GP de Abu Dhabi', country: 'EAU', difficulty: 4, type: 'traditional', rainChance: 0.01, laps: 58 },
            { name: 'GP de Montecarlo', country: 'Montecarlo', difficulty: 5, type: 'mountain', rainChance: 0.30, laps: 44 },
            { name: 'GP de Silverstone', country: 'Reino Unido', difficulty: 4, type: 'traditional', rainChance: 0.40, laps: 52 }
        ];

        // ============ SISTEMA DE DESARROLLO DEL COCHE ============
        const carDevelopment = {
            power: { name: 'Motor', level: 0, maxLevel: 10, cost: 100, improvement: 2 },
            aerodynamics: { name: 'Aerodinámica', level: 0, maxLevel: 10, cost: 120, improvement: 2 },
            reliability: { name: 'Fiabilidad', level: 0, maxLevel: 10, cost: 80, improvement: 2 },
            chassis: { name: 'Chasis', level: 0, maxLevel: 10, cost: 100, improvement: 1.5 }
        };

        // ============ SISTEMA DE ESTRATEGIA DE NEUMÁTICOS ============
        const pitStopStrategy = {
            planned: false,
            targetLap: 0,
            newCompound: 'medium'
        };

        // ============ OFERTAS DE EQUIPOS ============
        function generateTeamOffers(playerReputation, currentTeamId) {
            const offers = [];
            const playerPoints = gameData.player.points;
            const playerWins = gameData.raceResults.filter(r => r.position === 1).length;
            
            // Siempre incluir equipo actual
            const currentTeam = teams[currentTeamId];
            offers.push({
                teamId: currentTeamId,
                team: currentTeam,
                salary: 500000 + (playerPoints * 1000),
                duration: 2,
                isCurrentTeam: true
            });
            
            // Ofertas basadas en rendimiento
            Object.entries(teams).forEach(([teamId, team]) => {
                if (teamId === currentTeamId) return;
                
                const teamTier = team.reputation;
                const playerTier = playerReputation;
                const reputationDiff = teamTier - playerTier;
                
                // Probabilidad de oferta basada en rendimiento
                let offerChance = 0;
                if (playerWins >= 5) offerChance = 0.8;
                else if (playerWins >= 3) offerChance = 0.6;
                else if (playerPoints >= 100) offerChance = 0.4;
                else if (playerPoints >= 50) offerChance = 0.2;
                
                // Ajustar por diferencia de reputación
                if (reputationDiff > 20) offerChance *= 0.3;
                else if (reputationDiff > 10) offerChance *= 0.6;
                else if (reputationDiff < -10) offerChance = 0.9;
                
                if (Math.random() < offerChance) {
                    offers.push({
                        teamId: teamId,
                        team: team,
                        salary: (team.reputation * 10000) + (playerPoints * 800),
                        duration: reputationDiff > 0 ? 1 : 2
                    });
                }
            });
            
            return offers;
        }

        const driverSkills = {
            'Max Verstappen': 98, 'Sergio Pérez': 85, 'Charles Leclerc': 95, 'Carlos Sainz': 88,
            'Lewis Hamilton': 96, 'George Russell': 87, 'Lando Norris': 90, 'Oscar Piastri': 84,
            'Fernando Alonso': 94, 'Lance Stroll': 80, 'Pierre Gasly': 86, 'Esteban Ocon': 83,
            'Alex Albon': 82, 'Logan Sargeant': 75, 'Yuki Tsunoda': 81, 'Nyck de Vries': 78,
            'Valtteri Bottas': 85, 'Zhou Guanyu': 79, 'Kevin Magnussen': 80, 'Nico Hulkenberg': 83
        };

        // Perfiles de IA para cada piloto
        const driverProfiles = {
            'Max Verstappen': { 
                style: 'aggressive', 
                consistency: 0.95, 
                rainBonus: 10, 
                qualifyingBonus: 8,
                circuitPreferences: { traditional: 5, oval: 8, street: 6, mountain: 7 }
            },
            'Sergio Pérez': { 
                style: 'conservative', 
                consistency: 0.85, 
                rainBonus: 5, 
                qualifyingBonus: 3,
                circuitPreferences: { traditional: 6, oval: 6, street: 8, mountain: 5 }
            },
            'Charles Leclerc': { 
                style: 'aggressive', 
                consistency: 0.88, 
                rainBonus: 6, 
                qualifyingBonus: 9,
                circuitPreferences: { traditional: 7, oval: 5, street: 9, mountain: 6 }
            },
            'Carlos Sainz': { 
                style: 'strategist', 
                consistency: 0.92, 
                rainBonus: 7, 
                qualifyingBonus: 5,
                circuitPreferences: { traditional: 7, oval: 6, street: 6, mountain: 7 }
            },
            'Lewis Hamilton': { 
                style: 'strategist', 
                consistency: 0.96, 
                rainBonus: 12, 
                qualifyingBonus: 10,
                circuitPreferences: { traditional: 9, oval: 7, street: 8, mountain: 7 }
            },
            'George Russell': { 
                style: 'aggressive', 
                consistency: 0.87, 
                rainBonus: 6, 
                qualifyingBonus: 7,
                circuitPreferences: { traditional: 7, oval: 6, street: 7, mountain: 6 }
            },
            'Lando Norris': { 
                style: 'aggressive', 
                consistency: 0.86, 
                rainBonus: 5, 
                qualifyingBonus: 6,
                circuitPreferences: { traditional: 7, oval: 7, street: 7, mountain: 6 }
            },
            'Oscar Piastri': { 
                style: 'conservative', 
                consistency: 0.84, 
                rainBonus: 4, 
                qualifyingBonus: 5,
                circuitPreferences: { traditional: 6, oval: 6, street: 6, mountain: 6 }
            },
            'Fernando Alonso': { 
                style: 'strategist', 
                consistency: 0.94, 
                rainBonus: 11, 
                qualifyingBonus: 7,
                circuitPreferences: { traditional: 8, oval: 7, street: 10, mountain: 8 }
            },
            'Lance Stroll': { 
                style: 'conservative', 
                consistency: 0.80, 
                rainBonus: 3, 
                qualifyingBonus: 2,
                circuitPreferences: { traditional: 5, oval: 5, street: 6, mountain: 5 }
            },
            'Pierre Gasly': { 
                style: 'aggressive', 
                consistency: 0.83, 
                rainBonus: 6, 
                qualifyingBonus: 6,
                circuitPreferences: { traditional: 6, oval: 6, street: 7, mountain: 6 }
            },
            'Esteban Ocon': { 
                style: 'conservative', 
                consistency: 0.82, 
                rainBonus: 5, 
                qualifyingBonus: 4,
                circuitPreferences: { traditional: 6, oval: 5, street: 6, mountain: 6 }
            },
            'Alex Albon': { 
                style: 'strategist', 
                consistency: 0.85, 
                rainBonus: 5, 
                qualifyingBonus: 4,
                circuitPreferences: { traditional: 6, oval: 6, street: 7, mountain: 5 }
            },
            'Logan Sargeant': { 
                style: 'conservative', 
                consistency: 0.75, 
                rainBonus: 2, 
                qualifyingBonus: 1,
                circuitPreferences: { traditional: 5, oval: 5, street: 5, mountain: 4 }
            },
            'Yuki Tsunoda': { 
                style: 'aggressive', 
                consistency: 0.78, 
                rainBonus: 4, 
                qualifyingBonus: 5,
                circuitPreferences: { traditional: 6, oval: 6, street: 6, mountain: 5 }
            },
            'Nyck de Vries': { 
                style: 'conservative', 
                consistency: 0.79, 
                rainBonus: 3, 
                qualifyingBonus: 3,
                circuitPreferences: { traditional: 5, oval: 5, street: 6, mountain: 5 }
            },
            'Valtteri Bottas': { 
                style: 'strategist', 
                consistency: 0.90, 
                rainBonus: 7, 
                qualifyingBonus: 6,
                circuitPreferences: { traditional: 7, oval: 6, street: 6, mountain: 6 }
            },
            'Zhou Guanyu': { 
                style: 'conservative', 
                consistency: 0.77, 
                rainBonus: 3, 
                qualifyingBonus: 3,
                circuitPreferences: { traditional: 5, oval: 5, street: 6, mountain: 5 }
            },
            'Kevin Magnussen': { 
                style: 'aggressive', 
                consistency: 0.81, 
                rainBonus: 5, 
                qualifyingBonus: 4,
                circuitPreferences: { traditional: 6, oval: 6, street: 6, mountain: 5 }
            },
            'Nico Hulkenberg': { 
                style: 'strategist', 
                consistency: 0.88, 
                rainBonus: 7, 
                qualifyingBonus: 5,
                circuitPreferences: { traditional: 7, oval: 6, street: 6, mountain: 6 }
            }
        };

        // Forma actual del piloto (varía entre carreras)
        let driverForm = {};

        function initializeDriverForm() {
            Object.keys(driverSkills).forEach(driver => {
                driverForm[driver] = 1.0; // Forma base
            });
        }

        function updateDriverForm() {
            Object.keys(driverSkills).forEach(driver => {
                const profile = driverProfiles[driver] || { consistency: 0.85 };
                // Variación aleatoria basada en consistencia
                const variation = (Math.random() - 0.5) * (1 - profile.consistency) * 0.3;
                driverForm[driver] = Math.max(0.8, Math.min(1.2, 1.0 + variation));
            });
        }

        function calculateAIPerformance(driver, race, weather) {
            const baseSkill = driverSkills[driver] || 75;
            const profile = driverProfiles[driver] || { 
                style: 'conservative', 
                consistency: 0.85,
                rainBonus: 5,
                qualifyingBonus: 5,
                circuitPreferences: { traditional: 5, oval: 5, street: 5, mountain: 5 }
            };
            
            let performance = baseSkill;
            
            // Forma actual
            performance *= driverForm[driver] || 1.0;
            
            // Bonus por circuito preferido
            const circuitType = circuitTypes[race.type];
            const circuitBonus = profile.circuitPreferences[race.type] || 5;
            performance += circuitBonus;
            
            // Bonus por clima
            if (weather === 'rainy') {
                performance += profile.rainBonus;
            }
            
            // Estilo de pilotaje
            if (profile.style === 'aggressive') {
                // Más rápido pero menos consistente
                performance += Math.random() * 10 - 3;
            } else if (profile.style === 'conservative') {
                // Más consistente pero menos picos
                performance += Math.random() * 4;
            } else if (profile.style === 'strategist') {
                // Equilibrado con bonus en carreras largas
                performance += Math.random() * 6 + 2;
            }
            
            // Dificultad
            performance *= difficultyLevels[gameData.difficulty].aiSkillMultiplier;
            
            return performance;
        }

        const pressQuestions = [
            {
                question: "¿Cómo evalúas tu rendimiento en la última carrera?",
                options: [
                    { text: "Estoy satisfecho con mi rendimiento", reputation: 5, skill: null },
                    { text: "Creo que puedo mejorar en las próximas carreras", reputation: 3, skill: 'strategy' },
                    { text: "No fue mi mejor día, pero aprendo de cada error", reputation: 7, skill: 'control' }
                ]
            },
            {
                question: "¿Qué opinas sobre la estrategia del equipo?",
                options: [
                    { text: "Confío plenamente en las decisiones del equipo", reputation: 8, skill: null },
                    { text: "Hay aspectos que podríamos mejorar juntos", reputation: 4, skill: 'strategy' },
                    { text: "Creo que mi experiencia puede aportar nuevas ideas", reputation: 6, skill: 'strategy' }
                ]
            },
            {
                question: "¿Cómo te preparas para las condiciones climáticas adversas?",
                options: [
                    { text: "Entreno específicamente para lluvia y viento", reputation: 5, skill: 'rainMastery' },
                    { text: "La experiencia me ha enseñado a adaptarme", reputation: 6, skill: 'control' },
                    { text: "Cada clima es una oportunidad de demostrar mi valor", reputation: 7, skill: null }
                ]
            },
            {
                question: "¿Cuáles son tus objetivos para esta temporada?",
                options: [
                    { text: "Quiero conseguir mi primer podio", reputation: 5, skill: 'speed' },
                    { text: "Mi meta es ganar el campeonato", reputation: 8, skill: null },
                    { text: "Cada carrera es una oportunidad de crecer", reputation: 6, skill: 'strategy' }
                ]
            }
        ];

        // Lista de países con banderas
        const countries = {
            'España': '🇪🇸',
            'Estados Unidos': '🇺🇸',
            'Reino Unido': '🇬🇧',
            'Alemania': '🇩🇪',
            'Francia': '🇫🇷',
            'Italia': '🇮🇹',
            'Brasil': '🇧🇷',
            'México': '🇲🇽',
            'Argentina': '🇦🇷',
            'Japón': '🇯🇵',
            'China': '🇨🇳',
            'Canadá': '🇨🇦',
            'Australia': '🇦🇺',
            'Países Bajos': '🇳🇱',
            'Bélgica': '🇧🇪',
            'Suiza': '🇨🇭',
            'Austria': '🇦🇹',
            'Mónaco': '🇲🇨',
            'Rusia': '🇷🇺',
            'India': '🇮🇳'
        };

        // ============ SISTEMA DE DIFICULTAD ============
        const difficultyLevels = {
            'beginner': {
                name: 'Principiante',
                icon: '🟢',
                aiSkillMultiplier: 0.85,  // IA 15% más débil
                experienceMultiplier: 1.5, // 50% más XP
                eventProbabilityMultiplier: 0.7, // Menos eventos aleatorios
                description: 'Perfecto para empezar. IA más débil y más recompensas.'
            },
            'normal': {
                name: 'Normal',
                icon: '🟡',
                aiSkillMultiplier: 1.0,   // IA normal
                experienceMultiplier: 1.0, // XP normal
                eventProbabilityMultiplier: 1.0, // Eventos normales
                description: 'Experiencia equilibrada. Recomendado para la mayoría.'
            },
            'hard': {
                name: 'Difícil',
                icon: '🟠',
                aiSkillMultiplier: 1.15,  // IA 15% más fuerte
                experienceMultiplier: 0.8, // 20% menos XP
                eventProbabilityMultiplier: 1.3, // Más eventos aleatorios
                description: 'Desafío real. IA competitiva y menos recompensas.'
            },
            'legend': {
                name: 'Leyenda',
                icon: '🔴',
                aiSkillMultiplier: 1.30,  // IA 30% más fuerte
                experienceMultiplier: 0.6, // 40% menos XP
                eventProbabilityMultiplier: 1.5, // Muchos eventos aleatorios
                description: 'Solo para maestros. La IA no da tregua.'
            }
        };

        function goToMainMenu() {
            if (confirm('¿Volver al menú principal? Tu progreso se guardará automáticamente.')) {
                saveGame();
                stopMusic();
                gameData.state = 'main-menu';
                closeModal();
                render();
            }
        }

        // ============ SISTEMA DE AUDIO ============
        let audioContext = null;
        let currentMusic = null;
        let audioSettings = {
            musicEnabled: true,
            sfxEnabled: true,
            musicVolume: 0.3,
            sfxVolume: 0.5
        };

        function initAudio() {
            // Ya no necesitamos AudioContext para la música
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Efectos de sonido sintéticos
        function playSound(type) {
            if (!audioSettings.sfxEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            gainNode.gain.value = audioSettings.sfxVolume;
            
            switch(type) {
                case 'click':
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    gainNode.gain.exponentialRampToValueAtTime(0.05, audioContext.currentTime + 0.1);
                    break;
                case 'success':
                    oscillator.frequency.value = 600;
                    oscillator.type = 'sine';
                    setTimeout(() => {
                        oscillator.frequency.value = 800;
                    }, 50);
                    gainNode.gain.exponentialRampToValueAtTime(0.05, audioContext.currentTime + 0.2);
                    break;
                case 'win':
                    oscillator.frequency.value = 523.25; // C
                    oscillator.type = 'triangle';
                    setTimeout(() => { oscillator.frequency.value = 659.25; }, 100); // E
                    setTimeout(() => { oscillator.frequency.value = 783.99; }, 200); // G
                    gainNode.gain.exponentialRampToValueAtTime(0.05, audioContext.currentTime + 0.4);
                    break;
                case 'error':
                    oscillator.frequency.value = 200;
                    oscillator.type = 'sawtooth';
                    gainNode.gain.exponentialRampToValueAtTime(0.05, audioContext.currentTime + 0.15);
                    break;
                case 'notification':
                    oscillator.frequency.value = 1000;
                    oscillator.type = 'sine';
                    gainNode.gain.exponentialRampToValueAtTime(0.05, audioContext.currentTime + 0.1);
                    break;
            }
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function updateMusicVolume(value) {
            audioSettings.musicVolume = value / 100;
            if (audioElement) {
                audioElement.volume = audioSettings.musicVolume;
            }
            localStorage.setItem('audioSettings', JSON.stringify(audioSettings));
        }

        function updateSFXVolume(value) {
            audioSettings.sfxVolume = value / 100;
            localStorage.setItem('audioSettings', JSON.stringify(audioSettings));
            // Reproducir sonido de prueba
            playSound('click');
        }        

        // Sistema de partículas
        function createParticlesContainer() {
            let container = document.getElementById('particles-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'particles-container';
                container.className = 'particles-container';
                document.body.appendChild(container);
            }
            return container;
        }

        function clearParticles() {
            const container = document.getElementById('particles-container');
            if (container) {
                container.innerHTML = '';
            }
        }

        // Efecto de humo y velocidad mejorado (inicio de partida)
        function createSmokeEffect() {
            const container = createParticlesContainer();
            const numSmoke = 30;
            const numLines = 15;
            
            // Líneas de velocidad
            for (let i = 0; i < numLines; i++) {
                setTimeout(() => {
                    const line = document.createElement('div');
                    line.className = 'particle speed-line';
                    line.style.top = (Math.random() * window.innerHeight) + 'px';
                    line.style.left = window.innerWidth + 'px';
                    line.style.animationDelay = Math.random() * 0.3 + 's';
                    container.appendChild(line);
                    setTimeout(() => line.remove(), 1000);
                }, i * 50);
            }
            
            // Humo denso
            for (let i = 0; i < numSmoke; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'particle smoke-particle' + (Math.random() > 0.5 ? ' dark' : '');
                    
                    const startX = Math.random() * window.innerWidth;
                    const startY = window.innerHeight - 50;
                    const drift = (Math.random() - 0.5) * 200;
                    
                    particle.style.left = startX + 'px';
                    particle.style.top = startY + 'px';
                    particle.style.setProperty('--drift', drift + 'px');
                    particle.style.animationDelay = Math.random() * 0.5 + 's';
                    
                    container.appendChild(particle);
                    setTimeout(() => particle.remove(), 3000);
                }, i * 80);
            }
            
            setTimeout(clearParticles, 4000);
        }

        // Efecto de confeti mejorado (podio)
        function createConfettiEffect() {
            const container = createParticlesContainer();
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', 
                            '#98D8C8', '#F7DC6F', '#E74C3C', '#3498DB', '#2ECC71'];
            const numParticles = 150;
            
            // Texto celebratorio
            const text = document.createElement('div');
            text.className = 'celebration-text';
            text.textContent = '¡PODIO!';
            container.appendChild(text);
            setTimeout(() => text.remove(), 2000);
            
            // Confeti con formas variadas
            for (let i = 0; i < numParticles; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    const shapes = ['', 'rect', 'circle'];
                    const shape = shapes[Math.floor(Math.random() * shapes.length)];
                    particle.className = 'particle confetti-particle ' + shape;
                    
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    particle.style.backgroundColor = color;
                    particle.style.left = Math.random() * window.innerWidth + 'px';
                    particle.style.top = '-30px';
                    
                    const drift = (Math.random() - 0.5) * 300;
                    const rotation = Math.random() * 1440 - 720;
                    
                    particle.style.setProperty('--drift', drift + 'px');
                    particle.style.setProperty('--rotation', rotation + 'deg');
                    particle.style.animationDelay = Math.random() * 0.5 + 's';
                    particle.style.animationDuration = (Math.random() * 2 + 3) + 's';
                    
                    container.appendChild(particle);
                    setTimeout(() => particle.remove(), 7000);
                }, i * 20);
            }
            
            setTimeout(clearParticles, 8000);
        }

        // Efecto de pole position mejorado
        function createSparkEffect() {
            const container = createParticlesContainer();
            const numStars = 80;
            const numWaves = 3;
            
            // Flash dorado
            const flash = document.createElement('div');
            flash.className = 'pole-flash';
            container.appendChild(flash);
            setTimeout(() => flash.remove(), 800);
            
            // Texto celebratorio
            const text = document.createElement('div');
            text.className = 'celebration-text';
            text.textContent = 'POLE POSITION!';
            text.style.fontSize = '3rem';
            container.appendChild(text);
            setTimeout(() => text.remove(), 2000);
            
            // Ondas de choque
            for (let w = 0; w < numWaves; w++) {
                setTimeout(() => {
                    const wave = document.createElement('div');
                    wave.className = 'shockwave';
                    wave.style.left = (window.innerWidth / 2 - 25) + 'px';
                    wave.style.top = (window.innerHeight / 2 - 25) + 'px';
                    container.appendChild(wave);
                    setTimeout(() => wave.remove(), 1000);
                }, w * 300);
            }
            
            // Estrellas doradas
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            
            for (let i = 0; i < numStars; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'particle star-particle';
                    
                    const angle = (Math.PI * 2 * i) / numStars;
                    const distance = Math.random() * 250 + 150;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance;
                    const rotation = Math.random() * 360;
                    
                    particle.style.left = centerX + 'px';
                    particle.style.top = centerY + 'px';
                    particle.style.setProperty('--tx', tx + 'px');
                    particle.style.setProperty('--ty', ty + 'px');
                    particle.style.setProperty('--rotation', rotation + 'deg');
                    particle.style.animationDelay = Math.random() * 0.3 + 's';
                    
                    container.appendChild(particle);
                    setTimeout(() => particle.remove(), 1500);
                }, i * 15);
            }
            
            setTimeout(clearParticles, 3000);
        }

        // Sonido de motor F1 más realista
        function playF1EngineSound() {
            if (!gameData.soundEnabled) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const duration = 3;
                
                // Capa 1: Motor grave (efecto Doppler)
                const osc1 = audioContext.createOscillator();
                const gain1 = audioContext.createGain();
                osc1.connect(gain1);
                gain1.connect(audioContext.destination);
                
                osc1.frequency.setValueAtTime(60, audioContext.currentTime);
                osc1.frequency.exponentialRampToValueAtTime(500, audioContext.currentTime + 1);
                osc1.frequency.exponentialRampToValueAtTime(150, audioContext.currentTime + duration);
                gain1.gain.setValueAtTime(0.2, audioContext.currentTime);
                gain1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                // Capa 2: Motor agudo
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                
                osc2.frequency.setValueAtTime(120, audioContext.currentTime);
                osc2.frequency.exponentialRampToValueAtTime(1000, audioContext.currentTime + 1);
                osc2.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + duration);
                gain2.gain.setValueAtTime(0.15, audioContext.currentTime);
                gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                // Capa 3: Distorsión armónica
                const osc3 = audioContext.createOscillator();
                const gain3 = audioContext.createGain();
                osc3.type = 'sawtooth';
                osc3.connect(gain3);
                gain3.connect(audioContext.destination);
                
                osc3.frequency.setValueAtTime(240, audioContext.currentTime);
                osc3.frequency.exponentialRampToValueAtTime(2000, audioContext.currentTime + 1);
                osc3.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + duration);
                gain3.gain.setValueAtTime(0.08, audioContext.currentTime);
                gain3.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                osc1.start();
                osc2.start();
                osc3.start();
                osc1.stop(audioContext.currentTime + duration);
                osc2.stop(audioContext.currentTime + duration);
                osc3.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Audio no disponible');
            }
        }

        function addNewsItem(message, type = 'info') {
            // Evitar noticias duplicadas recientes
            const isDuplicate = newsItems.some(item => 
                item.message === message && 
                (Date.now() - item.timestamp) < 5000
            );
            
            if (isDuplicate) return;
            
            const newsItem = {
                id: Date.now(),
                message,
                type,
                timestamp: Date.now()
            };
            newsItems.unshift(newsItem);
            
            // Mantener solo las últimas 10 noticias
            if (newsItems.length > 10) {
                newsItems = newsItems.slice(0, 10);
            }
            
            // Solo sonido para noticias importantes
            if (type === 'victory' || type === 'podium' || type === 'good') {
                playSound('notification');
            }
            
            updateNewsBar();
        }

        function updateNewsBar() {
            const newsBar = document.getElementById('news-bar');
            if (!newsBar || newsItems.length === 0) return;
            
            const currentNews = newsItems[0];
            const typeColors = {
                'victory': 'text-yellow-400',
                'podium': 'text-orange-400', 
                'good': 'text-green-400',
                'bad': 'text-red-400',
                'info': 'text-blue-400',
                'qualifying': 'text-purple-400',
                'training': 'text-cyan-400'
            };
            
            newsBar.innerHTML = `
                <div class="news-ticker">
                    <span class="${typeColors[currentNews.type] || 'text-white'}">
                        🏎️ ${currentNews.message}
                    </span>
                </div>
            `;
            
            // Limpiar intervalo anterior si existe
            if (newsRotationInterval) {
                clearInterval(newsRotationInterval);
            }
            
            // Rotar noticias cada 20 segundos
            if (newsItems.length > 1) {
                newsRotationInterval = setInterval(() => {
                    if (newsItems.length > 1) {
                        newsItems.push(newsItems.shift());
                        updateNewsBar();
                    }
                }, 20000);
            }
        }

        // Variable para el elemento de audio
        let audioElement = null;

        function startMusic() {
            if (!audioSettings.musicEnabled || audioElement) return;
            
            audioElement = new Audio();
            
            // OPCIÓN 1: Archivo MP3 en la misma carpeta que tu HTML
            audioElement.src = 'musica.mp3';
            
            // OPCIÓN 2: Archivo en una subcarpeta
            // audioElement.src = 'audio/tu-musica.mp3';
            
            // OPCIÓN 3: URL externa
            // audioElement.src = 'https://ejemplo.com/musica.mp3';
            
            audioElement.loop = true; // Repetir en bucle
            audioElement.volume = audioSettings.musicVolume;
            
            audioElement.play().catch(error => {
                console.log('No se pudo reproducir el audio:', error);
            });
        }

        function stopMusic() {
            if (audioElement) {
                audioElement.pause();
                audioElement.currentTime = 0;
                audioElement = null;
            }
        }

        function toggleMusic() {
            audioSettings.musicEnabled = !audioSettings.musicEnabled;
            if (audioSettings.musicEnabled) {
                startMusic();
            } else {
                stopMusic();
            }
            localStorage.setItem('audioSettings', JSON.stringify(audioSettings));
            playSound('click');
            render();
        }

        function toggleSFX() {
            audioSettings.sfxEnabled = !audioSettings.sfxEnabled;
            localStorage.setItem('audioSettings', JSON.stringify(audioSettings));
            playSound('click');
            render();
        }

        // Cargar configuración de audio
        function loadAudioSettings() {
            const saved = localStorage.getItem('audioSettings');
            if (saved) {
                audioSettings = JSON.parse(saved);
            }
        }

        // ============ SISTEMA DE TEMAS ============
        const themes = {
            'normal': {
                name: 'Clásico F1',
                icon: '🏎️',
                description: 'El look tradicional de Fórmula 1'
            },
            'sporty': {
                name: 'Deportivo',
                icon: '🏁',
                description: 'Diseño agresivo y de alto contraste'
            },
            'retro': {
                name: 'Retro',
                icon: '🕹️',
                description: 'Colores cálidos vintage de los 80s'
            }
        };

        let currentTheme = 'normal';

        function changeTheme(themeName) {
            if (!themes[themeName]) return;
            
            currentTheme = themeName;
            document.body.setAttribute('data-theme', themeName);
            localStorage.setItem('f1Theme', themeName);
            playSound('click');
            showNotification(`Tema cambiado a ${themes[themeName].name}`, 'success');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('f1Theme');
            if (savedTheme && themes[savedTheme]) {
                currentTheme = savedTheme;
                document.body.setAttribute('data-theme', savedTheme);
            }
        }

        function showThemeSelector() {
            document.getElementById('themeSelectorContent').innerHTML = `
                <div class="space-y-4">
                    <p class="text-gray-400 text-sm">Personaliza la apariencia del simulador</p>
                    <div class="grid grid-cols-1 gap-3">
                        ${Object.entries(themes).map(([key, theme]) => `
                            <button 
                                onclick="changeTheme('${key}'); closeModal();"
                                class="p-4 rounded-lg text-left transition-all ${currentTheme === key ? 'bg-gradient-to-r from-red-900 to-red-800 border-2 border-red-500' : 'bg-gray-800 hover:bg-gray-700 border-2 border-transparent'}"
                            >
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">${theme.icon}</span>
                                    <div class="flex-1">
                                        <div class="font-bold text-lg">${theme.name}</div>
                                        <div class="text-sm text-gray-400">${theme.description}</div>
                                    </div>
                                    ${currentTheme === key ? '<span class="text-green-400 text-xl">✓</span>' : ''}
                                </div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('themeSelectorModal').classList.add('show');
        }

        function showAudioSettings() {
            const musicVol = Math.round(audioSettings.musicVolume * 100);
            const sfxVol = Math.round(audioSettings.sfxVolume * 100);
            
            document.getElementById('audioSettingsContent').innerHTML = `
                <div class="space-y-6">
                    <p class="text-gray-400 text-sm">Personaliza la experiencia de audio del simulador</p>
                    
                    <!-- Control de Música -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-bold text-yellow-400">Música de Fondo</h3>
                            <button 
                                onclick="toggleMusic(); showAudioSettings();" 
                                class="px-4 py-2 rounded font-semibold ${audioSettings.musicEnabled ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}"
                            >
                                ${audioSettings.musicEnabled ? 'Activada' : 'Desactivada'}
                            </button>
                        </div>
                        
                        <div class="mb-2">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm text-gray-400">Volumen</label>
                                <span id="music-volume-display" class="text-sm text-yellow-400 font-bold">${musicVol}%</span>
                            </div>
                            <input 
                                type="range" 
                                min="0" 
                                max="100" 
                                value="${musicVol}"
                                onchange="updateMusicVolume(this.value); document.getElementById('music-volume-display').textContent = this.value + '%';"
                                oninput="document.getElementById('music-volume-display').textContent = this.value + '%';"
                                ${!audioSettings.musicEnabled ? 'disabled' : ''}
                                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                style="accent-color: #dc2626;"
                            />
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            ${audioSettings.musicEnabled ? 'La música de fondo está sonando' : 'Activa la música para cambiar el volumen'}
                        </p>
                    </div>

                    <!-- Control de Efectos de Sonido -->
                    <div class="bg-gray-800 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-bold text-blue-400">Efectos de Sonido</h3>
                            <button 
                                onclick="toggleSFX(); showAudioSettings();" 
                                class="px-4 py-2 rounded font-semibold ${audioSettings.sfxEnabled ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-700'}"
                            >
                                ${audioSettings.sfxEnabled ? 'Activados' : 'Desactivados'}
                            </button>
                        </div>
                        
                        <div class="mb-2">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm text-gray-400">Volumen</label>
                                <span id="sfx-volume-display" class="text-sm text-blue-400 font-bold">${sfxVol}%</span>
                            </div>
                            <input 
                                type="range" 
                                min="0" 
                                max="100" 
                                value="${sfxVol}"
                                onchange="updateSFXVolume(this.value); document.getElementById('sfx-volume-display').textContent = this.value + '%';"
                                oninput="document.getElementById('sfx-volume-display').textContent = this.value + '%';"
                                ${!audioSettings.sfxEnabled ? 'disabled' : ''}
                                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                style="accent-color: #dc2626;"
                            />
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            ${audioSettings.sfxEnabled ? 'Los efectos suenan en clicks, victorias y eventos' : 'Activa los efectos para cambiar el volumen'}
                        </p>
                    </div>

                    <div class="text-center text-xs text-gray-500">
                        Los cambios se guardan automáticamente
                    </div>
                </div>
            `;
            document.getElementById('audioSettingsModal').classList.add('show');
        }        

        // ============ SISTEMA DE DAÑOS PROGRESIVOS ============
        const damageTypes = {
            'front-wing': {
                name: 'Alerón Delantero',
                icon: '🔧',
                maxDamage: 100,
                repairTime: 8,
                effects: {
                    aerodynamics: -0.3,  // Pierde 30% por cada punto de daño
                    speed: -0.2
                }
            },
            'rear-wing': {
                name: 'Alerón Trasero',
                icon: '⚙️',
                maxDamage: 100,
                repairTime: 10,
                effects: {
                    aerodynamics: -0.4,
                    control: -0.2
                }
            },
            'engine': {
                name: 'Motor',
                icon: '🔥',
                maxDamage: 100,
                repairTime: 15,
                effects: {
                    power: -0.5,
                    speed: -0.3
                }
            },
            'suspension': {
                name: 'Suspensión',
                icon: '🔩',
                maxDamage: 100,
                repairTime: 12,
                effects: {
                    control: -0.4,
                    chassis: -0.3
                }
            }
        };

        function generateDamage() {
            const damageChance = 0.15 * difficultyLevels[gameData.difficulty].eventProbabilityMultiplier;
            
            if (Math.random() < damageChance) {
                const damageTypes = ['front-wing', 'rear-wing', 'engine', 'suspension'];
                const damageType = damageTypes[Math.floor(Math.random() * damageTypes.length)];
                const severity = Math.floor(Math.random() * 40) + 15; // 15-55 puntos de daño
                
                return {
                    type: damageType,
                    severity: severity,
                    lap: Math.floor(Math.random() * 25) + 5 // Entre vuelta 5-30
                };
            }
            
            return null;
        }

        function calculateDamageEffect(damage, baseStats) {
            if (!damage || damage.severity === 0) return baseStats;
            
            const damageInfo = damageTypes[damage.type];
            const modifiedStats = { ...baseStats };
            
            Object.entries(damageInfo.effects).forEach(([stat, multiplier]) => {
                const reduction = (damage.severity / 100) * Math.abs(multiplier) * 100;
                modifiedStats[stat] = Math.max(0, (modifiedStats[stat] || 0) - reduction);
            });
            
            return modifiedStats;
        }

        // ============ SISTEMA DE LOGROS ============
        const achievements = {
            'first-win': { 
                name: 'Primera Victoria', 
                description: 'Gana tu primera carrera', 
                icon: '🏆', 
                unlocked: false,
                check: (data) => data.raceResults.some(r => r.position === 1)
            },
            'first-pole': { 
                name: 'Primera Pole', 
                description: 'Consigue tu primera pole position', 
                icon: '🥇', 
                unlocked: false,
                check: (data) => data.raceResults.some(r => r.qualifyingPos === 1)
            },
            'podium-streak': { 
                name: 'Racha de Podios', 
                description: 'Termina en el podio 3 carreras consecutivas', 
                icon: '🔥', 
                unlocked: false,
                check: (data) => {
                    let streak = 0;
                    for (let i = data.raceResults.length - 1; i >= 0; i--) {
                        if (data.raceResults[i].position <= 3) {
                            streak++;
                            if (streak >= 3) return true;
                        } else {
                            streak = 0;
                        }
                    }
                    return false;
                }
            },
            'win-streak': { 
                name: 'Imparable', 
                description: 'Gana 3 carreras consecutivas', 
                icon: '⚡', 
                unlocked: false,
                check: (data) => {
                    let streak = 0;
                    for (let i = data.raceResults.length - 1; i >= 0; i--) {
                        if (data.raceResults[i].position === 1) {
                            streak++;
                            if (streak >= 3) return true;
                        } else {
                            streak = 0;
                        }
                    }
                    return false;
                }
            },
            'rain-master': { 
                name: 'Maestro de la Lluvia', 
                description: 'Gana una carrera bajo lluvia', 
                icon: '🌧️', 
                unlocked: false,
                check: (data) => data.raceResults.some(r => r.position === 1 && r.weather === 'rainy')
            },
            'monaco-winner': { 
                name: 'Rey de Mónaco', 
                description: 'Gana en Mónaco', 
                icon: '👑', 
                unlocked: false,
                check: (data) => data.raceResults.some(r => r.position === 1 && r.race === 'GP de Mónaco')
            },
            'comeback-king': { 
                name: 'Rey de las Remontadas', 
                description: 'Gana una carrera saliendo desde P10 o peor', 
                icon: '🚀', 
                unlocked: false,
                check: (data) => data.raceResults.some(r => r.position === 1 && r.qualifyingPos >= 10)
            },
            'perfect-weekend': { 
                name: 'Fin de Semana Perfecto', 
                description: 'Pole position y victoria en la misma carrera', 
                icon: '💎', 
                unlocked: false,
                check: (data) => data.raceResults.some(r => r.position === 1 && r.qualifyingPos === 1)
            },
            'champion': { 
                name: 'Campeón del Mundo', 
                description: 'Gana un campeonato', 
                icon: '🏅', 
                unlocked: false,
                check: (data) => data.player.championships >= 1
            },
            'points-master': { 
                name: 'Acumulador de Puntos', 
                description: 'Consigue 200 puntos en una temporada', 
                icon: '💯', 
                unlocked: false,
                check: (data) => {
                    const seasonPoints = data.raceResults.reduce((sum, r) => sum + r.points, 0);
                    return seasonPoints >= 200;
                }
            },
            'development-guru': { 
                name: 'Gurú del Desarrollo', 
                description: 'Maximiza todas las mejoras del coche', 
                icon: '🔧', 
                unlocked: false,
                check: (data) => {
                    return Object.values(data.carUpgrades).every(level => level >= 10);
                }
            },
            'teammate-crusher': { 
                name: 'Dominio Total', 
                description: 'Vence a tu compañero en 7 de 8 carreras', 
                icon: '💪', 
                unlocked: false,
                check: (data) => {
                    if (!teammateComparison) return false;
                    return teammateComparison.raceBattles.player >= 7;
                }
            }
        };

        // ============ SISTEMA DE CLIMA DINÁMICO ============
        let weatherChangeEvent = null;

        // Sistema de daños progresivos
        const damageEvent = generateDamage();
        if (damageEvent) {
            gameData.currentDamage = damageEvent;
        }

        // ============ SISTEMA DE ALERTAS METEOROLÓGICAS ============
        function checkWeatherWarnings(currentLap, totalLaps) {
            if (!gameData.weatherWarnings) gameData.weatherWarnings = [];
            
            const race = calendar[gameData.currentRace];
            const midRaceStart = Math.floor(totalLaps * 0.3);
            const midRaceEnd = Math.floor(totalLaps * 0.7);
            
            // Probabilidad de cambio meteorológico
            if (currentLap >= midRaceStart && currentLap <= midRaceEnd && gameData.weatherWarnings.length === 0) {
                if (Math.random() < race.rainChance * 1.5) {
                    const possibleWeathers = Object.keys(weatherConditions).filter(w => w !== gameData.currentWeather);
                    const newWeather = possibleWeathers[Math.floor(Math.random() * possibleWeathers.length)];
                    const warningLap = currentLap + Math.floor(Math.random() * 5) + 3; // Entre 3-7 vueltas
                    
                    gameData.weatherWarnings.push({
                        warningLap: currentLap,
                        changeLap: warningLap,
                        from: gameData.currentWeather,
                        to: newWeather,
                        acknowledged: false
                    });
                    
                    return {
                        warning: true,
                        message: `⚠️ Alerta meteorológica: ${weatherConditions[newWeather].name} esperado en ${warningLap - currentLap} vueltas`,
                        newWeather: newWeather,
                        lapsUntilChange: warningLap - currentLap
                    };
                }
            }
            
            return null;
        }

        function applyWeatherChange(lap) {
            if (!gameData.weatherWarnings || gameData.weatherWarnings.length === 0) return null;
            
            const warning = gameData.weatherWarnings.find(w => w.changeLap === lap);
            if (warning) {
                gameData.currentWeather = warning.to;
                return {
                    changed: true,
                    message: `🌦️ Cambio climático: Ahora ${weatherConditions[warning.to].name} ${weatherConditions[warning.to].icon}`,
                    weather: warning.to
                };
            }
            
            return null;
        }

        function simulateWeatherChange(currentWeather, lap, totalLaps) {
            // Probabilidad de cambio aumenta en carreras largas
            const changeProbability = 0.15;
            const midRaceWindow = lap >= totalLaps * 0.3 && lap <= totalLaps * 0.7;
            
            if (midRaceWindow && Math.random() < changeProbability && !weatherChangeEvent) {
                const possibleWeathers = Object.keys(weatherConditions).filter(w => w !== currentWeather);
                const newWeather = possibleWeathers[Math.floor(Math.random() * possibleWeathers.length)];
                
                weatherChangeEvent = {
                    lap: lap,
                    from: currentWeather,
                    to: newWeather,
                    warning: lap - 2 // Avisar 2 vueltas antes
                };
                
                return weatherChangeEvent;
            }
            
            return null;
        }        

        // ============ VALIDACIÓN DE DATOS ============
        function validateGameData(data) {
            const defaultData = {
                state: 'main-menu',
                player: {
                    name: '',
                    age: 20,
                    nationality: '',
                    experience: 0,
                    championships: 0,
                    reputation: 50,
                    points: 0,
                    skills: {
                        speed: 50,
                        control: 50,
                        strategy: 50,
                        overtaking: 50,
                        streetSpecialist: 50,
                        ovalSpecialist: 50,
                        mountainSpecialist: 50,
                        rainMastery: 50
                    }
                },
                selectedTeam: null,
                currentRace: 0,
                racePhase: 'practice',
                trainingDone: false,
                qualifyingPos: null,
                raceResults: [],
                raceClassification: [],
                raceTimes: [],
                isProcessing: false,
                selectedTireCompound: 'medium',
                pitStops: 0,
                tireWear: 0,
                currentWeather: 'sunny',
                driverStandings: {},
                devBudget: 500,
                carUpgrades: { power: 0, aerodynamics: 0, reliability: 0, chassis: 0 },
                pitStopPlanned: false,
                pitStopLap: 0,
                pitStopNewTire: 'medium',
                currentLap: 0,
                totalLaps: 0,
                achievements: {},
                newAchievements: [],
                difficulty: 'normal',
                activeTab: 'info',
                currentDamage: null,
                damageRepaired: false,
                seasonsHistory: [],
                pressEvents: [],
                teamOffers: [],
                raceEvents: [],
                weatherWarnings: [] // NUEVO
            };

            // Crear copia profunda
            const validated = JSON.parse(JSON.stringify(defaultData));
            
            // Copiar datos existentes
            Object.keys(data).forEach(key => {
                if (data[key] !== undefined && data[key] !== null) {
                    if (typeof data[key] === 'object' && !Array.isArray(data[key])) {
                        validated[key] = { ...defaultData[key], ...data[key] };
                    } else {
                        validated[key] = data[key];
                    }
                }
            });
            
            // Validar rangos
            validated.player.experience = Math.max(0, validated.player.experience);
            validated.player.reputation = Math.max(0, Math.min(100, validated.player.reputation));
            validated.player.points = Math.max(0, validated.player.points);
            validated.currentRace = Math.max(0, Math.min(calendar.length, validated.currentRace));
            validated.devBudget = Math.max(0, validated.devBudget);
            
            // Validar habilidades
            Object.keys(validated.player.skills).forEach(skill => {
                validated.player.skills[skill] = Math.max(0, Math.min(100, validated.player.skills[skill]));
            });
            
            // Validar mejoras del coche
            Object.keys(validated.carUpgrades).forEach(upgrade => {
                validated.carUpgrades[upgrade] = Math.max(0, Math.min(10, validated.carUpgrades[upgrade]));
            });
            
            // Validar dificultad
            if (!difficultyLevels[validated.difficulty]) {
                validated.difficulty = 'normal';
            }
            
            return validated;
        }

        // ============ SISTEMA DE GUARDADO ============
        function saveGame() {
            try {
                const validatedData = validateGameData(gameData);
                const saveData = {
                    gameData: validatedData,
                    teammateComparison: teammateComparison,
                    timestamp: new Date().toISOString(),
                    version: '1.1.0'
                };
                localStorage.setItem('f1SimulatorSave', JSON.stringify(saveData));
                showNotification('Partida guardada correctamente', 'success', false); // <-- false = sin sonido
                return true;
            } catch (error) {
                console.error('Error al guardar:', error);
                showNotification('Error al guardar la partida', 'error', false); // <-- false = sin sonido
                return false;
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('f1SimulatorSave');
                if (!saved) return false;
                
                const saveData = JSON.parse(saved);
                
                // Validar y cargar gameData
                if (saveData.gameData) {
                    gameData = validateGameData(saveData.gameData);
                }
                
                // Cargar teammateComparison
                if (saveData.teammateComparison) {
                    teammateComparison = saveData.teammateComparison;
                }
                
                showNotification('Partida cargada correctamente', 'success');
                return true;
                
            } catch (error) {
                console.error('Error al cargar:', error);
                showNotification('Archivo guardado corrupto - iniciando partida nueva', 'error');
                return false;
            }
        }

        function deleteSave() {
            if (confirm('¿Estás seguro de que quieres borrar tu progreso guardado?')) {
                localStorage.removeItem('f1SimulatorSave');
                showNotification('Progreso eliminado', 'info');
                return true;
            }
            return false;
        }

        function hasSavedGame() {
            return localStorage.getItem('f1SimulatorSave') !== null;
        }

        function showNotification(message, type = 'info', playAudio = true) {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
            notification.style.maxWidth = '90%';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            if (playAudio) {
                playSound('notification');
            }
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }        

        // ============ FINAL DE TEMPORADA ============
        function checkSeasonEnd() {
            return gameData.currentRace >= calendar.length;
        }

        function calculateFinalStandings() {
            const standings = [];
            
            Object.entries(gameData.driverStandings).forEach(([driver, data]) => {
                standings.push({
                    name: driver,
                    points: data.points,
                    wins: data.wins,
                    podiums: data.podiums,
                    team: data.team,
                    isPlayer: driver === gameData.player.name
                });
            });
            
            standings.sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.wins !== a.wins) return b.wins - a.wins;
                return b.podiums - a.podiums;
            });
            
            return standings;
        }

        function endSeason() {
            const finalStandings = calculateFinalStandings();
            const playerPosition = finalStandings.findIndex(d => d.isPlayer) + 1;
            
            if (playerPosition === 1) {
                gameData.player.championships++;
            }
                        
            // Guardar temporada en historial
            const seasonStats = {
                seasonNumber: gameData.seasonsHistory.length + 1,
                year: 2025 + gameData.seasonsHistory.length,
                team: gameData.selectedTeam,
                teamName: teams[gameData.selectedTeam].name,
                finalPosition: playerPosition,
                totalPoints: gameData.player.points,
                wins: gameData.raceResults.filter(r => r.position === 1).length,
                podiums: gameData.raceResults.filter(r => r.position <= 3).length,
                poles: gameData.raceResults.filter(r => r.qualifyingPos === 1).length,
                races: gameData.raceResults.length,
                bestFinish: Math.min(...gameData.raceResults.map(r => r.position)),
                worstFinish: Math.max(...gameData.raceResults.map(r => r.position)),
                avgFinish: (gameData.raceResults.reduce((sum, r) => sum + r.position, 0) / gameData.raceResults.length).toFixed(1),
                champion: playerPosition === 1,
                raceResults: [...gameData.raceResults],
                difficulty: gameData.difficulty,
                completedAt: new Date().toISOString()
            };

            gameData.seasonsHistory.push(seasonStats);

            gameData.state = 'season-end';
            gameData.finalStandings = finalStandings;
            gameData.seasonPlayerPosition = playerPosition;
            
            saveGame();
            render();
        }

        function startNewSeason() {
            gameData.currentRace = 0;
            gameData.racePhase = 'practice';
            gameData.raceResults = [];
            gameData.raceClassification = [];
            gameData.raceTimes = [];
            initializeDriverStandings();
            gameData.driverStandings[gameData.player.name] = { 
                points: 0, 
                team: gameData.selectedTeam, 
                wins: 0, 
                podiums: 0 
            };
            teammateComparison = {
                qualifyingBattles: { player: 0, teammate: 0 },
                raceBattles: { player: 0, teammate: 0 },
                pointsGap: 0
            };
            gameData.currentWeather = generateWeather();
            // Mostrar ofertas de equipos
            gameData.state = 'team-offers';
            render();
        }

        function acceptTeamOffer(teamId) {
            if (teamId !== gameData.selectedTeam) {
                // Cambiar de equipo, resetear mejoras del coche
                gameData.carUpgrades = { power: 0, aerodynamics: 0, reliability: 0, chassis: 0 };
                gameData.devBudget = 500;
                teams[gameData.selectedTeam].drivers[1] = 'Driver'; // Reemplazar jugador en equipo anterior
            }
            
            gameData.selectedTeam = teamId;
            teams[teamId].drivers[1] = gameData.player.name;
            
            // Ajustar reputación basada en el equipo
            const teamRep = teams[teamId].reputation;
            gameData.player.reputation = Math.min(100, Math.max(gameData.player.reputation, teamRep - 10));
            
            startNewSeason();
        }

        function toggleSound() {
            gameData.soundEnabled = !gameData.soundEnabled;
            if (gameData.soundEnabled) {
                playSound('click');
            }
            render();
        }

        // AÑADIR AQUÍ:
        function getLapsForCircuit(type) {
            const laps = {
                'street': 61,
                'oval': 53,
                'mountain': 44,
                'traditional': 58
            };
            return laps[type] || 58;
        }

        function updateReputation(change) {
            gameData.player.reputation = Math.max(0, Math.min(100, gameData.player.reputation + change));
        }

        function getReputationLevel() {
            if (gameData.player.reputation >= 80) return { level: 'Leyenda', color: 'text-yellow-400' };
            if (gameData.player.reputation >= 60) return { level: 'Estrella', color: 'text-blue-400' };
            if (gameData.player.reputation >= 40) return { level: 'Prometedor', color: 'text-green-400' };
            if (gameData.player.reputation >= 20) return { level: 'Novato', color: 'text-gray-400' };
            return { level: 'Desconocido', color: 'text-red-400' };
        }

        function getLevel() {
            return Math.floor(gameData.player.experience / 100) + 1;
        }

        function getAvailablePoints() {
            const earned = Math.floor(gameData.player.experience / 50);
            const used = Object.values(gameData.player.skills).reduce((sum, skill) => sum + (skill - 50), 0);
            return Math.max(0, earned - used);
        }

        function getPointsForPosition(pos) {
            const points = [25, 18, 15, 12, 10, 8, 6, 4, 2, 1];
            return pos <= 10 ? points[pos - 1] : 0;
        }

        function getSkillPointsForPosition(pos) {
            if (pos === 1) return 50;
            if (pos <= 3) return 40;
            if (pos <= 6) return 30;
            if (pos <= 10) return 20;
            return 10;
        }

        function generateWeather() {
            if (gameData.currentRace >= calendar.length) return 'sunny';
            
            const race = calendar[gameData.currentRace];
            const rand = Math.random();
            
            if (rand < race.rainChance) return 'rainy';
            else if (rand < race.rainChance + 0.15) return 'windy';
            else if (rand < race.rainChance + 0.25) return 'hot';
            else if (rand < race.rainChance + 0.35) return 'cloudy';
            else return 'sunny';
        }

        function generatePressEvent() {
            const question = pressQuestions[Math.floor(Math.random() * pressQuestions.length)];
            gameData.pressEvents.push({
                ...question,
                date: `Carrera ${gameData.currentRace + 1}`,
                id: Date.now(),
                answered: false
            });
        }

        function generateTeamOffers() {
            const availableTeams = Object.keys(teams).filter(teamId => 
                teamId !== gameData.selectedTeam && 
                teams[teamId].reputation <= gameData.player.reputation + 20
            );
            
            gameData.teamOffers = availableTeams.slice(0, 2).map(teamId => ({
                teamId,
                team: teams[teamId],
                salary: Math.floor(Math.random() * 1000000) + 500000,
                duration: Math.floor(Math.random() * 3) + 1,
                offer_date: gameData.currentRace
            }));
        }

        function generateQualifyingNews(position) {
            let message = '';
            let type = 'qualifying';
            
            if (position === 1) {
                message = `¡POLE POSITION! ${gameData.player.name} consigue la pole en clasificación con una vuelta espectacular`;
                type = 'victory';
                playSound('success');
            } else if (position <= 3) {
                message = `Excelente clasificación de ${gameData.player.name} saliendo desde la primera fila en P${position}`;
                type = 'good';
                playSound('success');
            } else if (position <= 6) {
                message = `${gameData.player.name} clasifica en P${position} y saldrá desde posiciones adelantadas`;
                type = 'info';
            } else if (position <= 10) {
                message = `${gameData.player.name} clasifica en P${position} en una sesión muy disputada`;
                type = 'info';
            } else {
                message = `Clasificación complicada para ${gameData.player.name}, que saldrá desde P${position}`;
                type = 'bad';
            }
            
            addNewsItem(message, type);
        }

        function generateTrainingNews() {
            const recentTraining = newsItems.find(item => 
                item.type === 'training' && 
                (Date.now() - item.timestamp) < 10000
            );
            
            if (recentTraining) return;
            
            const messages = [
                `${gameData.player.name} completa una sesión productiva de entrenamientos libres`,
                `Buena preparación de ${gameData.player.name} de cara a la clasificación`,
                `${gameData.player.name} trabaja en el setup del coche durante los entrenamientos`,
                `Sesión de entrenamientos completada por ${gameData.player.name} con datos valiosos`
            ];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            addNewsItem(randomMessage, 'training');
        }

        function generateRaceNews(position, race) {
            let newsType = 'info';
            let message = '';
            
            if (position === 1) {
                newsType = 'victory';
                message = `¡VICTORIA HISTÓRICA! ${gameData.player.name} conquista el ${race.name}! ¡Increíble demostración de talento!`;
                playSound('win');
            } else if (position <= 3) {
                newsType = 'podium'; 
                message = `¡PODIO BRILLANTE! ${gameData.player.name} finaliza P${position} en ${race.name}. ¡Excelente actuación del piloto ${gameData.player.nationality.toLowerCase()}!`;
                playSound('win');
            } else if (position <= 6) {
                newsType = 'good';
                message = `Sólida actuación de ${gameData.player.name} sumando puntos importantes con un P${position} en ${race.name}.`;
            } else if (position <= 10) {
                newsType = 'info';
                message = `${gameData.player.name} logra sumar puntos del campeonato con un P${position} en una carrera muy competitiva en ${race.name}.`;
            } else {
                newsType = 'bad';
                message = `Fin de semana difícil para ${gameData.player.name} en ${race.name}, terminando fuera de los puntos en P${position}.`;
                playSound('error');
            }
            
            addNewsItem(message, newsType);
        }

        function generateRandomNews() {
            const generalNews = [
                `La temporada 2025 de F1 promete ser la más emocionante de la historia`,
                `Nuevas regulaciones técnicas revolucionan el diseño de los monoplazas`,
                `Los aficionados esperan una temporada llena de adelantamientos y estrategia`,
                `Los equipos continúan desarrollando sus coches para maximizar el rendimiento`,
                `La competencia entre pilotos alcanza niveles históricos este año`
            ];
            
            const randomMessage = generalNews[Math.floor(Math.random() * generalNews.length)];
            addNewsItem(randomMessage, 'info');
        }

        function formatLapTime(milliseconds) {
            const minutes = Math.floor(milliseconds / 60000);
            const seconds = Math.floor((milliseconds % 60000) / 1000);
            const ms = Math.floor((milliseconds % 1000) / 10);
            return `${minutes}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
        }

        // AÑADIR AQUÍ:
        function generateLapTime(baseSkill, teamPower, weather, tire, position) {
            // Tiempo base entre 1:20 y 1:35
            const baseTime = 80000 + Math.random() * 15000; // en milisegundos
            
            // Ajustes por habilidad del piloto
            const skillModifier = (baseSkill - 75) * -100;
            
            // Ajustes por poder del equipo
            const teamModifier = (teamPower - 75) * -50;
            
            // Ajustes por clima
            const weatherModifier = Math.abs(weather.modifier) * 200;
            
            // Ajustes por neumáticos
            const tireModifier = tire.speed * -100;
            
            // Variación aleatoria
            const randomModifier = (Math.random() - 0.5) * 2000;
            
            const finalTime = baseTime + skillModifier + teamModifier + weatherModifier + tireModifier + randomModifier;
            
            return Math.max(75000, finalTime); // Mínimo 1:15
        }      

    function renderCircuitMap(type) {
        const circuits = {
            'street': `
                <svg viewBox="0 0 300 200" class="w-full h-64">
                    <style>
                        .circuit-path { fill: none; stroke: #DC2626; stroke-width: 12; }
                        .circuit-inner { fill: none; stroke: #FCD34D; stroke-width: 1.5; stroke-dasharray: 4,3; opacity: 0.8; }
                        .start-finish { fill: #10B981; }
                        .direction-arrow { fill: #60A5FA; opacity: 0.9; }
                    </style>
                    
                    <!-- Pista principal -->
                    <path class="circuit-path" d="M50,100 L80,100 L90,90 L90,60 L110,50 L150,50 L170,60 L180,80 L190,100 L210,110 L230,120 L240,140 L230,160 L210,170 L180,170 L150,165 L120,160 L90,150 L70,130 L60,110 Z"/>
                    
                    <!-- Línea interior (corregida para seguir el path) -->
                    <path class="circuit-inner" d="M56,100 L80,100 L88,92 L88,62 L108,54 L148,54 L166,63 L176,82 L186,100 L206,110 L224,119 L232,138 L224,157 L208,166 L180,166 L150,162 L122,158 L94,149 L74,132 Z"/>
                    
                    <!-- Línea de meta -->
                    <rect class="start-finish" x="48" y="95" width="8" height="10" rx="2"/>
                    <text x="35" y="92" font-size="10" fill="#10b981" font-weight="bold">META</text>
                    
                    <!-- Flechas de dirección -->
                    <path class="direction-arrow" d="M120,55 L125,50 L130,55 L125,53 Z"/>
                    <path class="direction-arrow" d="M185,90 L190,95 L185,100 L187,95 Z"/>
                    <path class="direction-arrow" d="M200,165 L195,170 L190,165 L195,167 Z"/>
                    
                    <!-- Texto info -->
                    <text x="150" y="190" fill="#E5E7EB" text-anchor="middle" font-size="14" font-weight="bold">61 vueltas - Urbano</text>
                </svg>
            `,
            'oval': `
                <svg viewBox="0 0 300 200" class="w-full h-64">
                    <style>
                        .circuit-path { fill: none; stroke: #DC2626; stroke-width: 12; }
                        .circuit-inner { fill: none; stroke: #FCD34D; stroke-width: 1.5; stroke-dasharray: 4,3; opacity: 0.8; }
                        .start-finish { fill: #10B981; }
                        .direction-arrow { fill: #F59E0B; opacity: 0.9; }
                    </style>
                    
                    <!-- Pista principal óvalo -->
                    <ellipse class="circuit-path" cx="150" cy="100" rx="120" ry="60"/>
                    
                    <!-- Línea interior (corregida) -->
                    <ellipse class="circuit-inner" cx="150" cy="100" rx="110" ry="52"/>
                    
                    <!-- Línea de meta -->
                    <rect class="start-finish" x="28" y="95" width="8" height="10" rx="2"/>
                    <text x="15" y="92" font-size="10" fill="#10b981" font-weight="bold">META</text>
                    
                    <!-- Flechas de dirección -->
                    <path class="direction-arrow" d="M150,35 L155,40 L145,40 Z"/>
                    <path class="direction-arrow" d="M270,100 L265,105 L265,95 Z"/>
                    <path class="direction-arrow" d="M150,165 L145,160 L155,160 Z"/>
                    
                    <!-- Texto info -->
                    <text x="150" y="190" fill="#E5E7EB" text-anchor="middle" font-size="14" font-weight="bold">53 vueltas - Óvalo</text>
                </svg>
            `,
            'mountain': `
                <svg viewBox="0 0 300 200" class="w-full h-64">
                    <style>
                        .circuit-path { fill: none; stroke: #16A34A; stroke-width: 12; }
                        .circuit-inner { fill: none; stroke: #FCD34D; stroke-width: 1.5; stroke-dasharray: 4,3; opacity: 0.8; }
                        .start-finish { fill: #10B981; }
                        .direction-arrow { fill: #22C55E; opacity: 0.9; }
                    </style>
                    
                    <!-- Pista principal montaña -->
                    <path class="circuit-path" d="M50,100 Q80,80 110,90 Q140,100 150,80 Q160,60 180,70 Q200,80 220,100 Q240,120 230,145 Q220,170 190,165 Q160,160 140,170 Q120,180 100,160 Q80,140 70,120 Z"/>
                    
                    <!-- Línea interior (corregida para seguir las curvas) -->
                    <path class="circuit-inner" d="M56,100 Q82,84 108,92 Q136,101 148,84 Q158,65 178,73 Q196,82 216,100 Q234,118 226,142 Q218,164 190,161 Q162,158 142,166 Q124,175 104,159 Q84,143 72,122 Z"/>
                    
                    <!-- Línea de meta -->
                    <rect class="start-finish" x="48" y="95" width="8" height="10" rx="2"/>
                    <text x="35" y="92" font-size="10" fill="#10b981" font-weight="bold">META</text>
                    
                    <!-- Flechas de dirección -->
                    <path class="direction-arrow" d="M100,92 L105,87 L110,92 L105,90 Z"/>
                    <path class="direction-arrow" d="M155,75 L160,80 L155,85 L157,80 Z"/>
                    <path class="direction-arrow" d="M180,160 L175,165 L170,160 L175,162 Z"/>
                    
                    <!-- Texto info -->
                    <text x="150" y="190" fill="#E5E7EB" text-anchor="middle" font-size="14" font-weight="bold">44 vueltas - Montaña</text>
                </svg>
            `,
            'traditional': `
                <svg viewBox="0 0 300 200" class="w-full h-64">
                    <style>
                        .circuit-path { fill: none; stroke: #1E40AF; stroke-width: 12; }
                        .circuit-inner { fill: none; stroke: #FCD34D; stroke-width: 1.5; stroke-dasharray: 4,3; opacity: 0.8; }
                        .start-finish { fill: #10B981; }
                        .direction-arrow { fill: #60A5FA; opacity: 0.9; }
                    </style>
                    
                    <!-- Pista principal tradicional -->
                    <path class="circuit-path" d="M50,100 L100,100 Q120,100 130,85 Q140,70 160,70 L200,70 Q220,70 230,85 Q240,100 240,120 Q240,140 225,155 L180,155 Q160,155 150,140 L130,120 Q120,110 100,115 L70,130 Q55,135 50,120 Z"/>
                    
                    <!-- Línea interior (corregida) -->
                    <path class="circuit-inner" d="M56,101 L100,101 Q118,101 127,88 Q136,75 158,75 L198,75 Q216,75 225,88 Q235,101 235,120 Q235,137 222,150 L180,150 Q162,150 152,138 L132,120 Q123,112 102,116 L72,129 Z"/>
                    
                    <!-- Línea de meta -->
                    <rect class="start-finish" x="48" y="95" width="8" height="10" rx="2"/>
                    <text x="35" y="92" font-size="10" fill="#10b981" font-weight="bold">META</text>
                    
                    <!-- Flechas de dirección -->
                    <path class="direction-arrow" d="M140,73 L145,78 L135,78 Z"/>
                    <path class="direction-arrow" d="M235,105 L240,110 L235,115 L237,110 Z"/>
                    <path class="direction-arrow" d="M150,148 L145,153 L140,148 L145,150 Z"/>
                    
                    <!-- Texto info -->
                    <text x="150" y="190" fill="#E5E7EB" text-anchor="middle" font-size="14" font-weight="bold">58 vueltas - Tradicional</text>
                </svg>
            `
        };
        return circuits[type] || circuits['traditional'];
    }

        function getLevel() {
            return Math.floor(gameData.player.experience / 100) + 1;
        }

        function getAvailablePoints() {
            const earned = Math.floor(gameData.player.experience / 50);
            const used = Object.values(gameData.player.skills).reduce((sum, skill) => sum + (skill - 50), 0);
            return Math.max(0, earned - used);
        }

        function getPointsForPosition(pos) {
            const points = [25, 18, 15, 12, 10, 8, 6, 4, 2, 1];
            return pos <= 10 ? points[pos - 1] : 0;
        }

        function getSkillPointsForPosition(pos) {
            if (pos === 1) return 50;
            if (pos <= 3) return 40;
            if (pos <= 6) return 30;
            if (pos <= 10) return 20;
            return 10;
        }

        function generateWeather() {
            if (gameData.currentRace >= calendar.length) return 'sunny';
            const race = calendar[gameData.currentRace];
            const rand = Math.random();
            if (rand < race.rainChance) return 'rainy';
            else if (rand < race.rainChance + 0.15) return 'windy';
            else if (rand < race.rainChance + 0.25) return 'hot';
            else if (rand < race.rainChance + 0.35) return 'cloudy';
            return 'sunny';
        }

        function calculateTireWear(laps, tire, weather) {
            const baseDegradation = tire.degradation;
            const weatherMultiplier = weather.tireWearMultiplier;
            const totalWear = (laps / tire.durability) * baseDegradation * weatherMultiplier * 100;
            return Math.min(100, totalWear);
        }

        function calculatePitStops(laps, tire, weather) {
            const adjustedDurability = tire.durability / weather.tireWearMultiplier;
            const stopsNeeded = Math.ceil(laps / adjustedDurability) - 1;
            return Math.max(0, stopsNeeded);
        }

        function initializeDriverStandings() {
            gameData.driverStandings = {};
            Object.entries(teams).forEach(([teamId, team]) => {
                team.drivers.forEach(driver => {
                    gameData.driverStandings[driver] = { points: 0, team: teamId, wins: 0, podiums: 0 };
                });
            });
        }

        function newGame() {
            gameData.state = 'create-driver';
            render();
        }

        function continueGame() {
            if (loadGame()) {
                gameData.state = 'main-game';
                render();
            } else {
                alert('No se encontró ninguna partida guardada o está corrupta');
                gameData.state = 'main-menu';
                render();
            }
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('show'));
        }

        function searchContracts() {
            const name = document.getElementById('player-name').value.trim();
            const age = parseInt(document.getElementById('player-age').value) || 20;
            const nationality = document.getElementById('player-nationality').value;

            if (name && nationality) {
                gameData.player.name = name;
                gameData.player.age = age;
                gameData.player.nationality = nationality;
                gameData.state = 'contract-offers';
                render();
            } else {
                alert('Por favor completa todos los campos');
            }
        }

        function selectDifficulty(level) {
            gameData.difficulty = level;
            render();
        }

        function signContract(teamId) {
            gameData.selectedTeam = teamId;
            teams[teamId].drivers[1] = gameData.player.name;
            gameData.state = 'main-game';
            gameData.currentWeather = generateWeather();
            gameData.devBudget = 500;
            gameData.carUpgrades = { power: 0, aerodynamics: 0, reliability: 0, chassis: 0 };
            initializeDriverStandings();
            initializeDriverForm(); // NUEVO
            gameData.driverStandings[gameData.player.name] = { points: 0, team: teamId, wins: 0, podiums: 0 };
            render();
            setTimeout(() => {
                createSmokeEffect();
                playF1EngineSound();
            }, 500);
        }

        // ============ DESARROLLO DEL COCHE ============
        function getCarStats() {
            const baseTeam = teams[gameData.selectedTeam];
            return {
                power: baseTeam.power + (gameData.carUpgrades.power * carDevelopment.power.improvement),
                aerodynamics: baseTeam.aerodynamics + (gameData.carUpgrades.aerodynamics * carDevelopment.aerodynamics.improvement),
                reliability: baseTeam.reliability + (gameData.carUpgrades.reliability * carDevelopment.reliability.improvement),
                chassis: 50 + (gameData.carUpgrades.chassis * carDevelopment.chassis.improvement)
            };
        }

        function upgradeCar(component) {
            const upgrade = carDevelopment[component];
            const currentLevel = gameData.carUpgrades[component];
            const cost = upgrade.cost * (currentLevel + 1);
            
            if (currentLevel >= upgrade.maxLevel) {
                showNotification('Mejora al máximo nivel', 'info');
                return;
            }
            
            if (gameData.devBudget < cost) {
                showNotification('Presupuesto insuficiente', 'error');
                return;
            }
            
            gameData.carUpgrades[component]++;
            gameData.devBudget -= cost;
            playSound('success');
            showNotification(`${upgrade.name} mejorado a nivel ${gameData.carUpgrades[component]}`, 'success');
            render();
        }

        function earnDevBudget(position) {
            const budgetEarned = Math.max(0, 150 - (position * 5));
            gameData.devBudget += budgetEarned;
            return budgetEarned;
        }

        // ============ FUNCIONES DE LOGROS ============
        function checkAchievements() {
            const newlyUnlocked = [];
            
            Object.entries(achievements).forEach(([id, achievement]) => {
                // Si ya está desbloqueado, saltar
                if (gameData.achievements[id]) return;
                
                // Verificar si se cumple la condición
                if (achievement.check(gameData)) {
                    gameData.achievements[id] = {
                        unlockedAt: new Date().toISOString(),
                        name: achievement.name,
                        icon: achievement.icon
                    };
                    newlyUnlocked.push({
                        id,
                        name: achievement.name,
                        description: achievement.description,
                        icon: achievement.icon
                    });
                }
            });
            
            if (newlyUnlocked.length > 0) {
                gameData.newAchievements = newlyUnlocked;
                showAchievementNotification(newlyUnlocked);
            }
        }

        function showAchievementNotification(achievements) {
            achievements.forEach((ach, index) => {
                setTimeout(() => {
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-yellow-600 to-orange-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-fade-in border-2 border-yellow-400';
                    notification.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="text-4xl">${ach.icon}</div>
                            <div>
                                <div class="font-bold text-lg">¡LOGRO DESBLOQUEADO!</div>
                                <div class="text-sm">${ach.name}</div>
                                <div class="text-xs opacity-80">${ach.description}</div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        notification.style.transition = 'opacity 0.5s';
                        setTimeout(() => notification.remove(), 500);
                    }, 4000);
                }, index * 500);
            });
        }

        function getAchievementProgress() {
            const total = Object.keys(achievements).length;
            const unlocked = Object.keys(gameData.achievements).length;
            return { unlocked, total, percentage: Math.round((unlocked / total) * 100) };
        }        

        function goBack() {
            gameData.state = 'create-driver';
            render();
        }

        function upgradeSkill(skillName) {
            if (getAvailablePoints() > 0 && gameData.player.skills[skillName] < 100) {
                gameData.player.skills[skillName]++;
                playSound('success');
                render();
            }
        }

        function runQualifying() {
            if (gameData.isProcessing) return;
            
            // Validaciones completas
            if (!gameData.selectedTeam || !teams[gameData.selectedTeam]) {
                alert('Error: No hay equipo seleccionado');
                return;
            }
            
            if (gameData.currentRace >= calendar.length) {
                alert('Error: No hay más carreras en el calendario');
                return;
            }
            
            if (!gameData.selectedTireCompound) {
                gameData.selectedTireCompound = 'medium';
            }
            
            const race = calendar[gameData.currentRace];
            if (!race || !circuitTypes[race.type]) {
                alert('Error: Datos de circuito no válidos');
                return;
            }
            
            gameData.racePhase = 'qualifying';
            gameData.isProcessing = true;
            render();
            
            setTimeout(() => {
                try {
                    const circuitType = circuitTypes[race.type];
                    const weather = weatherConditions[gameData.currentWeather];
                    
                    let basePerf = (gameData.player.skills.speed + gameData.player.skills.control) / 2;
                    const teamPower = teams[gameData.selectedTeam].power;
                    
                    if (gameData.trainingDone) {
                        basePerf += 15;
                    }
                    
                    if (circuitType.skillBonus && gameData.player.skills[circuitType.skillBonus]) {
                        basePerf += (gameData.player.skills[circuitType.skillBonus] - 50) * 0.3;
                    }
                    
                    if (weather.skillBonus && gameData.player.skills[weather.skillBonus]) {
                        basePerf += (gameData.player.skills[weather.skillBonus] - 50) * 0.4;
                    }
                    
                    const tireBonus = tireCompounds[gameData.selectedTireCompound] ? 
                        tireCompounds[gameData.selectedTireCompound].speed : 0;
                    basePerf += tireBonus;
                    
                    const randomness = (Math.random() - 0.5) * 20;
                    const score = basePerf + (teamPower * 0.3) + weather.modifier + randomness;
                    
                    if (score >= 85) gameData.qualifyingPos = Math.floor(Math.random() * 3) + 1;
                    else if (score >= 75) gameData.qualifyingPos = Math.floor(Math.random() * 5) + 4;
                    else if (score >= 65) gameData.qualifyingPos = Math.floor(Math.random() * 6) + 9;
                    else gameData.qualifyingPos = Math.floor(Math.random() * 8) + 13;
                    
                    const expGain = gameData.qualifyingPos <= 3 ? 40 : gameData.qualifyingPos <= 6 ? 30 : 20;
                    gameData.player.experience += expGain;
                    
                    if (gameData.qualifyingPos <= 5) {
                        updateReputation(3);
                    }
                    
                    generateQualifyingNews(gameData.qualifyingPos);

                    if (gameData.qualifyingPos === 1) {
                        updateReputation(5);
                        setTimeout(() => {
                            createSparkEffect();
                        }, 100);
                    }                    

                    gameData.isProcessing = false;
                    render();
                } catch (error) {
                    console.error('Error detallado en clasificación:', error);
                    gameData.isProcessing = false;
                    gameData.racePhase = 'practice';
                    alert('Error en la clasificación: ' + error.message);
                    render();
                }
            }, 3000);
        }

        // Función corregida para conductTraining
        function conductTraining() {
            if (gameData.isProcessing || gameData.trainingDone) return;
            
            gameData.isProcessing = true;
            render(); // Renderizar completo en lugar de solo actualizar botón
            
            setTimeout(() => {
                try {
                    let expGain = Math.floor(Math.random() * 30) + 30;
                    
                    if (gameData.currentWeather === 'rainy') expGain += 15;
                    else if (gameData.currentWeather === 'windy') expGain += 10;
                    
                    gameData.player.experience += expGain;
                    gameData.trainingDone = true;
                    gameData.isProcessing = false;
                    updateReputation(2);
                    
                    // Generar noticia de entrenamiento
                    generateTrainingNews();
                    playSound('success'); 
                    render(); // Renderizar completo
                } catch (error) {
                    console.error('Error en entrenamiento:', error);
                    gameData.isProcessing = false;
                    render();
                }
            }, 2000);
        }

        // Función corregida para selectTireCompound
        function selectTireCompound(compound, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            gameData.selectedTireCompound = compound;
            render();
        }

        function startRace() {
            if (gameData.isProcessing) return;
            
            gameData.racePhase = 'race';
            gameData.isProcessing = true;
            gameData.tireWear = 0;
            gameData.pitStops = 0;
            gameData.currentLapView = 0;
            gameData.racePaused = false;
            gameData.pendingDecision = null;
            
            if (!gameData.selectedTireCompound || !tireCompounds[gameData.selectedTireCompound]) {
                gameData.selectedTireCompound = 'medium';
            }
            
            render(); 
            
            setTimeout(() => {
                try {
                    if (gameData.raceMode === 'interactive') {
                        simulateRaceInteractive();
                    } else {
                        simulateRace();
                    }
                } catch (error) {
                    console.error('Error iniciando carrera:', error);
                    gameData.isProcessing = false;
                    alert('Error al iniciar la carrera. Intenta de nuevo.');
                    render();
                }
            }, 2000);
        }

        function simulateRaceInteractive() {
            // Preparación igual que simulateRace()
            const classification = [];
            const race = calendar[gameData.currentRace];
            const circuitType = circuitTypes[race.type];
            let weather = weatherConditions[gameData.currentWeather];
            const totalLaps = race.laps;
            
            gameData.totalLaps = totalLaps;
            gameData.raceEvents = [];
            gameData.weatherWarnings = [];
            gameData.currentLap = 0;
            
            // Preparar pilotos (igual que en simulateRace)
            updateDriverForm();
            
            Object.entries(teams).forEach(([teamId, team]) => {
                team.drivers.forEach(driver => {
                    const isPlayer = driver === gameData.player.name;
                    let basePerf;
                    
                    if (isPlayer) {
                        basePerf = Object.values(gameData.player.skills).reduce((sum, skill) => sum + skill, 0) / Object.keys(gameData.player.skills).length;
                        if (gameData.trainingDone) basePerf += 12;
                        if (gameData.qualifyingPos) basePerf += Math.max(-10, (21 - gameData.qualifyingPos) * 1.5);
                        if (circuitType.skillBonus && gameData.player.skills[circuitType.skillBonus]) {
                            basePerf += (gameData.player.skills[circuitType.skillBonus] - 50) * 0.5;
                        }
                        if (weather.skillBonus && gameData.player.skills[weather.skillBonus]) {
                            basePerf += (gameData.player.skills[weather.skillBonus] - 50) * 0.6;
                        }
                    } else {
                        basePerf = calculateAIPerformance(driver, race, gameData.currentWeather);
                    }
                    
                    const teamBonus = teams[teamId].power * 0.2;
                    const difficultyPenalty = race.difficulty * 3;
                    const weatherPenalty = Math.abs(weather.modifier);
                    
                    let finalScore = basePerf + teamBonus - difficultyPenalty - weatherPenalty;
                    
                    classification.push({
                        name: driver,
                        team: teamId,
                        score: finalScore,
                        baseScore: finalScore,
                        isPlayer,
                        bestLap: 999999,
                        totalTime: 0,
                        pitStops: 0,
                        tire: isPlayer ? gameData.selectedTireCompound : ['soft', 'medium', 'hard'][Math.floor(Math.random() * 3)],
                        lapsCompleted: 0,
                        incidents: []
                    });
                });
            });
            
            gameData.raceClassification = classification;
            continueRaceLoop();
        }

        function continueRaceLoop() {
            const race = calendar[gameData.currentRace];
            const totalLaps = race.laps;
            const classification = gameData.raceClassification;
            let weather = weatherConditions[gameData.currentWeather];
            
            // Simular en bloques de 5 vueltas para más control
            const lapsToSimulate = Math.min(5, totalLaps - gameData.currentLap);
            
            for (let i = 0; i < lapsToSimulate; i++) {
                gameData.currentLap++;
                const lap = gameData.currentLap;
                
                // ============ EVENTOS CADA 5-10 VUELTAS ============
                
                // Daño detectado
                if (gameData.currentDamage && lap === gameData.currentDamage.lap && !gameData.damageRepaired) {
                    const playerDriver = classification.find(d => d.isPlayer);
                    const damageInfo = damageTypes[gameData.currentDamage.type];
                    
                    gameData.raceEvents.push({
                        lap: lap,
                        icon: damageInfo.icon,
                        text: `¡Daño en ${damageInfo.name}! Severidad: ${gameData.currentDamage.severity}%`,
                        type: 'damage'
                    });
                    
                    // Aplicar penalización
                    const modifiedStats = calculateDamageEffect(gameData.currentDamage, {
                        power: teams[playerDriver.team].power,
                        aerodynamics: teams[playerDriver.team].aerodynamics,
                        chassis: 50
                    });
                    
                    playerDriver.score -= (gameData.currentDamage.severity / 100) * 20;
                    
                    // PAUSAR para decisión
                    const decision = createRaceDecision('damage-repair', {
                        lap: lap,
                        damageType: gameData.currentDamage.type,
                        severity: gameData.currentDamage.severity,
                        repairTime: damageInfo.repairTime
                    });
                    
                    showRaceDecision(decision);
                    return; // Detener hasta que se tome la decisión
                }
                
                // Safety Car (cada 10 vueltas, 10% probabilidad)
                if (lap % 10 === 0 && lap < totalLaps - 5 && Math.random() < 0.10) {
                    gameData.raceEvents.push({
                        lap: lap,
                        icon: '🚨',
                        text: 'Safety Car desplegado - Oportunidad de pit stop',
                        type: 'safety-car'
                    });
                    
                    // Comprimir el pelotón
                    classification.forEach((driver, idx) => {
                        driver.score += (20 - idx) * 0.3;
                    });
                    
                    // PAUSAR para decisión
                    const playerDriver = classification.find(d => d.isPlayer);
                    const currentPos = classification.findIndex(d => d.isPlayer) + 1;
                    const recommendedTire = playerDriver.tire === 'soft' ? 'medium' : 
                                        playerDriver.tire === 'medium' ? 'hard' : 'medium';
                    
                    const decision = createRaceDecision('safety-car-pitstop', {
                        lap: lap,
                        currentTire: playerDriver.tire,
                        recommendedTire: recommendedTire,
                        position: currentPos
                    });
                    
                    showRaceDecision(decision);
                    return; // Detener hasta que se tome la decisión
                }
                
                // Accidente/Colisión (5% probabilidad cada 10 vueltas)
                if (lap % 10 === 5 && Math.random() < 0.05) {
                    const affectedDrivers = classification.slice(5, 12);
                    if (affectedDrivers.length > 0) {
                        const victim = affectedDrivers[Math.floor(Math.random() * affectedDrivers.length)];
                        victim.score -= 15;
                        
                        gameData.raceEvents.push({
                            lap: lap,
                            icon: '💥',
                            text: `Incidente en pista - ${victim.name} afectado`,
                            type: 'collision'
                        });
                    }
                }
                
                // Advertencia meteorológica
                if (lap === 15 || lap === 25) {
                    const weatherWarning = checkWeatherWarnings(lap, totalLaps);
                    if (weatherWarning) {
                        gameData.raceEvents.push({
                            lap: lap,
                            icon: '⚠️',
                            text: weatherWarning.message,
                            type: 'weather-warning'
                        });
                    }
                }
                
                // Cambio de clima
                const weatherChange = applyWeatherChange(lap);
                if (weatherChange) {
                    weather = weatherConditions[gameData.currentWeather];
                    gameData.raceEvents.push({
                        lap: lap,
                        icon: weather.icon,
                        text: weatherChange.message,
                        type: 'weather-change'
                    });
                    
                    // Verificar si el jugador necesita cambiar neumáticos
                    const playerDriver = classification.find(d => d.isPlayer);
                    const tire = tireCompounds[playerDriver.tire];
                    
                    if (weather.name === 'Lluvia' && !tire.wetWeather) {
                        // PAUSAR para decisión
                        const decision = createRaceDecision('weather-change-tires', {
                            lap: lap,
                            currentTire: playerDriver.tire,
                            recommendedTire: 'intermediate',
                            weather: weather.name
                        });
                        
                        showRaceDecision(decision);
                        return; // Detener hasta que se tome la decisión
                    }
                }
                
                // Simular vuelta para todos los pilotos
                classification.forEach(driver => {
                    const tire = tireCompounds[driver.tire];
                    const lapTime = generateLapTime(driver.baseScore, teams[driver.team].power, weather, tire, driver.lapsCompleted);
                    driver.totalTime += lapTime;
                    driver.lapsCompleted++;
                    
                    if (lapTime < driver.bestLap) {
                        driver.bestLap = lapTime;
                    }
                });
                
                // Vuelta rápida (12% probabilidad)
                if (Math.random() < 0.12) {
                    const topDrivers = classification.slice(0, 5);
                    const luckyDriver = topDrivers[Math.floor(Math.random() * topDrivers.length)];
                    luckyDriver.score += 5;
                    
                    gameData.raceEvents.push({
                        lap: lap,
                        icon: '⭐',
                        text: `${luckyDriver.name} establece vuelta rápida`,
                        type: 'fast-lap'
                    });
                }
                
                // Pit stops programados
                if (gameData.pitStopPlanned && lap === gameData.pitStopLap) {
                    const playerDriver = classification.find(d => d.isPlayer);
                    if (playerDriver) {
                        playerDriver.tire = gameData.pitStopNewTire;
                        playerDriver.pitStops++;
                        playerDriver.totalTime += 25000;
                        gameData.raceEvents.push({
                            lap: lap,
                            icon: '🔧',
                            text: `Tu pit stop completado - ${tireCompounds[gameData.pitStopNewTire].name}`,
                            type: 'pit-stop'
                        });
                    }
                }
                
                // Pit stops de IA (aleatorio)
                classification.forEach(driver => {
                    if (!driver.isPlayer && driver.pitStops === 0 && lap >= 20 && lap <= 40 && Math.random() < 0.03) {
                        driver.pitStops++;
                        driver.totalTime += 25000;
                        const newTire = ['soft', 'medium', 'hard'][Math.floor(Math.random() * 3)];
                        driver.tire = newTire;
                        
                        gameData.raceEvents.push({
                            lap: lap,
                            icon: '🔧',
                            text: `${driver.name} pit stop`,
                            type: 'ai-pit-stop'
                        });
                    }
                });
            }
            
            // Actualizar clasificación por tiempo
            classification.sort((a, b) => a.totalTime - b.totalTime);
            gameData.currentLapView = gameData.currentLap;
            
            // ¿Continuar o finalizar?
            if (gameData.currentLap < totalLaps) {
                render(); // Actualizar UI
                // Continuar después de 1.5 segundos
                setTimeout(() => {
                    if (!gameData.racePaused) {
                        continueRaceLoop();
                    }
                }, 1500);
            } else {
                finishRace();
            }
        }        

        function continueRace() {
            gameData.racePaused = false;
            gameData.pendingDecision = null;
            render(); // Actualizar UI
            // Continuar el bucle después de un breve delay
            setTimeout(() => continueRaceLoop(), 500);
        }

        function finishRace() {
            const classification = gameData.raceClassification;
            const race = calendar[gameData.currentRace];
            
            classification.sort((a, b) => a.totalTime - b.totalTime);
            classification.forEach((driver, index) => {
                driver.position = index + 1;
                driver.gap = index === 0 ? 0 : driver.totalTime - classification[0].totalTime;
            });
            
            const raceTimes = classification.map(d => ({...d}));
            const playerResult = classification.find(driver => driver.isPlayer);
            const position = playerResult?.position || 20;
            
            if (position <= 3) {
                setTimeout(() => createConfettiEffect(), 100);
            }
            
            const points = getPointsForPosition(position);
            const skillPoints = getSkillPointsForPosition(position) * difficultyLevels[gameData.difficulty].experienceMultiplier;
            
            // Actualizar clasificación general
            classification.forEach(driver => {
                const driverPoints = getPointsForPosition(driver.position);
                if (!gameData.driverStandings[driver.name]) {
                    gameData.driverStandings[driver.name] = {
                        points: 0,
                        team: driver.team,
                        wins: 0,
                        podiums: 0
                    };
                }
                
                gameData.driverStandings[driver.name].points += driverPoints;
                if (driver.position === 1) gameData.driverStandings[driver.name].wins++;
                if (driver.position <= 3) gameData.driverStandings[driver.name].podiums++;
            });
            
            // Reputación
            if (position === 1) {
                updateReputation(15);
                generatePressEvent();
            } else if (position <= 3) {
                updateReputation(10);
                generatePressEvent();
            } else if (position <= 6) {
                updateReputation(5);
            } else if (position <= 10) {
                updateReputation(2);
            } else {
                updateReputation(-2);
            }
            
            if (Math.random() < 0.3 && gameData.player.reputation > 60) {
                generateTeamOffers();
            }
            
            gameData.raceTimes = raceTimes;
            
            const budgetEarned = earnDevBudget(position);
            gameData.devBudget += budgetEarned;
            
            const raceResult = {
                race: race.name,
                position,
                points,
                budgetEarned: budgetEarned,
                qualifyingPos: gameData.qualifyingPos,
                weather: gameData.currentWeather,
                tireCompound: gameData.selectedTireCompound,
                pitStops: playerResult.pitStops,
                circuitType: race.type,
                bestLap: playerResult.bestLap,
                totalTime: playerResult.totalTime,
                gap: playerResult.gap
            };
            
            // Comparación compañero
            const teammate = teams[gameData.selectedTeam].drivers.find(d => d !== gameData.player.name);
            const teammateResult = classification.find(d => d.name === teammate);
            
            if (teammateResult) {
                raceResult.teammatePosition = teammateResult.position;
                
                if (gameData.qualifyingPos < teammateResult.position) {
                    teammateComparison.qualifyingBattles.player++;
                } else {
                    teammateComparison.qualifyingBattles.teammate++;
                }
                
                if (position < teammateResult.position) {
                    teammateComparison.raceBattles.player++;
                } else {
                    teammateComparison.raceBattles.teammate++;
                }
                
                teammateComparison.pointsGap = gameData.player.points - (gameData.driverStandings[teammate]?.points || 0);
            }
            
            gameData.raceResults.push(raceResult);
            gameData.player.experience += skillPoints;
            gameData.player.points = gameData.raceResults.reduce((sum, r) => sum + r.points, 0);
            gameData.racePhase = 'results';
            gameData.isProcessing = false;
            
            generateRaceNews(position, race);
            
            if (gameData.currentRace === calendar.length - 1) {
                const totalPoints = gameData.raceResults.reduce((sum, r) => sum + r.points, 0);
                if (totalPoints >= 100) {
                    gameData.player.championships++;
                    updateReputation(25);
                }
            }
            
            checkAchievements();
            render();
        }

        // Sistema de decisiones interactivas
        function createRaceDecision(type, data) {
            return {
                type: type,
                data: data,
                timestamp: Date.now()
            };
        }

        function showRaceDecision(decision) {
            gameData.racePaused = true;
            gameData.pendingDecision = decision;
            render();
        }

        function makeDecision(choice) {
            const decision = gameData.pendingDecision;
            
            if (decision.type === 'safety-car-pitstop') {
                if (choice === 'pit') {
                    const playerDriver = gameData.raceClassification.find(d => d.isPlayer);
                    if (playerDriver) {
                        playerDriver.tire = decision.data.recommendedTire;
                        playerDriver.pitStops++;
                        playerDriver.totalTime += 15000; // Menos tiempo por safety car
                        gameData.raceEvents.push({
                            lap: gameData.currentLap,
                            icon: '✅',
                            text: 'Decisión: Pit stop estratégico durante Safety Car',
                            type: 'player-decision'
                        });
                    }
                } else {
                    gameData.raceEvents.push({
                        lap: gameData.currentLap,
                        icon: '⚠️',
                        text: 'Decisión: Te quedas en pista arriesgando con los neumáticos',
                        type: 'player-decision'
                    });
                }
            } else if (decision.type === 'weather-change-tires') {
                if (choice === 'change') {
                    const playerDriver = gameData.raceClassification.find(d => d.isPlayer);
                    if (playerDriver) {
                        playerDriver.tire = decision.data.recommendedTire;
                        playerDriver.pitStops++;
                        playerDriver.totalTime += 25000;
                        gameData.raceEvents.push({
                            lap: gameData.currentLap,
                            icon: '✅',
                            text: 'Decisión: Cambio preventivo de neumáticos por clima',
                            type: 'player-decision'
                        });
                    }
                } else {
                    const playerDriver = gameData.raceClassification.find(d => d.isPlayer);
                    playerDriver.score -= 10; // Penalización por neumáticos incorrectos
                    gameData.raceEvents.push({
                        lap: gameData.currentLap,
                        icon: '⚠️',
                        text: 'Decisión: Arriesgando con neumáticos actuales (-10 rendimiento)',
                        type: 'player-decision'
                    });
                }
            } else if (decision.type === 'damage-repair') {
                const playerDriver = gameData.raceClassification.find(d => d.isPlayer);
                if (choice === 'repair') {
                    const damageInfo = damageTypes[gameData.currentDamage.type];
                    playerDriver.pitStops++;
                    playerDriver.totalTime += damageInfo.repairTime * 1000;
                    gameData.currentDamage = null;
                    gameData.damageRepaired = true;
                    gameData.raceEvents.push({
                        lap: gameData.currentLap,
                        icon: '✅',
                        text: `Decisión: Daño reparado (+${damageInfo.repairTime}s)`,
                        type: 'player-decision'
                    });
                } else {
                    gameData.raceEvents.push({
                        lap: gameData.currentLap,
                        icon: '⚠️',
                        text: 'Decisión: Continuando con daño - Rendimiento muy reducido',
                        type: 'player-decision'
                    });
                    // El daño sigue afectando
                }
            }
            
            playSound('click');
            continueRace();
        }

        function toggleRaceMode() {
            gameData.raceMode = gameData.raceMode === 'auto' ? 'interactive' : 'auto';
            render();
        }

        function simulateRace() {
            try {
                const classification = [];
                const raceTimes = [];
                const race = calendar[gameData.currentRace];
                const circuitType = circuitTypes[race.type];
                let weather = weatherConditions[gameData.currentWeather];
                
                if (!race || !circuitType || !weather) {
                    throw new Error('Datos de carrera incompletos');
                }
                
                const totalLaps = race.laps;
                gameData.totalLaps = totalLaps;
                gameData.raceEvents = []; // Reiniciar eventos
                gameData.weatherWarnings = []; // Reiniciar advertencias

                // Actualizar forma de pilotos antes de la carrera
                updateDriverForm();

                // Preparar pilotos
                Object.entries(teams).forEach(([teamId, team]) => {
                    team.drivers.forEach(driver => {
                        const isPlayer = driver === gameData.player.name;
                        let basePerf;
                        
                        if (isPlayer) {
                            basePerf = Object.values(gameData.player.skills).reduce((sum, skill) => sum + skill, 0) / Object.keys(gameData.player.skills).length;
                            if (gameData.trainingDone) basePerf += 12;
                            if (gameData.qualifyingPos) basePerf += Math.max(-10, (21 - gameData.qualifyingPos) * 1.5);
                            if (circuitType.skillBonus && gameData.player.skills[circuitType.skillBonus]) {
                                basePerf += (gameData.player.skills[circuitType.skillBonus] - 50) * 0.5;
                            }
                            if (weather.skillBonus && gameData.player.skills[weather.skillBonus]) {
                                basePerf += (gameData.player.skills[weather.skillBonus] - 50) * 0.6;
                            }
                        } else {
                            // NUEVA IA PERSONALIZADA
                            basePerf = calculateAIPerformance(driver, race, gameData.currentWeather);
                        }
                        
                        const teamBonus = team.power * 0.2;
                        const difficultyPenalty = race.difficulty * 3;
                        const weatherPenalty = Math.abs(weather.modifier);
                        
                        let finalScore = basePerf + teamBonus - difficultyPenalty - weatherPenalty;
                        
                        classification.push({
                            name: driver,
                            team: teamId,
                            score: finalScore,
                            baseScore: finalScore,
                            isPlayer,
                            bestLap: 999999,
                            totalTime: 0,
                            pitStops: 0,
                            tire: isPlayer ? gameData.selectedTireCompound : ['soft', 'medium', 'hard'][Math.floor(Math.random() * 3)],
                            lapsCompleted: 0,
                            incidents: []
                        });
                    });
                });                
                
                // SIMULACIÓN VUELTA A VUELTA
                for (let lap = 1; lap <= totalLaps; lap++) {
                    gameData.currentLap = lap;
                    
                    // Verificar advertencias meteorológicas
                    if (lap % 5 === 0) {
                        const weatherWarning = checkWeatherWarnings(lap, totalLaps);
                        if (weatherWarning) {
                            gameData.raceEvents.push({
                                lap: lap,
                                icon: '⚠️',
                                text: weatherWarning.message,
                                type: 'weather-warning'
                            });
                        }
                    }
                    
                    // Aplicar cambio climático si corresponde
                    const weatherChange = applyWeatherChange(lap);
                    if (weatherChange) {
                        weather = weatherConditions[gameData.currentWeather];
                        gameData.raceEvents.push({
                            lap: lap,
                            icon: weather.icon,
                            text: weatherChange.message,
                            type: 'weather-change'
                        });
                        
                        // Penalizar a pilotos con neumáticos incorrectos
                        classification.forEach(driver => {
                            const tire = tireCompounds[driver.tire];
                            if (weather.name === 'Lluvia' && !tire.wetWeather) {
                                driver.score -= 15;
                                if (driver.isPlayer) {
                                    gameData.raceEvents.push({
                                        lap: lap,
                                        icon: '⚠️',
                                        text: '¡Neumáticos incorrectos para lluvia! Perdiendo rendimiento',
                                        type: 'player-warning'
                                    });
                                }
                            }
                        }); 
                    }
                    
                    // EVENTOS ALEATORIOS cada 10 vueltas
                    if (lap % 10 === 0 && lap < totalLaps - 5) {
                        const eventRoll = Math.random() * difficultyLevels[gameData.difficulty].eventProbabilityMultiplier;
                        
                        Object.entries(raceEvents).forEach(([eventId, event]) => {
                            if (eventRoll < event.probability) {
                                const result = event.effect(classification, gameData.player.name, gameData);
                                if (result) {
                                    gameData.raceEvents.push({
                                        lap: lap,
                                        icon: event.icon,
                                        text: result,
                                        type: eventId
                                    });
                                }
                            }
                        });
                    }
                    
                    // Calcular tiempos de vuelta
                    classification.forEach(driver => {
                        const tire = tireCompounds[driver.tire];
                        const lapTime = generateLapTime(driver.baseScore, teams[driver.team].power, weather, tire, driver.lapsCompleted);
                        driver.totalTime += lapTime;
                        driver.lapsCompleted++;
                        
                        if (lapTime < driver.bestLap) {
                            driver.bestLap = lapTime;
                        }
                    });
                    
                    // Pit stops programados
                    if (gameData.pitStopPlanned && lap === gameData.pitStopLap) {
                        const playerDriver = classification.find(d => d.isPlayer);
                        if (playerDriver) {
                            playerDriver.tire = gameData.pitStopNewTire;
                            playerDriver.pitStops++;
                            playerDriver.totalTime += 25000; // 25 segundos
                            gameData.raceEvents.push({
                                lap: lap,
                                icon: '🔧',
                                text: `Pit stop completado - ${tireCompounds[gameData.pitStopNewTire].name}`,
                                type: 'pit-stop'
                            });
                        }
                    }
                }
                
                // Ordenar por tiempo total
                classification.sort((a, b) => a.totalTime - b.totalTime);
                classification.forEach((driver, index) => {
                    driver.position = index + 1;
                    driver.gap = index === 0 ? 0 : driver.totalTime - classification[0].totalTime;
                });
                
                // Copiar para tiempos
                raceTimes.push(...classification.map(d => ({...d})));
                
                const playerResult = classification.find(driver => driver.isPlayer);
                const position = playerResult?.position || 20;
                
                if (position <= 3) {
                    setTimeout(() => createConfettiEffect(), 100);
                }
                
                const points = getPointsForPosition(position);
                const skillPoints = getSkillPointsForPosition(position) * difficultyLevels[gameData.difficulty].experienceMultiplier;
                
                // Actualizar clasificación general
                classification.forEach(driver => {
                    const driverPoints = getPointsForPosition(driver.position);
                    if (!gameData.driverStandings[driver.name]) {
                        gameData.driverStandings[driver.name] = {
                            points: 0,
                            team: driver.team,
                            wins: 0,
                            podiums: 0
                        };
                    }
                    
                    gameData.driverStandings[driver.name].points += driverPoints;
                    
                    if (driver.position === 1) gameData.driverStandings[driver.name].wins++;
                    if (driver.position <= 3) gameData.driverStandings[driver.name].podiums++;
                });
                
                // Reputación
                if (position === 1) {
                    updateReputation(15);
                    generatePressEvent();
                } else if (position <= 3) {
                    updateReputation(10);
                    generatePressEvent();
                } else if (position <= 6) {
                    updateReputation(5);
                } else if (position <= 10) {
                    updateReputation(2);
                } else {
                    updateReputation(-2);
                }
                
                if (Math.random() < 0.3 && gameData.player.reputation > 60) {
                    generateTeamOffers();
                }
                
                gameData.raceClassification = classification;
                gameData.raceTimes = raceTimes;
                
                const budgetEarned = earnDevBudget(position);
                gameData.devBudget += budgetEarned;
                
                // Resultado de carrera
                const raceResult = {
                    race: race.name,
                    position,
                    points,
                    budgetEarned: budgetEarned,
                    qualifyingPos: gameData.qualifyingPos,
                    weather: gameData.currentWeather,
                    tireCompound: gameData.selectedTireCompound,
                    pitStops: playerResult.pitStops,
                    circuitType: race.type,
                    bestLap: playerResult.bestLap,
                    totalTime: playerResult.totalTime,
                    gap: playerResult.gap
                };
                
                // Comparación compañero
                const teammate = teams[gameData.selectedTeam].drivers.find(d => d !== gameData.player.name);
                const teammateResult = classification.find(d => d.name === teammate);
                
                if (teammateResult) {
                    raceResult.teammatePosition = teammateResult.position;
                    
                    if (gameData.qualifyingPos < teammateResult.position) {
                        teammateComparison.qualifyingBattles.player++;
                    } else {
                        teammateComparison.qualifyingBattles.teammate++;
                    }
                    
                    if (position < teammateResult.position) {
                        teammateComparison.raceBattles.player++;
                    } else {
                        teammateComparison.raceBattles.teammate++;
                    }
                    
                    teammateComparison.pointsGap = gameData.player.points - (gameData.driverStandings[teammate]?.points || 0);
                }
                
                gameData.raceResults.push(raceResult);
                gameData.player.experience += skillPoints;
                gameData.player.points = gameData.raceResults.reduce((sum, r) => sum + r.points, 0);
                gameData.racePhase = 'results';
                gameData.isProcessing = false;
                
                generateRaceNews(position, race);
                
                if (gameData.currentRace === calendar.length - 1) {
                    const totalPoints = gameData.raceResults.reduce((sum, r) => sum + r.points, 0);
                    if (totalPoints >= 100) {
                        gameData.player.championships++;
                        updateReputation(25);
                    }
                }
                
                checkAchievements();
                render();
                
            } catch (error) {
                console.error('Error en simulación de carrera:', error);
                gameData.isProcessing = false;
                alert('Error durante la carrera: ' + error.message);
                gameData.racePhase = 'practice';
                checkAchievements();
                render();
            }
        }

        function nextRace() {
            gameData.currentRace++;
            
            // Verificar si es el final de la temporada
            if (checkSeasonEnd()) {
                endSeason();
                return;
            }
            
            gameData.racePhase = 'practice';
            gameData.trainingDone = false;
            gameData.qualifyingPos = null;
            gameData.currentWeather = generateWeather();
            gameData.selectedTireCompound = 'medium';
            gameData.tireWear = 0;
            gameData.pitStopPlanned = false;
            gameData.pitStopLap = 0;
            gameData.pitStopNewTire = 'medium';
            gameData.pitStops = 0;
            gameData.raceEvents = [];
            gameData.currentDamage = generateDamage(); // NUEVO
            gameData.damageRepaired = false; 
            gameData.repairPenalty = 0; 
            gameData.activeTab = 'info'; 
            
            saveGame(); // Auto-guardar
            render();
        }

        function showStandings() {
            const standings = [];
            Object.entries(teams).forEach(([teamId, team]) => {
                team.drivers.forEach(driver => {
                    const isPlayer = driver === gameData.player.name;
                    let points = 0;
                    if (isPlayer) {
                        points = gameData.raceResults.reduce((sum, result) => sum + (result.points || 0), 0);
                    } else {
                        points = (gameData.driverStandings[driver] && gameData.driverStandings[driver].points) || 0;
                    }
                    standings.push({ name: driver, team: teamId, points: points, isPlayer });
                });
            });
            
            standings.sort((a, b) => b.points - a.points);
            
            const standingsHTML = standings.map((driver, index) => `
                <div class="p-3 rounded-lg flex justify-between items-center ${
                    driver.isPlayer ? 'bg-blue-900/50 border border-blue-400' : 'bg-gray-800'
                } mb-2">
                    <div class="flex items-center">
                        <span class="font-bold text-lg mr-3 ${
                            index === 0 ? 'text-yellow-400' :
                            index === 1 ? 'text-gray-300' :
                            index === 2 ? 'text-orange-400' : 'text-white'
                        }">${index + 1}º</span>
                        <div 
                            class="w-4 h-4 rounded-full mr-3"
                            style="background-color: ${teams[driver.team]?.color || '#666'}"
                        ></div>
                        <div>
                            <span class="font-semibold ${driver.isPlayer ? 'text-blue-300' : 'text-white'}">
                                ${driver.isPlayer ? countries[gameData.player.nationality] + ' ' : ''}${driver.name}
                            </span>
                            <div class="text-xs text-gray-400">${teams[driver.team]?.name || 'Sin equipo'}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-yellow-400">${driver.points} pts</div>
                        ${driver.isPlayer ? '<div class="text-xs text-blue-400">Tú</div>' : ''}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('standingsContent').innerHTML = standingsHTML;
            document.getElementById('standingsModal').classList.add('show');
        }

        function showRaceTimes() {
            if (gameData.raceTimes.length === 0) return;
            
            const fastestLap = Math.min(...gameData.raceTimes.map(d => d.bestLap));
            
            const timesHTML = gameData.raceTimes.map((driver, index) => `
                <tr class="${driver.isPlayer ? 'bg-blue-900/50 border-l-4 border-blue-400' : index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-700'}">
                    <td class="px-4 py-3 font-bold ${
                        index === 0 ? 'text-yellow-400' :
                        index === 1 ? 'text-gray-300' :
                        index === 2 ? 'text-orange-400' : 'text-white'
                    }">P${driver.position}</td>
                    <td class="px-4 py-3">
                        <div class="flex items-center">
                            <div 
                                class="w-3 h-3 rounded-full mr-2"
                                style="background-color: ${teams[driver.team]?.color || '#666'}"
                            ></div>
                            <span class="${driver.isPlayer ? 'text-blue-300 font-bold' : 'text-white'}">
                                ${driver.name}
                            </span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-gray-300 text-xs">${teams[driver.team]?.name}</td>
                    <td class="px-4 py-3 text-right font-mono text-sm">
                        ${index === 0 ? formatLapTime(driver.totalTime) : '+' + formatLapTime(driver.gap)}
                    </td>
                    <td class="px-4 py-3 text-right font-mono text-sm ${driver.bestLap === fastestLap ? 'text-purple-400 font-bold' : 'text-gray-400'}">
                        ${formatLapTime(driver.bestLap)}
                        ${driver.bestLap === fastestLap ? ' 🏁' : ''}
                    </td>
                    <td class="px-4 py-3 text-center text-xs text-gray-400">${driver.pitStops}</td>
                </tr>
            `).join('');
            
            const fastestDriver = gameData.raceTimes.find(d => d.bestLap === fastestLap);
            
            document.getElementById('raceTimesContent').innerHTML = `
                <div class="mb-4 bg-purple-900/30 border border-purple-500 p-3 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-gray-400">Vuelta Rápida</div>
                            <div class="text-lg font-bold text-purple-400">${formatLapTime(fastestLap)}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-400">Piloto</div>
                            <div class="font-bold ${fastestDriver?.isPlayer ? 'text-blue-300' : 'text-white'}">
                                ${fastestDriver?.name || '-'}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left">Pos</th>
                                <th class="px-4 py-2 text-left">Piloto</th>
                                <th class="px-4 py-2 text-left">Equipo</th>
                                <th class="px-4 py-2 text-right">Tiempo</th>
                                <th class="px-4 py-2 text-right">Mejor Vuelta</th>
                                <th class="px-4 py-2 text-center">Paradas</th>
                            </tr>
                        </thead>
                        <tbody>${timesHTML}</tbody>
                    </table>
                </div>
                
                ${gameData.raceEvents && gameData.raceEvents.length > 0 ? `
                    <div class="mt-4 bg-gray-800 p-3 rounded-lg">
                        <h4 class="text-sm font-bold mb-2 text-yellow-500">EVENTOS DE CARRERA</h4>
                        <div class="space-y-1 max-h-48 overflow-y-auto">
                            ${gameData.raceEvents.map(event => `
                                <div class="flex items-center gap-2 text-xs p-2 bg-gray-900 rounded">
                                    <span class="text-lg">${event.icon}</span>
                                    <span class="text-gray-500">V${event.lap}</span>
                                    <span class="text-gray-300 flex-1">${event.text}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            document.getElementById('raceTimesModal').classList.add('show');
        }

        function showAchievements() {
            const progress = getAchievementProgress();
            
            const achievementsHTML = Object.entries(achievements).map(([id, achievement]) => {
                const isUnlocked = gameData.achievements[id];
                
                return `
                <div class="p-4 rounded-lg flex items-center gap-4 mb-3 ${isUnlocked ? 'bg-gradient-to-r from-yellow-900/30 to-orange-900/30 border border-yellow-600' : 'bg-gray-800 opacity-60'}">
                    <div class="text-4xl ${isUnlocked ? '' : 'grayscale opacity-40'}">
                        ${achievement.icon}
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-lg ${isUnlocked ? 'text-yellow-400' : 'text-gray-400'}">
                            ${achievement.name}
                        </div>
                        <div class="text-sm text-gray-400">
                            ${achievement.description}
                        </div>
                        ${isUnlocked ? `
                            <div class="text-xs text-gray-500 mt-1">
                                Desbloqueado: ${new Date(gameData.achievements[id].unlockedAt).toLocaleDateString()}
                            </div>
                        ` : ''}
                    </div>
                    ${isUnlocked ? '<div class="text-green-400 text-2xl">✓</div>' : '<div class="text-gray-600 text-2xl">🔒</div>'}
                </div>
                `;
            }).join('');
            
            document.getElementById('achievementsContent').innerHTML = `
                <div class="mb-6 text-center">
                    <div class="text-4xl font-bold text-yellow-400 mb-2">${progress.unlocked} / ${progress.total}</div>
                    <div class="text-gray-400 mb-3">Logros Desbloqueados</div>
                    <div class="w-full bg-gray-700 rounded-full h-4">
                        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 h-4 rounded-full transition-all" style="width: ${progress.percentage}%"></div>
                    </div>
                    <div class="text-sm text-gray-400 mt-2">${progress.percentage}% completado</div>
                </div>
                <div class="overflow-y-auto max-h-96">
                    ${achievementsHTML}
                </div>
            `;
            document.getElementById('achievementsModal').classList.add('show');
        }

        function showSettings() {
            const currentDiff = difficultyLevels[gameData.difficulty];
                        
            document.getElementById('settingsContent').innerHTML = `
                <div class="space-y-6">
                    <!-- Acciones Rápidas -->
                    <div class="grid grid-cols-3 gap-3">
                        <!-- Guardar Partida -->
                        <div class="bg-green-900/30 border-2 border-green-600 rounded-lg p-3">
                            <div class="flex flex-col items-center mb-2">
                                <span class="text-3xl mb-1">💾</span>
                                <h3 class="text-sm font-bold text-green-400">Guardar</h3>
                            </div>
                            <button onclick="saveGame(); closeModal();" class="w-full bg-green-600 hover:bg-green-700 p-2 rounded-lg font-semibold transition-all text-sm">
                                GUARDAR
                            </button>
                            <p class="text-xs text-gray-500 mt-1 text-center">
                                Auto-guardado activo
                            </p>
                        </div>
                        
                        <!-- Logros -->
                        <div class="bg-purple-900/30 border-2 border-purple-600 rounded-lg p-3">
                            <div class="flex flex-col items-center mb-2">
                                <div class="relative">
                                    <span class="text-3xl">🏆</span>
                                    ${(() => {
                                        const progress = getAchievementProgress();
                                        return progress.unlocked > 0 ? `<span class="absolute -top-1 -right-1 bg-yellow-500 text-black text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">${progress.unlocked}</span>` : '';
                                    })()}
                                </div>
                                <h3 class="text-sm font-bold text-purple-400 mt-1">Logros</h3>
                            </div>
                            <button onclick="closeModal(); showAchievements();" class="w-full bg-purple-600 hover:bg-purple-700 p-2 rounded-lg font-semibold transition-all text-sm">
                                VER
                            </button>
                            <p class="text-xs text-gray-500 mt-1 text-center">
                                ${(() => {
                                    const progress = getAchievementProgress();
                                    return `${progress.unlocked}/${progress.total}`;
                                })()}
                            </p>
                        </div>

                        <!-- Menú Principal -->
                        <div class="bg-red-900/30 border-2 border-red-600 rounded-lg p-3">
                            <div class="flex flex-col items-center mb-2">
                                <span class="text-3xl mb-1">🏠</span>
                                <h3 class="text-sm font-bold text-red-400">Menú</h3>
                            </div>
                            <button onclick="goToMainMenu()" class="w-full bg-red-600 hover:bg-red-700 p-2 rounded-lg font-semibold transition-all text-sm">
                                SALIR
                            </button>
                            <p class="text-xs text-gray-500 mt-1 text-center">
                                Guardado auto
                            </p>
                        </div>
                    </div>
                    <!-- Navegación interna -->
                    <div class="flex gap-2 border-b border-gray-700 pb-2">
                        <button onclick="document.getElementById('settings-difficulty').scrollIntoView({behavior:'smooth'})" class="text-xs px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded">
                            Dificultad
                        </button>
                        <button onclick="document.getElementById('settings-history').scrollIntoView({behavior:'smooth'})" class="text-xs px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded">
                            Historial
                        </button>
                    </div>
                    
                    <div id="settings-difficulty">
                        <h3 class="text-lg font-bold mb-3 text-yellow-500">Dificultad Actual</h3>
                        <div class="bg-yellow-900/20 border border-yellow-600 p-3 rounded-lg mb-3 text-sm">
                            <span class="text-yellow-400">⚠️</span> Cambiar la dificultad afectará el resto de la temporada.
                        </div>
                        <div class="space-y-2">
                            ${Object.entries(difficultyLevels).map(([key, diff]) => `
                                <button 
                                    onclick="changeDifficulty('${key}')"
                                    class="w-full p-3 rounded-lg text-left transition-all ${gameData.difficulty === key ? 'bg-red-900 border-2 border-red-500' : 'bg-gray-800 hover:bg-gray-700 border-2 border-transparent'}"
                                >
                                    <div class="flex items-center gap-2">
                                        <span class="text-2xl">${diff.icon}</span>
                                        <div class="flex-1">
                                            <div class="font-bold">${diff.name}</div>
                                            <div class="text-xs text-gray-400">${diff.description}</div>
                                        </div>
                                        ${gameData.difficulty === key ? '<span class="text-green-400">✓</span>' : ''}
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-bold mb-3 text-yellow-500">Efectos de Dificultad</h3>
                        <div class="bg-gray-800 p-4 rounded-lg space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">Habilidad IA:</span>
                                <span class="${currentDiff.aiSkillMultiplier > 1 ? 'text-red-400' : 'text-green-400'}">
                                    ${currentDiff.aiSkillMultiplier > 1 ? '+' : ''}${Math.round((currentDiff.aiSkillMultiplier - 1) * 100)}%
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Experiencia ganada:</span>
                                <span class="${currentDiff.experienceMultiplier < 1 ? 'text-red-400' : 'text-green-400'}">
                                    ${currentDiff.experienceMultiplier > 1 ? '+' : ''}${Math.round((currentDiff.experienceMultiplier - 1) * 100)}%
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Eventos aleatorios:</span>
                                <span class="${currentDiff.eventProbabilityMultiplier > 1 ? 'text-red-400' : 'text-green-400'}">
                                    ${currentDiff.eventProbabilityMultiplier > 1 ? '+' : ''}${Math.round((currentDiff.eventProbabilityMultiplier - 1) * 100)}%
                                </span>
                            </div>
                        </div>

                        <div id="settings-history" class="border-t border-gray-700 pt-4">
                            <h3 class="text-lg font-bold mb-3 text-blue-500">Historial</h3>
                            <p class="text-sm text-gray-400 mb-3">Accede al registro completo de todas tus temporadas</p>
                            <button onclick="closeModal(); showSeasonHistory();" class="w-full bg-indigo-600 hover:bg-indigo-700 p-3 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                                <span>📊</span>
                                <span>VER HISTORIAL DE TEMPORADAS</span>
                            </button>
                        </div>
                    </div>
                `;
            document.getElementById('settingsModal').classList.add('show');
        }

        function changeDifficulty(newDifficulty) {
            if (confirm(`¿Cambiar dificultad a ${difficultyLevels[newDifficulty].name}? Esto afectará el resto de la temporada.`)) {
                gameData.difficulty = newDifficulty;
                showNotification(`Dificultad cambiada a ${difficultyLevels[newDifficulty].name}`, 'info');
                saveGame();
                closeModal();
                render();
            }
        }        

        // ============ FUNCIONES DE DAÑOS ============
        function repairDamage() {
            if (!gameData.currentDamage) return;
            
            const repairTime = damageTypes[gameData.currentDamage.type].repairTime;
            gameData.damageRepaired = true;
            
            // Penalización en rendimiento por tiempo de reparación
            const repairPenalty = repairTime * 0.5;
            showNotification(`Daño reparado. Penalización: -${repairPenalty.toFixed(1)} rendimiento`, 'info');
            
            // Aplicar penalización temporal (se usa en simulateRace)
            gameData.repairPenalty = repairPenalty;
            
            render();
        }

        function continueDamaged() {
            showNotification('Continuarás con el daño. Rendimiento reducido toda la carrera', 'error');
            render();
        }

        // ============ HISTORIAL DE TEMPORADAS ============
        function showSeasonHistory() {
            if (gameData.seasonsHistory.length === 0) {
                document.getElementById('historyContent').innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-3">📊</div>
                        <p>Aún no has completado ninguna temporada</p>
                        <p class="text-sm mt-2">Completa tu primera temporada para ver estadísticas</p>
                    </div>
                `;
            } else {
                const totalSeasons = gameData.seasonsHistory.length;
                const totalChampionships = gameData.seasonsHistory.filter(s => s.champion).length;
                const totalWins = gameData.seasonsHistory.reduce((sum, s) => sum + s.wins, 0);
                const totalPodiums = gameData.seasonsHistory.reduce((sum, s) => sum + s.podiums, 0);
                const totalPoints = gameData.seasonsHistory.reduce((sum, s) => sum + s.totalPoints, 0);
                
                document.getElementById('historyContent').innerHTML = `
                    <!-- Resumen general -->
                    <div class="bg-gradient-to-r from-gray-900 to-gray-800 p-4 rounded-lg mb-4">
                        <h3 class="text-lg font-bold mb-3 text-yellow-500">Carrera Completa</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-400">${totalSeasons}</div>
                                <div class="text-xs text-gray-400">Temporadas</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-400">${totalChampionships}</div>
                                <div class="text-xs text-gray-400">Títulos</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-400">${totalWins}</div>
                                <div class="text-xs text-gray-400">Victorias</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-400">${totalPodiums}</div>
                                <div class="text-xs text-gray-400">Podios</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-purple-400">${totalPoints}</div>
                                <div class="text-xs text-gray-400">Puntos</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Historial por temporada -->
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        ${gameData.seasonsHistory.slice().reverse().map((season, idx) => `
                            <div class="bg-gray-800 rounded-lg p-4 ${season.champion ? 'border-2 border-yellow-500' : 'border border-gray-700'}">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <h4 class="text-lg font-bold">Temporada ${season.seasonNumber} (${season.year})</h4>
                                            ${season.champion ? '<span class="text-yellow-400">👑</span>' : ''}
                                        </div>
                                        <div class="text-sm text-gray-400">${season.teamName}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold ${
                                            season.finalPosition === 1 ? 'text-yellow-400' :
                                            season.finalPosition <= 3 ? 'text-gray-300' :
                                            season.finalPosition <= 10 ? 'text-blue-400' : 'text-gray-500'
                                        }">${season.finalPosition}º</div>
                                        <div class="text-xs text-gray-400">Posición Final</div>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 text-xs mb-3">
                                    <div class="bg-gray-900 p-2 rounded text-center">
                                        <div class="font-bold text-yellow-400">${season.totalPoints}</div>
                                        <div class="text-gray-400">Puntos</div>
                                    </div>
                                    <div class="bg-gray-900 p-2 rounded text-center">
                                        <div class="font-bold text-green-400">${season.wins}</div>
                                        <div class="text-gray-400">Victorias</div>
                                    </div>
                                    <div class="bg-gray-900 p-2 rounded text-center">
                                        <div class="font-bold text-orange-400">${season.podiums}</div>
                                        <div class="text-gray-400">Podios</div>
                                    </div>
                                    <div class="bg-gray-900 p-2 rounded text-center">
                                        <div class="font-bold text-blue-400">${season.poles}</div>
                                        <div class="text-gray-400">Poles</div>
                                    </div>
                                    <div class="bg-gray-900 p-2 rounded text-center">
                                        <div class="font-bold text-green-300">${season.bestFinish}</div>
                                        <div class="text-gray-400">Mejor</div>
                                    </div>
                                    <div class="bg-gray-900 p-2 rounded text-center">
                                        <div class="font-bold text-purple-400">${season.avgFinish}</div>
                                        <div class="text-gray-400">Media</div>
                                    </div>
                                </div>
                                
                                <button onclick="showSeasonDetails(${season.seasonNumber - 1})" class="w-full bg-blue-600 hover:bg-blue-700 p-2 rounded text-xs font-semibold">
                                    VER DETALLES
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            document.getElementById('historyModal').classList.add('show');
        }

        function showSeasonDetails(seasonIndex) {
            const season = gameData.seasonsHistory[seasonIndex];
            
            document.getElementById('seasonDetailsContent').innerHTML = `
                <div class="space-y-4">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-2">Temporada ${season.seasonNumber} (${season.year})</h3>
                        <div class="text-lg text-gray-400">${season.teamName}</div>
                        ${season.champion ? '<div class="text-yellow-400 text-3xl mt-2">🏆 CAMPEÓN DEL MUNDO</div>' : ''}
                    </div>
                    
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h4 class="font-bold mb-3">Resultados por Carrera</h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${season.raceResults.map((result, idx) => `
                                <div class="flex justify-between items-center p-2 bg-gray-900 rounded">
                                    <div>
                                        <div class="font-semibold">${result.race}</div>
                                        <div class="text-xs text-gray-400">Q: P${result.qualifyingPos} | ${tireCompounds[result.tireCompound].name}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold ${result.position <= 3 ? 'text-yellow-400' : 'text-white'}">P${result.position}</div>
                                        <div class="text-xs text-gray-400">${result.points} pts</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <button onclick="closeModal(); showSeasonHistory();" class="w-full bg-gray-600 hover:bg-gray-700 p-3 rounded-lg font-semibold">
                        VOLVER AL HISTORIAL
                    </button>
                </div>
            `;
            
            document.getElementById('seasonDetailsModal').classList.add('show');
        }


        // ============ SISTEMA DE PESTAÑAS ============
        function switchTab(tabName, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            // Guardar el tab activo
            gameData.activeTab = tabName;
            
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Activar el tab seleccionado
            const selectedContent = document.getElementById(`tab-${tabName}`);
            const selectedButton = document.querySelector(`[data-tab="${tabName}"]`);
            
            if (selectedContent) selectedContent.classList.add('active');
            if (selectedButton) selectedButton.classList.add('active');
        }
        function getStatBadge(value) {
            if (value >= 90) return '<span class="stat-badge stat-high">Excelente</span>';
            if (value >= 80) return '<span class="stat-badge stat-medium">Bueno</span>';
            return '<span class="stat-badge stat-low">Bajo</span>';
        }

        // ============ FUNCIONES DE RENDERIZADO ============
        function renderMainMenu() {
            const hasSave = hasSavedGame();
            return `
            <div class="min-h-screen racing-bg flex items-center justify-center p-4">
                <div class="max-w-2xl w-full">
                    <div class="text-center fade-in">
                        <div class="mb-8">
                            <h1 class="text-7xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-600 via-yellow-500 to-red-600 pulse-glow">
                                F1 SIMULATOR
                            </h1>
                            <div class="text-2xl text-red-600 font-bold tracking-widest">2025 CHAMPIONSHIP EDITION</div>
                            <div class="mt-4 h-1 w-32 mx-auto bg-gradient-to-r from-transparent via-red-600 to-transparent"></div>
                        </div>
                        <div class="space-y-4 mt-12">
                            <button onclick="newGame()" class="w-full btn-primary glow-red py-6 rounded-xl font-bold text-xl transition-all transform hover:scale-105 uppercase tracking-wider">
                                NUEVA CARRERA
                            </button>
                            ${hasSave ? `
                                <button onclick="continueGame()" class="w-full bg-blue-600 hover:bg-blue-700 py-6 rounded-xl font-bold text-xl transition-all transform hover:scale-105 uppercase tracking-wider">
                                    CONTINUAR PARTIDA
                                </button>
                                <button onclick="if(deleteSave()) { render(); }" class="w-full bg-gray-700 hover:bg-gray-800 py-4 rounded-xl font-semibold text-lg transition-all uppercase tracking-wider">
                                    BORRAR PROGRESO
                                </button>
                            ` : ''}
                        </div>
                        <div class="mt-12 text-gray-400 text-sm uppercase tracking-widest">
                            Conviértete en el próximo campeón del mundo
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function renderDriverCreation() {
            return `
            <div class="min-h-screen p-4 racing-bg">
                <div class="max-w-2xl mx-auto fade-in">
                    <div class="text-center mb-8">
                        <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">CREA TU PILOTO</h1>
                        <p class="text-xl text-gray-300">Diseña tu carrera en la Fórmula 1</p>
                    </div>
                    <div class="racing-border rounded-xl p-8 space-y-6">
                        <div>
                            <label class="block text-lg font-semibold mb-3 text-red-500">Nombre del Piloto</label>
                            <input type="text" id="player-name" class="w-full p-4 bg-gray-900 border-2 border-red-600 rounded-lg text-white focus:border-yellow-500 focus:outline-none" placeholder="Ej: Carlos Rodríguez" maxlength="30"/>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-lg font-semibold mb-3 text-red-500">Edad</label>
                                <select id="player-age" class="w-full p-4 bg-gray-900 border-2 border-red-600 rounded-lg text-white focus:border-yellow-500 focus:outline-none">
                                    ${Array.from({length: 17}, (_, i) => i + 16).map(age => `
                                        <option value="${age}" ${age === 16 ? 'selected' : ''}>${age} años</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-lg font-semibold mb-3 text-red-500">Nacionalidad</label>
                                <select id="player-nationality" class="w-full p-4 bg-gray-900 border-2 border-red-600 rounded-lg text-white focus:border-yellow-500 focus:outline-none">
                                    <option value="">Selecciona país</option>
                                    ${Object.entries(countries).map(([country, flag]) => `
                                        <option value="${country}">${flag} ${country}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-lg font-semibold mb-3 text-red-500">Dificultad</label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                ${Object.entries(difficultyLevels).map(([key, diff]) => `
                                    <div 
                                        onclick="selectDifficulty('${key}')" 
                                        class="p-4 rounded-lg border-2 cursor-pointer transition-all hover:border-red-500 ${gameData.difficulty === key ? 'border-red-500 bg-red-900/30' : 'border-gray-600 bg-gray-900'}"
                                        id="difficulty-${key}"
                                    >
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-2xl">${diff.icon}</span>
                                            <span class="font-bold text-lg">${diff.name}</span>
                                        </div>
                                        <p class="text-xs text-gray-400">${diff.description}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="gameData.state = 'main-menu'; render();" class="flex-1 bg-gray-600 hover:bg-gray-700 p-4 rounded-lg font-semibold transition-all">VOLVER</button>
                            <button onclick="searchContracts()" class="flex-2 btn-primary glow-red p-4 rounded-lg font-bold transition-all">BUSCAR CONTRATOS</button>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (gameData.state === 'main-menu') {
                const hasSave = hasSavedGame();
                app.innerHTML = renderMainMenu();
            } else if (gameData.state === 'create-driver') {
                app.innerHTML = renderDriverCreation();
            } else if (gameData.state === 'contract-offers') {
                const offers = [
                    { teamId: 'williams', team: teams['williams'], salary: 250000, duration: 1 },
                    { teamId: 'haas', team: teams['haas'], salary: 300000, duration: 2 }
                ];
                app.innerHTML = `
                <div class="min-h-screen p-4 racing-bg">
                    <div class="max-w-4xl mx-auto fade-in">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">OFERTAS DE CONTRATO</h1>
                            <p class="text-xl text-gray-300">${countries[gameData.player.nationality] || ''} ${gameData.player.name}, estas escuderías te quieren</p>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            ${offers.map(offer => `
                                <div class="racing-border rounded-xl p-6 card-hover">
                                    <div class="flex items-center mb-4">
                                        <div class="w-8 h-8 rounded-full mr-4 team-badge" style="background-color: ${offer.team.color}"></div>
                                        <div>
                                            <h3 class="text-xl font-bold">${offer.team.name}</h3>
                                            <p class="text-sm text-gray-400">Potencia: ${offer.team.power}/100</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 mb-4 text-sm">
                                        <div class="flex justify-between">
                                            <span>Aerodinámica:</span>
                                            <span>${getStatBadge(offer.team.aerodynamics)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Fiabilidad:</span>
                                            <span>${getStatBadge(offer.team.reliability)}</span>
                                        </div>
                                    </div>
                                    <button onclick="signContract('${offer.teamId}')" class="w-full btn-primary glow-red p-3 rounded-lg font-semibold transition-all">FIRMAR CONTRATO</button>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-center mt-8">
                            <button onclick="goBack()" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold transition-all">VOLVER</button>
                        </div>
                    </div>
                </div>
                `;
            } else if (gameData.state === 'main-game') {
                const currentTeam = teams[gameData.selectedTeam];
                const race = calendar[gameData.currentRace];
                const weather = weatherConditions[gameData.currentWeather];
                const tire = tireCompounds[gameData.selectedTireCompound];
                const circuitType = circuitTypes[race.type];
                
                app.innerHTML = `
                <div class="min-h-screen">
                    <div class="bg-black/80 backdrop-blur-sm border-b-2 border-red-600 p-4">
                        <div class="max-w-6xl mx-auto flex justify-between items-center flex-wrap gap-4">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full mr-3 team-badge" style="background-color: ${currentTeam.color}"></div>
                                <div>
                                    <h2 class="text-xl font-bold">${countries[gameData.player.nationality] || ''} ${gameData.player.name}</h2>
                                    <p class="text-gray-400 text-sm">${currentTeam.name}</p>
                                </div>
                            </div>
                            <div class="flex gap-6 text-sm">
                                <div class="text-center">
                                    <div class="font-bold text-yellow-400">${gameData.player.championships}</div>
                                    <div class="text-gray-400">Títulos</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold text-blue-400">${getLevel()}</div>
                                    <div class="text-gray-400">Nivel</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold text-green-400">${gameData.player.points || 0}</div>
                                    <div class="text-gray-400">Puntos</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold ${
                                        gameData.difficulty === 'beginner' ? 'text-green-400' :
                                        gameData.difficulty === 'normal' ? 'text-yellow-400' :
                                        gameData.difficulty === 'hard' ? 'text-orange-400' : 'text-red-400'
                                    }">${difficultyLevels[gameData.difficulty].icon}</div>
                                    <div class="text-gray-400 text-xs">${difficultyLevels[gameData.difficulty].name}</div>
                                </div>                                
                            </div>

                            <div class="flex gap-2 flex-wrap">
                                <button onclick="initAudio(); showAudioSettings();" class="px-3 py-2 rounded font-semibold text-sm bg-green-600 hover:bg-green-700">
                                    🔊
                                </button>
                                <button onclick="showThemeSelector()" class="px-3 py-2 rounded font-semibold text-sm bg-purple-600 hover:bg-purple-700">
                                    ${themes[currentTheme].icon}
                                </button>
                                <button onclick="showStandings()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold text-sm">CLASIFICACIÓN</button>
                                <button onclick="showSettings()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded font-semibold text-sm">
                                    ⚙️
                                </button>
                            </div>

                        </div>
                        <div class="news-bar py-2 mt-2">
                            <div class="news-ticker text-white">${race.name} - ${race.country} - Clima: ${weather.name} ${weather.icon} - Vueltas: ${race.laps}</div>
                        </div>
                    </div>

                    <div class="max-w-7xl mx-auto p-2">
                        <div class="main-game-grid">
                            <!-- Columna Principal - Carrera -->
                            <div class="space-y-4">
                                <div class="racing-border rounded-xl">
                                    <h3 class="text-2xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">
                                        ${race.name}
                                    </h3>
                                    
                                    <!-- Tabs de información -->
                                    <div class="tab-container">
                                        <button class="tab-button ${gameData.activeTab === 'info' ? 'active' : ''}" data-tab="info" onclick="switchTab('info', event)">Info</button>
                                        <button class="tab-button ${gameData.activeTab === 'circuit' ? 'active' : ''}" data-tab="circuit" onclick="switchTab('circuit', event)">Circuito</button>
                                        <button class="tab-button ${gameData.activeTab === 'tires' ? 'active' : ''}" data-tab="tires" onclick="switchTab('tires', event)">Neumáticos</button>
                                    </div>
                                    
                                    <!-- Tab: Información General -->
                                    <div id="tab-info" class="tab-content ${gameData.activeTab === 'info' ? 'active' : ''}">
                                        <div class="compact-grid mb-3">
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">País</div>
                                                <div class="compact-stat-value">${race.country}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Tipo</div>
                                                <div class="compact-stat-value">${circuitType.name}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Clima</div>
                                                <div class="compact-stat-value ${weather.color}">${weather.icon} ${weather.name}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Vueltas</div>
                                                <div class="compact-stat-value">${race.laps}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Calendario</div>
                                                <div class="compact-stat-value text-yellow-400">${gameData.currentRace + 1}/${calendar.length}</div>
                                            </div>
                                        </div>
                                        <div class="text-xs text-yellow-400 text-center p-2 bg-gray-900 rounded">
                                            ⚠️ El clima puede cambiar durante la carrera
                                        </div>
                                    </div>
                                    
                                    <!-- Tab: Circuito -->
                                    <div id="tab-circuit" class="tab-content ${gameData.activeTab === 'circuit' ? 'active' : ''}">
                                        <div class="circuit-map-compact">
                                            ${renderCircuitMap(race.type)}
                                        </div>
                                    </div>
                                    
                                    <!-- Tab: Neumáticos -->
                                    <div id="tab-tires" class="tab-content ${gameData.activeTab === 'tires' ? 'active' : ''}">
                                        <!-- Selector de modo de carrera -->
                                        <div class="bg-gray-900 p-3 rounded-lg mb-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-sm font-semibold">Modo de Carrera</span>
                                                <button onclick="toggleRaceMode()" class="px-3 py-1 rounded text-xs font-bold ${gameData.raceMode === 'interactive' ? 'bg-blue-600' : 'bg-gray-600'}">
                                                    ${gameData.raceMode === 'interactive' ? 'INTERACTIVO' : 'AUTOMÁTICO'}
                                                </button>
                                            </div>
                                            <p class="text-xs text-gray-400">
                                                ${gameData.raceMode === 'interactive' ? 'Tomarás decisiones durante la carrera cada 10 vueltas' : 'La carrera se simula completamente'}
                                            </p>
                                        </div>

                                        <div class="space-y-2">
                                            ${Object.entries(tireCompounds).map(([compound, data]) => {
                                                const selected = gameData.selectedTireCompound === compound;
                                                const estWear = calculateTireWear(race.laps, data, weather);
                                                const estStops = calculatePitStops(race.laps, data, weather);
                                                return `
                                                <div onclick="selectTireCompound('${compound}', event)" class="tire-compact ${selected ? 'selected' : ''}">
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-2xl">${data.icon}</span>
                                                        <div>
                                                            <div class="text-sm font-bold ${data.color}">${data.name}</div>
                                                            <div class="text-xs text-gray-400">+${data.speed} vel | ${data.grip}% agarre</div>
                                                        </div>
                                                    </div>
                                                    <div class="text-right">
                                                        <div class="text-xs text-gray-400">${estStops} parada${estStops !== 1 ? 's' : ''}</div>
                                                        <div class="text-xs ${estWear > 80 ? 'text-red-400' : 'text-green-400'}">${Math.round(estWear)}% desgaste</div>
                                                    </div>
                                                </div>
                                            `}).join('')}
                                        </div>
                                        
                                        ${gameData.racePhase === 'practice' || gameData.racePhase === 'qualifying' ? `
                                            <div class="bg-gray-800 p-2 rounded mt-3">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <input 
                                                        type="checkbox" 
                                                        id="planPitStop" 
                                                        ${gameData.pitStopPlanned ? 'checked' : ''}
                                                        onchange="event.stopPropagation(); gameData.pitStopPlanned = this.checked; render();"
                                                        onclick="event.stopPropagation();"
                                                        class="w-4 h-4"
                                                    />
                                                    <label for="planPitStop" class="text-xs font-semibold">Estrategia de Pit Stop</label>
                                                </div>
                                                ${gameData.pitStopPlanned ? `
                                                    <input 
                                                        type="range" 
                                                        min="10" 
                                                        max="${race.laps - 10}" 
                                                        value="${gameData.pitStopLap || Math.floor(race.laps / 2)}"
                                                        onchange="event.stopPropagation(); gameData.pitStopLap = parseInt(this.value); render();"
                                                        onclick="event.stopPropagation();"
                                                        class="w-full"
                                                    />
                                                    <div class="text-center text-xs text-yellow-400 mb-2">Vuelta ${gameData.pitStopLap || Math.floor(race.laps / 2)}</div>
                                                        <select 
                                                            onchange="event.stopPropagation(); gameData.pitStopNewTire = this.value; render();"
                                                            onclick="event.stopPropagation();"
                                                            class="w-full p-2 bg-gray-900 border border-red-600 rounded text-xs text-white"
                                                        >                                                    
                                                        ${Object.entries(tireCompounds).map(([key, tire]) => `
                                                            <option value="${key}" ${gameData.pitStopNewTire === key ? 'selected' : ''}>
                                                                ${tire.icon} ${tire.name}
                                                            </option>
                                                        `).join('')}
                                                    </select>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <!-- Botones de acción -->
                                    <div class="mt-4">
                                        ${gameData.racePhase === 'practice' ? `
                                            <div class="grid grid-cols-2 gap-2">
                                                <button onclick="conductTraining()" ${gameData.trainingDone || gameData.isProcessing ? 'disabled' : ''} class="btn-primary glow-red p-3 rounded-lg font-semibold disabled:opacity-50 text-sm">
                                                    ${gameData.trainingDone ? '✓ COMPLETADO' : gameData.isProcessing ? 'ENTRENANDO...' : 'ENTRENAR'}
                                                </button>
                                                <button onclick="runQualifying()" class="bg-yellow-600 hover:bg-yellow-700 p-3 rounded-lg font-semibold text-sm">
                                                    CLASIFICACIÓN
                                                </button>
                                            </div>
                                        ` : gameData.racePhase === 'qualifying' && gameData.qualifyingPos ? `
                                            <div class="bg-gray-900 p-3 rounded-lg mb-3 text-center">
                                                <p class="text-sm mb-1">Tu posición:</p>
                                                <p class="text-3xl font-bold ${gameData.qualifyingPos <= 3 ? 'text-yellow-500' : 'text-red-500'}">P${gameData.qualifyingPos}</p>
                                            </div>

                                            ${gameData.currentDamage && !gameData.damageRepaired ? `
                                                <div class="bg-red-900/50 border-2 border-red-500 p-4 rounded-lg mb-4">
                                                    <div class="flex items-center gap-2 mb-2">
                                                        <span class="text-2xl">${damageTypes[gameData.currentDamage.type].icon}</span>
                                                        <div>
                                                            <div class="font-bold text-red-400">¡DAÑO DETECTADO!</div>
                                                            <div class="text-sm text-gray-300">${damageTypes[gameData.currentDamage.type].name}</div>
                                                        </div>
                                                    </div>
                                                    <div class="text-xs text-gray-400 mb-3">
                                                        Severidad: ${gameData.currentDamage.severity}% | 
                                                        Tiempo de reparación: ${damageTypes[gameData.currentDamage.type].repairTime}s
                                                    </div>
                                                    <div class="grid grid-cols-2 gap-2">
                                                        <button onclick="repairDamage()" class="bg-green-600 hover:bg-green-700 p-2 rounded font-semibold text-sm">
                                                            REPARAR (-${damageTypes[gameData.currentDamage.type].repairTime}s)
                                                        </button>
                                                        <button onclick="continueDamaged()" class="bg-orange-600 hover:bg-orange-700 p-2 rounded font-semibold text-sm">
                                                            CONTINUAR DAÑADO
                                                        </button>
                                                    </div>
                                                </div>
                                            ` : ''}                                            

                                            <button onclick="startRace()" class="w-full btn-primary glow-red p-3 rounded-lg font-semibold">INICIAR CARRERA</button>
                                        ` : gameData.racePhase === 'results' ? `
                                            <div class="bg-gray-900 p-4 rounded-lg mb-3 text-center">
                                                <p class="text-sm text-gray-400 mb-1">Posición Final</p>
                                                <p class="text-3xl font-bold mb-2 ${gameData.raceResults[gameData.raceResults.length - 1].position <= 3 ? 'text-yellow-500' : 'text-red-500'}">
                                                    P${gameData.raceResults[gameData.raceResults.length - 1].position}
                                                </p>
                                                <div class="flex justify-center gap-4 text-sm">
                                                    <span class="text-yellow-400">${gameData.raceResults[gameData.raceResults.length - 1].points} pts</span>
                                                    <span class="text-green-400">+${gameData.raceResults[gameData.raceResults.length - 1].budgetEarned || 0} I+D</span>
                                                </div>
                                                ${gameData.raceResults[gameData.raceResults.length - 1].teammatePosition ? `
                                                    <div class="mt-2 pt-2 border-t border-gray-700 text-xs">
                                                        <span class="text-gray-400">Compañero: </span>
                                                        <span class="${gameData.raceResults[gameData.raceResults.length - 1].position < gameData.raceResults[gameData.raceResults.length - 1].teammatePosition ? 'text-green-400' : 'text-red-400'}">
                                                            P${gameData.raceResults[gameData.raceResults.length - 1].teammatePosition}
                                                        </span>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            
                                            ${gameData.raceEvents && gameData.raceEvents.length > 0 ? `
                                                <div class="bg-gray-900 p-2 rounded-lg mb-3 max-h-32 overflow-y-auto">
                                                    <h4 class="text-xs font-bold mb-2 text-yellow-500">EVENTOS</h4>
                                                    ${gameData.raceEvents.map(event => `
                                                        <div class="flex items-center gap-2 text-xs p-1 bg-gray-800 rounded mb-1">
                                                            <span>${event.icon}</span>
                                                            <span class="text-gray-300">${event.text}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                            
                                            <div class="grid grid-cols-2 gap-2">
                                                <button onclick="showRaceTimes()" class="bg-purple-600 hover:bg-purple-700 p-2 rounded-lg font-semibold text-sm">TIEMPOS</button>
                                                <button onclick="nextRace()" class="btn-primary glow-red p-2 rounded-lg font-semibold text-sm">
                                                    ${gameData.currentRace + 1 >= calendar.length ? 'FINALIZAR' : 'SIGUIENTE'}
                                                </button>
                                            </div>
                                        ` : '<div class="text-center py-4"><div class="spinner w-10 h-10 border-4 border-red-600 border-t-transparent rounded-full mx-auto"></div></div>'}
                                    </div>
                                </div>

                                <!-- Panel Calendario Completo -->
                                <div class="racing-border rounded-xl">
                                    <h3 class="text-lg font-bold mb-2 text-yellow-500">CALENDARIO 2025</h3>
                                    <div class="space-y-1 max-h-64 overflow-y-auto">
                                        ${calendar.map((gp, index) => {
                                            const raced = index < gameData.currentRace;
                                            const current = index === gameData.currentRace;
                                            const result = gameData.raceResults.find(r => r.race === gp.name);
                                            
                                            return `
                                            <div class="flex items-center justify-between p-2 rounded text-xs ${
                                                current ? 'bg-red-900/50 border border-red-500' :
                                                raced ? 'bg-gray-800' : 'bg-gray-900/50 opacity-60'
                                            }">
                                                <div class="flex items-center gap-2 flex-1">
                                                    <span class="font-bold ${current ? 'text-yellow-400' : 'text-gray-400'}">${index + 1}</span>
                                                    <div class="flex-1">
                                                        <div class="font-semibold ${current ? 'text-white' : raced ? 'text-gray-300' : 'text-gray-500'}">
                                                            ${gp.name}
                                                        </div>
                                                        <div class="text-gray-500 text-xs">${gp.country}</div>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    ${result ? `
                                                        <div class="font-bold ${
                                                            result.position === 1 ? 'text-yellow-400' :
                                                            result.position <= 3 ? 'text-orange-400' :
                                                            result.position <= 10 ? 'text-green-400' : 'text-gray-400'
                                                        }">P${result.position}</div>
                                                        <div class="text-gray-500">${result.points} pts</div>
                                                    ` : current ? `
                                                        <div class="text-red-400 font-bold">→</div>
                                                    ` : `
                                                        <div class="text-gray-600">-</div>
                                                    `}
                                                </div>
                                            </div>
                                        `}).join('')}
                                    </div>
                                </div>                                
                            </div>
                            
                            <!-- Columna Central - Habilidades -->
                            <div class="space-y-4">
                                <div class="racing-border rounded-xl">
                                    <h3 class="text-lg font-bold mb-3 text-yellow-500">HABILIDADES</h3>
                                    ${Object.entries(gameData.player.skills).map(([skill, value]) => `
                                        <div class="mb-2">
                                            <div class="flex justify-between mb-1">
                                                <span class="text-xs">${skill}</span>
                                                <div class="flex items-center gap-1">
                                                    <span class="text-xs font-bold">${value}</span>
                                                    <button onclick="upgradeSkill('${skill}')" ${getAvailablePoints() === 0 || value >= 100 ? 'disabled' : ''} class="w-10 h-1 bg-red-600 hover:bg-red-700 disabled:bg-gray-600 rounded text-sm font-bold">+</button>
                                                </div>
                                            </div>
                                            <div class="w-full bg-gray-700 rounded-full h-1.5">
                                                <div class="progress-bar h-1.5 rounded-full" style="width: ${value}%"></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                    <div class="mt-3 pt-3 border-t border-gray-700 text-center">
                                        <p class="text-xs text-gray-400">Disponibles: <span class="font-bold text-yellow-400">${getAvailablePoints()}</span></p>
                                    </div>
                                </div>
                                
                                <!-- VS Compañero compacto -->
                                <div class="racing-border rounded-xl">
                                    <h3 class="text-lg font-bold mb-2 text-yellow-500">VS COMPAÑERO</h3>
                                    <div class="text-center mb-2">
                                        <div class="text-xs text-gray-400">${teams[gameData.selectedTeam].drivers.find(d => d !== gameData.player.name)}</div>
                                    </div>
                                    <div class="compact-grid text-xs">
                                        <div class="compact-stat">
                                            <div class="compact-stat-label">Clasificación</div>
                                            <div class="compact-stat-value ${teammateComparison.qualifyingBattles.player > teammateComparison.qualifyingBattles.teammate ? 'text-green-400' : 'text-red-400'}">
                                                ${teammateComparison.qualifyingBattles.player}-${teammateComparison.qualifyingBattles.teammate}
                                            </div>
                                        </div>
                                        <div class="compact-stat">
                                            <div class="compact-stat-label">Carreras</div>
                                            <div class="compact-stat-value ${teammateComparison.raceBattles.player > teammateComparison.raceBattles.teammate ? 'text-green-400' : 'text-red-400'}">
                                                ${teammateComparison.raceBattles.player}-${teammateComparison.raceBattles.teammate}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-2 text-xs">
                                        <span class="text-gray-400">Puntos: </span>
                                        <span class="font-bold ${teammateComparison.pointsGap > 0 ? 'text-green-400' : 'text-red-400'}">
                                            ${teammateComparison.pointsGap > 0 ? '+' : ''}${teammateComparison.pointsGap}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Columna Derecha - Desarrollo -->
                            <div class="space-y-4">
                                <div class="racing-border rounded-xl">
                                    <h3 class="text-lg font-bold mb-3 text-yellow-500">I+D</h3>
                                    <div class="text-center mb-3">
                                        <div class="text-xs text-gray-400">Presupuesto</div>
                                        <div class="text-2xl font-bold text-green-400">${gameData.devBudget}</div>
                                    </div>
                                    <div class="space-y-2">
                                        ${Object.entries(carDevelopment).map(([key, upgrade]) => {
                                            const currentLevel = gameData.carUpgrades[key];
                                            const cost = upgrade.cost * (currentLevel + 1);
                                            const isMaxed = currentLevel >= upgrade.maxLevel;
                                            const canAfford = gameData.devBudget >= cost;
                                            
                                            return `
                                            <div class="bg-gray-900 p-2 rounded-lg">
                                                <div class="flex justify-between items-center mb-1">
                                                    <span class="text-xs font-semibold">${upgrade.name}</span>
                                                    <span class="text-xs ${isMaxed ? 'text-green-400' : 'text-gray-400'}">
                                                        ${currentLevel}/${upgrade.maxLevel}
                                                    </span>
                                                </div>
                                                <div class="w-full bg-gray-700 rounded-full h-1 mb-1">
                                                    <div class="bg-gradient-to-r from-red-600 to-yellow-500 h-1 rounded-full" style="width: ${(currentLevel / upgrade.maxLevel) * 100}%"></div>
                                                </div>
                                                <div class="flex justify-between items-center">
                                                    <span class="text-xs text-gray-400">${cost} pts</span>
                                                    <button 
                                                    onclick="upgradeCar('${key}')" 
                                                    ${isMaxed || !canAfford || gameData.racePhase !== 'practice' ? 'disabled' : ''}
                                                    class="text-sm px-2 py-1 rounded font-bold ${isMaxed ? 'bg-gray-600' : canAfford ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-600'} disabled:opacity-50 disabled:cursor-not-allowed min-w-[40px]"
                                                >
                                                    ${isMaxed ? 'MAX' : '↑'}
                                                </button>
                                                </div>
                                            </div>
                                        `}).join('')}
                                    </div>
                                    <div class="mt-2 text-xs text-gray-400 text-center">
                                        ${gameData.racePhase === 'practice' ? '✓ Disponible ahora' : '⏸ Solo en práctica'}
                                    </div>
                                </div>
                                <!-- Características del coche compacto -->
                                <div class="racing-border rounded-xl">
                                    <h3 class="text-lg font-bold mb-2 text-yellow-500">COCHE</h3>
                                    ${(() => {
                                        const carStats = getCarStats();
                                        const baseTeam = teams[gameData.selectedTeam];
                                        return `
                                        <div class="compact-grid">
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Potencia</div>
                                                <div class="compact-stat-value text-green-400">${Math.round(carStats.power)}</div>
                                                <div class="text-xs text-gray-500 line-through">${baseTeam.power}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Aero</div>
                                                <div class="compact-stat-value text-green-400">${Math.round(carStats.aerodynamics)}</div>
                                                <div class="text-xs text-gray-500 line-through">${baseTeam.aerodynamics}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Fiabilidad</div>
                                                <div class="compact-stat-value text-green-400">${Math.round(carStats.reliability)}</div>
                                                <div class="text-xs text-gray-500 line-through">${baseTeam.reliability}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Chasis</div>
                                                <div class="compact-stat-value text-green-400">${Math.round(carStats.chassis)}</div>
                                            </div>
                                        </div>
                                        `;
                                    })()}
                                </div>                            
                            </div>

                        </div> <!-- Cierre de main-game-grid -->
                        
                        <!-- OVERLAYS GLOBALES (fuera de tabs y columns) -->
                        ${gameData.pendingDecision ? `
                            <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50">
                                <div class="bg-gray-900 border-4 border-yellow-500 rounded-xl p-6 max-w-md mx-4 animate-fade-in">
                                    <h3 class="text-2xl font-bold mb-4 text-yellow-400">
                                        ${gameData.pendingDecision.type === 'safety-car-pitstop' ? '🚨 SAFETY CAR' :
                                        gameData.pendingDecision.type === 'weather-change-tires' ? '🌧️ CAMBIO CLIMÁTICO' :
                                        gameData.pendingDecision.type === 'damage-repair' ? '⚠️ DAÑO DETECTADO' :
                                        '💨 OPORTUNIDAD DE ADELANTAMIENTO'}
                                    </h3>
                                    
                                    ${gameData.pendingDecision.type === 'safety-car-pitstop' ? `
                                        <p class="text-gray-300 mb-4">
                                            Hay Safety Car en pista. Actualmente estás en <span class="text-yellow-400 font-bold">P${gameData.pendingDecision.data.position}</span> con neumáticos <span class="text-blue-400">${tireCompounds[gameData.pendingDecision.data.currentTire].name}</span>.
                                        </p>
                                        <p class="text-sm text-gray-400 mb-6">
                                            Vuelta ${gameData.pendingDecision.data.lap}/${gameData.totalLaps}
                                        </p>
                                        <div class="grid grid-cols-2 gap-3">
                                            <button onclick="makeDecision('pit')" class="bg-green-600 hover:bg-green-700 p-4 rounded-lg font-bold">
                                                ENTRAR A BOXES
                                                <div class="text-xs font-normal mt-1">Cambiar a ${tireCompounds[gameData.pendingDecision.data.recommendedTire].name}</div>
                                            </button>
                                            <button onclick="makeDecision('stay')" class="bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold">
                                                QUEDARSE FUERA
                                                <div class="text-xs font-normal mt-1">Mantener posición</div>
                                            </button>
                                        </div>
                                    ` : gameData.pendingDecision.type === 'weather-change-tires' ? `
                                        <p class="text-gray-300 mb-4">
                                            El clima ha cambiado a <span class="text-yellow-400 font-bold">${gameData.pendingDecision.data.weather}</span>. Llevas neumáticos <span class="text-blue-400">${tireCompounds[gameData.pendingDecision.data.currentTire].name}</span>.
                                        </p>
                                        <p class="text-sm text-gray-400 mb-6">
                                            Vuelta ${gameData.pendingDecision.data.lap}/${gameData.totalLaps}
                                        </p>
                                        <div class="grid grid-cols-2 gap-3">
                                            <button onclick="makeDecision('change')" class="bg-blue-600 hover:bg-blue-700 p-4 rounded-lg font-bold">
                                                CAMBIAR NEUMÁTICOS
                                                <div class="text-xs font-normal mt-1">A ${tireCompounds[gameData.pendingDecision.data.recommendedTire].name}</div>
                                            </button>
                                            <button onclick="makeDecision('risk')" class="bg-orange-600 hover:bg-orange-700 p-4 rounded-lg font-bold">
                                                ARRIESGAR
                                                <div class="text-xs font-normal mt-1">Mantener actuales</div>
                                            </button>
                                        </div>
                                    ` : gameData.pendingDecision.type === 'damage-repair' ? `
                                        <p class="text-gray-300 mb-4">
                                            Has sufrido daño en <span class="text-red-400 font-bold">${damageTypes[gameData.pendingDecision.data.damageType].name}</span> con severidad del <span class="text-yellow-400 font-bold">${gameData.pendingDecision.data.severity}%</span>.
                                        </p>
                                        <p class="text-sm text-gray-400 mb-6">
                                            Reparación: ${gameData.pendingDecision.data.repairTime} segundos | Vuelta ${gameData.pendingDecision.data.lap}/${gameData.totalLaps}
                                        </p>
                                        <div class="grid grid-cols-2 gap-3">
                                            <button onclick="makeDecision('repair')" class="bg-green-600 hover:bg-green-700 p-4 rounded-lg font-bold">
                                                REPARAR DAÑO
                                                <div class="text-xs font-normal mt-1">-${gameData.pendingDecision.data.repairTime}s tiempo</div>
                                            </button>
                                            <button onclick="makeDecision('continue-damaged')" class="bg-red-600 hover:bg-red-700 p-4 rounded-lg font-bold">
                                                CONTINUAR DAÑADO
                                                <div class="text-xs font-normal mt-1">Bajo rendimiento</div>
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        ${gameData.raceMode === 'interactive' && gameData.racePhase === 'race' && gameData.isProcessing && !gameData.pendingDecision ? `
                            <div class="fixed bottom-6 left-6 right-6 md:left-auto md:w-96 bg-gray-900/95 border-2 border-blue-500 rounded-lg p-4 max-h-96 animate-fade-in z-40 overflow-hidden flex flex-col">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <div class="text-sm font-bold text-blue-300">CARRERA EN PROGRESO</div>
                                        <div class="text-2xl font-bold text-white">Vuelta ${gameData.currentLapView || 0}/${gameData.totalLaps || 0}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-400">Posición actual</div>
                                        <div class="text-xl font-bold text-yellow-400">
                                            P${(() => {
                                                const classification = gameData.raceClassification || [];
                                                const playerIdx = classification.findIndex(d => d.isPlayer);
                                                return playerIdx >= 0 ? playerIdx + 1 : '-';
                                            })()}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="w-full bg-gray-700 rounded-full h-2 mb-3">
                                    <div class="bg-blue-500 h-2 rounded-full transition-all" style="width: ${((gameData.currentLapView || 0) / (gameData.totalLaps || 1)) * 100}%"></div>
                                </div>
                                
                                <div class="flex-1 overflow-y-auto space-y-1 min-h-0">
                                    <div class="text-xs font-bold text-yellow-400 mb-2 sticky top-0 bg-gray-900 pb-1">
                                        EVENTOS DE CARRERA
                                    </div>
                                    ${gameData.raceEvents && gameData.raceEvents.length > 0 ? 
                                        gameData.raceEvents.slice().reverse().slice(0, 10).map(event => `
                                            <div class="flex items-center gap-2 text-xs p-2 bg-gray-800 rounded ${
                                                event.type === 'player-decision' ? 'border-l-2 border-blue-400' :
                                                event.type === 'damage' ? 'border-l-2 border-red-400' :
                                                event.type === 'safety-car' ? 'border-l-2 border-yellow-400' : ''
                                            }">
                                                <span class="text-lg flex-shrink-0">${event.icon}</span>
                                                <span class="text-gray-500 flex-shrink-0">V${event.lap}</span>
                                                <span class="text-gray-300 flex-1 text-xs leading-tight">${event.text}</span>
                                            </div>
                                        `).join('') 
                                        : '<div class="text-gray-500 text-xs text-center py-2">Sin eventos aún...</div>'
                                    }
                                </div>
                            </div>
                        ` : ''}
                        
                    </div> <!-- Cierre de max-w-7xl -->

                </div>
                
                `;
            } else if (gameData.state === 'season-end') {
                const standings = gameData.finalStandings || [];
                const playerPos = gameData.seasonPlayerPosition || 1;
                const isChampion = playerPos === 1;
                
                app.innerHTML = `
                <div class="min-h-screen racing-bg p-4">
                    <div class="max-w-4xl mx-auto fade-in">
                        <div class="text-center mb-8">
                            ${isChampion ? `
                                <h1 class="text-6xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-yellow-500 to-yellow-600 animate-pulse">
                                    ¡CAMPEÓN DEL MUNDO!
                                </h1>
                                <div class="text-3xl text-yellow-500 mb-4">🏆 TEMPORADA 2025 🏆</div>
                            ` : `
                                <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">
                                    FIN DE TEMPORADA
                                </h1>
                                <div class="text-2xl ${playerPos <= 3 ? 'text-yellow-500' : playerPos <= 10 ? 'text-blue-500' : 'text-gray-400'} mb-4">
                                    Posición Final: ${playerPos}º
                                </div>
                            `}
                        </div>
                        
                        <div class="racing-border rounded-xl p-6 mb-6">
                            <h2 class="text-2xl font-bold mb-4 text-yellow-500">CLASIFICACIÓN FINAL</h2>
                            <div class="space-y-2">
                                ${standings.slice(0, 10).map((driver, idx) => `
                                    <div class="p-3 rounded-lg flex justify-between items-center ${
                                        driver.isPlayer ? 'bg-blue-900/50 border-2 border-blue-400' : 
                                        idx === 0 ? 'bg-yellow-900/30' :
                                        idx === 1 ? 'bg-gray-700/30' :
                                        idx === 2 ? 'bg-orange-900/30' : 'bg-gray-800'
                                    }">
                                        <div class="flex items-center gap-3">
                                            <span class="font-bold text-2xl ${
                                                idx === 0 ? 'text-yellow-400' :
                                                idx === 1 ? 'text-gray-300' :
                                                idx === 2 ? 'text-orange-400' : 'text-white'
                                            }">${idx + 1}º</span>
                                            <div 
                                                class="w-4 h-4 rounded-full"
                                                style="background-color: ${teams[driver.team]?.color || '#666'}"
                                            ></div>
                                            <div>
                                                <span class="font-semibold ${driver.isPlayer ? 'text-blue-300' : 'text-white'}">
                                                    ${driver.isPlayer ? countries[gameData.player.nationality] + ' ' : ''}${driver.name}
                                                </span>
                                                <div class="text-xs text-gray-400">${teams[driver.team]?.name}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-yellow-400">${driver.points} pts</div>
                                            <div class="text-xs text-gray-400">${driver.wins} victorias</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="racing-border rounded-xl p-6 mb-6">
                            <h3 class="text-xl font-bold mb-4 text-yellow-500">ESTADÍSTICAS DE LA TEMPORADA</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-900 p-4 rounded-lg text-center">
                                    <div class="text-3xl font-bold text-yellow-400">${gameData.raceResults.filter(r => r.position === 1).length}</div>
                                    <div class="text-sm text-gray-400">Victorias</div>
                                </div>
                                <div class="bg-gray-900 p-4 rounded-lg text-center">
                                    <div class="text-3xl font-bold text-blue-400">${gameData.raceResults.filter(r => r.position <= 3).length}</div>
                                    <div class="text-sm text-gray-400">Podios</div>
                                </div>
                                <div class="bg-gray-900 p-4 rounded-lg text-center">
                                    <div class="text-3xl font-bold text-green-400">${gameData.raceResults.filter(r => r.position <= 10).length}</div>
                                    <div class="text-sm text-gray-400">Puntos</div>
                                </div>
                                <div class="bg-gray-900 p-4 rounded-lg text-center">
                                    <div class="text-3xl font-bold text-purple-400">${(gameData.raceResults.reduce((sum, r) => sum + r.position, 0) / gameData.raceResults.length).toFixed(1)}</div>
                                    <div class="text-sm text-gray-400">Posición Media</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="racing-border rounded-xl p-6 mb-6">
                            <h3 class="text-xl font-bold mb-4 text-yellow-500">VS COMPAÑERO DE EQUIPO</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span>Clasificaciones:</span>
                                    <span class="font-bold ${teammateComparison.qualifyingBattles.player > teammateComparison.qualifyingBattles.teammate ? 'text-green-400' : 'text-red-400'}">
                                        ${teammateComparison.qualifyingBattles.player} - ${teammateComparison.qualifyingBattles.teammate}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Carreras:</span>
                                    <span class="font-bold ${teammateComparison.raceBattles.player > teammateComparison.raceBattles.teammate ? 'text-green-400' : 'text-red-400'}">
                                        ${teammateComparison.raceBattles.player} - ${teammateComparison.raceBattles.teammate}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Diferencia de puntos:</span>
                                    <span class="font-bold ${teammateComparison.pointsGap > 0 ? 'text-green-400' : 'text-red-400'}">
                                        ${teammateComparison.pointsGap > 0 ? '+' : ''}${teammateComparison.pointsGap}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="gameData.state = 'main-menu'; render();" class="bg-gray-600 hover:bg-gray-700 p-4 rounded-lg font-semibold transition-all">
                                MENÚ PRINCIPAL
                            </button>
                            <button onclick="startNewSeason()" class="btn-primary glow-red p-4 rounded-lg font-bold transition-all">
                                NUEVA TEMPORADA
                            </button>
                        </div>
                    </div>
                </div>
                `;
            } else if (gameData.state === 'team-offers') {
                const offers = generateTeamOffers(gameData.player.reputation, gameData.selectedTeam);
                
                app.innerHTML = `
                <div class="min-h-screen racing-bg p-4">
                    <div class="max-w-4xl mx-auto fade-in">
                        <div class="text-center mb-8">
                            <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">
                                OFERTAS DE EQUIPOS
                            </h1>
                            <p class="text-xl text-gray-300">Temporada ${gameData.player.championships > 0 ? gameData.player.championships + 1 : 2}</p>
                            <p class="text-lg text-gray-400 mt-2">Tu reputación: ${gameData.player.reputation}/100</p>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            ${offers.map(offer => {
                                const salaryFormatted = (offer.salary / 1000).toFixed(0);
                                return `
                                <div class="racing-border rounded-xl p-6 card-hover ${offer.isCurrentTeam ? 'border-blue-500' : ''}">
                                    <div class="flex items-center mb-4">
                                        <div class="w-10 h-10 rounded-full mr-4 team-badge" style="background-color: ${offer.team.color}"></div>
                                        <div>
                                            <h3 class="text-xl font-bold">${offer.team.name}</h3>
                                            ${offer.isCurrentTeam ? '<span class="text-xs text-blue-400">Tu equipo actual</span>' : ''}
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                                        <div class="bg-gray-900 p-3 rounded-lg">
                                            <div class="text-gray-400 mb-1">Potencia</div>
                                            <div class="font-bold">${offer.team.power}/100</div>
                                        </div>
                                        <div class="bg-gray-900 p-3 rounded-lg">
                                            <div class="text-gray-400 mb-1">Aerodinámica</div>
                                            <div class="font-bold">${offer.team.aerodynamics}/100</div>
                                        </div>
                                        <div class="bg-gray-900 p-3 rounded-lg">
                                            <div class="text-gray-400 mb-1">Fiabilidad</div>
                                            <div class="font-bold">${offer.team.reliability}/100</div>
                                        </div>
                                        <div class="bg-gray-900 p-3 rounded-lg">
                                            <div class="text-gray-400 mb-1">Reputación</div>
                                            <div class="font-bold">${offer.team.reputation}/100</div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gray-900 p-4 rounded-lg mb-4">
                                        <div class="flex justify-between mb-2">
                                            <span class="text-gray-400">Salario anual:</span>
                                            <span class="text-green-400 font-bold">$${salaryFormatted}K</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Duración:</span>
                                            <span class="text-yellow-400 font-bold">${offer.duration} ${offer.duration === 1 ? 'año' : 'años'}</span>
                                        </div>
                                    </div>
                                    
                                    <button onclick="acceptTeamOffer('${offer.teamId}')" class="w-full ${offer.isCurrentTeam ? 'bg-blue-600 hover:bg-blue-700' : 'btn-primary glow-red'} p-3 rounded-lg font-semibold transition-all">
                                        ${offer.isCurrentTeam ? 'RENOVAR CONTRATO' : 'ACEPTAR OFERTA'}
                                    </button>
                                </div>
                            `}).join('')}
                        </div>
                        
                        ${offers.length === 1 ? `
                            <div class="text-center text-gray-400 mb-6">
                                <p>No hay otras ofertas disponibles esta temporada.</p>
                                <p class="text-sm mt-2">Mejora tu rendimiento para atraer equipos mejores.</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAudioSettings();
            loadTheme();
            if (audioSettings.musicEnabled) {
                // Iniciar música con interacción del usuario
                document.body.addEventListener('click', function initOnClick() {
                    initAudio();
                    startMusic();
                    document.body.removeEventListener('click', initOnClick);
                }, { once: true });
            }
            setTimeout(() => render(), 500);
        });
        
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) closeModal();
        });
    </script>
</body>
</html>
