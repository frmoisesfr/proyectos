<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Simulator 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Racing+Sans+One&family=Rajdhani:wght@400;600;700&display=swap');
        
        :root {
            --f1-red: #e10600;
            --f1-dark: #15151e;
            --f1-silver: #c0c0c0;
            --f1-gold: #ffd700;
        }
        
        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
            overflow-x: hidden;
        }
        
        h1, h2, h3 {
            font-family: 'Racing Sans One', cursive;
            letter-spacing: 2px;
        }
        
        button {
            min-height: 48px;
            touch-action: manipulation;
        }
   
        .racing-bg {
            position: relative;
            z-index: 1;
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(225, 6, 0, 0.03) 10px,
                    rgba(225, 6, 0, 0.03) 20px
                );
        }
        
        .racing-border {
            position: relative;
            border: 2px solid transparent;
            background: linear-gradient(#1a1a2e, #1a1a2e) padding-box,
                        linear-gradient(45deg, var(--f1-red), var(--f1-gold), var(--f1-red)) border-box;
        }
        
        .glow-red {
            box-shadow: 0 0 20px rgba(225, 6, 0, 0.5),
                        0 0 40px rgba(225, 6, 0, 0.3);
        }
        
        .news-bar {
            background: linear-gradient(90deg, 
                rgba(225,6,0,0.9) 0%, 
                rgba(20,20,30,0.95) 50%, 
                rgba(225,6,0,0.9) 100%);
            border-top: 2px solid var(--f1-red);
            border-bottom: 2px solid var(--f1-red);
            overflow: hidden;
        }
        
        .news-ticker {
            display: inline-block;
            animation: scroll-left 20s linear infinite;
            padding-left: 100%;
            font-weight: 700;
            font-size: 1rem;
            white-space: nowrap;
            text-transform: uppercase;
        }
        
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        
        .spinner {
            border-top-color: var(--f1-red);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(225, 6, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(225, 6, 0, 0.8); }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(225, 6, 0, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--f1-red) 0%, #b30500 100%);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 95%;
            max-height: 90%;
            overflow-y: auto;
            border: 2px solid var(--f1-red);
            box-shadow: 0 0 50px rgba(225, 6, 0, 0.5);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, 
                var(--f1-red) 0%, 
                var(--f1-gold) 50%, 
                var(--f1-red) 100%);
            transition: width 0.3s ease;
        }
        
        .tire-soft { color: #ef4444; }
        .tire-medium { color: #f59e0b; }
        .tire-hard { color: #e5e7eb; }
        
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb { background: var(--f1-red); border-radius: 5px; }
        
        .team-badge {
            border-radius: 50%;
            box-shadow: 0 0 15px currentColor;
        }
        
        .pos-1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #000; font-weight: 900; }
        .pos-2 { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); color: #000; font-weight: 900; }
        .pos-3 { background: linear-gradient(135deg, #cd7f32 0%, #e49b5f 100%); color: #fff; font-weight: 900; }
        
        .stat-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .stat-high { background: #10b981; color: white; }
        .stat-medium { background: #f59e0b; color: white; }
        .stat-low { background: #ef4444; color: white; }
        
        /* Circuito visual */
        .circuit-map {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f1419 100%);
            border: 2px solid #e10600;
            border-radius: 12px;
            padding: 20px;
        }
        
        .circuit-path {
            stroke: #e10600;
            stroke-width: 8;
            fill: none;
            filter: drop-shadow(0 0 10px rgba(225, 6, 0, 0.5));
        }
        
        .circuit-inner {
            stroke: #4a4a4a;
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 5,5;
        }
        
        .start-finish {
            fill: #10b981;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .direction-arrow {
            fill: #ffd700;
            animation: moveArrow 2s ease-in-out infinite;
        }
        
        @keyframes moveArrow {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(5px); }
        }
                
        @media (max-width: 640px) {
            .news-ticker { font-size: 0.875rem; }
            h1 { font-size: 2rem; }
            .main-game-grid {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 1024px) {
            .main-game-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        /* Sistema de pestañas */
        .tab-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #374151;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab-button.active {
            color: #e10600;
            border-bottom-color: #e10600;
        }

        .tab-button:hover {
            color: #f59e0b;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Layout más compacto */
        .compact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .compact-stat {
            background: #1f2937;
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .compact-stat-label {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 0.25rem;
        }

        .compact-stat-value {
            font-size: 1rem;
            font-weight: bold;
        }

        /* Mapa de circuito más pequeño */
        .circuit-map-compact {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f1419 100%);
            border: 2px solid #e10600;
            border-radius: 0.75rem;
            padding: 0.75rem;
            max-height: 200px;
        }

        .circuit-map-compact svg {
            max-height: 150px;
        }

        /* Neumáticos compactos */
        .tire-compact {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background: #1f2937;
            border-radius: 0.5rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tire-compact.selected {
            border-color: #3b82f6;
            background: #1e3a8a;
        }

        .tire-compact:hover {
            background: #374151;
        }

        /* Reducir espaciado general */
        .racing-border {
            padding: 1rem;
        }

        @media (min-width: 640px) {
            .main-game-grid {
                display: grid;
                grid-template-columns: 1.5fr 1fr 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>
<body class="min-h-screen text-white">
 
    <div id="app">
        <div class="text-center py-20 px-4">
            <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-600 via-yellow-500 to-red-600">
                CARGANDO F1 SIMULATOR...
            </h1>
            <div class="w-16 h-16 border-4 border-red-600 border-t-transparent rounded-full spinner mx-auto"></div>
        </div>
    </div>

    <div id="standingsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">
                    CLASIFICACIÓN DE PILOTOS
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="standingsContent"></div>
        </div>
    </div>

    <div id="raceTimesModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">
                    TIEMPOS DE CARRERA
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="raceTimesContent"></div>
        </div>
    </div>

    <div id="achievementsModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-500 to-orange-500">
                    LOGROS
                </h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-red-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="achievementsContent"></div>
        </div>
    </div>

    <script>
        let gameData = {
            state: 'main-menu',
            player: {
                name: '',
                age: 20,
                nationality: '',
                experience: 0,
                championships: 0,
                reputation: 50,
                points: 0,
                skills: {
                    speed: 50,
                    control: 50,
                    strategy: 50,
                    overtaking: 50,
                    streetSpecialist: 50,
                    ovalSpecialist: 50,
                    mountainSpecialist: 50,
                    rainMastery: 50
                }
            },
            selectedTeam: null,
            currentRace: 0,
            racePhase: 'practice',
            trainingDone: false,
            qualifyingPos: null,
            raceResults: [],
            raceClassification: [],
            raceTimes: [],
            isProcessing: false,
            selectedTireCompound: 'medium',
            pitStops: 0,
            tireWear: 0,
            currentWeather: 'sunny',
            driverStandings: {},
            devBudget: 500, // Nuevo
            carUpgrades: { // Nuevo
                power: 0,
                aerodynamics: 0,
                reliability: 0,
                chassis: 0
            },
            pitStopPlanned: false, // Nuevo
            pitStopLap: 0, // Nuevo
            pitStopNewTire: 'medium', // Nuevo
            currentLap: 0, // Nuevo
            totalLaps: 0, // Nuevo
            achievements: {}, // Nuevo
            newAchievements: [] // Nuevo - para mostrar logros recién desbloqueados
        };

        // Sistema de eventos aleatorios
        const raceEvents = {
            'safety-car': { 
                name: 'Safety Car', 
                icon: '🚨', 
                probability: 0.15,
                effect: (classification) => {
                    // Comprime el pelotón
                    classification.forEach((driver, idx) => {
                        driver.score += (20 - idx) * 0.5;
                    });
                    return 'Safety Car desplegado - El pelotón se comprime';
                }
            },
            'mechanical-failure': { 
                name: 'Fallo Mecánico', 
                icon: '⚙️', 
                probability: 0.08,
                effect: (classification, playerName) => {
                    const randomDriver = classification[Math.floor(Math.random() * Math.min(10, classification.length))];
                    if (randomDriver.name === playerName && Math.random() > 0.3) {
                        randomDriver.score -= 25;
                        return `¡Tu coche ha sufrido un problema mecánico!`;
                    } else if (randomDriver.name !== playerName) {
                        randomDriver.score -= 30;
                        return `${randomDriver.name} abandona por fallo mecánico`;
                    }
                    return null;
                }
            },
            'collision': { 
                name: 'Colisión', 
                icon: '💥', 
                probability: 0.10,
                effect: (classification, playerName) => {
                    const affectedDrivers = classification.slice(5, 12);
                    if (affectedDrivers.length > 0) {
                        const victim = affectedDrivers[Math.floor(Math.random() * affectedDrivers.length)];
                        victim.score -= 15;
                        if (victim.name === playerName) {
                            return '¡Has estado involucrado en un incidente!';
                        }
                        return `Incidente en pista - ${victim.name} afectado`;
                    }
                    return null;
                }
            },
            'perfect-lap': { 
                name: 'Vuelta Perfecta', 
                icon: '⭐', 
                probability: 0.12,
                effect: (classification, playerName) => {
                    const topDrivers = classification.slice(0, 5);
                    const luckyDriver = topDrivers[Math.floor(Math.random() * topDrivers.length)];
                    luckyDriver.score += 8;
                    if (luckyDriver.name === playerName) {
                        return '¡Has conseguido una vuelta perfecta!';
                    }
                    return `${luckyDriver.name} establece vuelta rápida`;
                }
            },
            'weather-change': { 
                name: 'Cambio de Clima', 
                icon: '🌦️', 
                probability: 0.08,
                effect: (classification, playerName, gameData) => {
                    const tire = tireCompounds[gameData.selectedTireCompound];
                    const isRaining = Math.random() > 0.5;
                    
                    if (isRaining && !tire.wetWeather) {
                        // Los que tienen neumáticos secos sufren
                        classification.forEach(driver => {
                            if (driver.name === playerName) {
                                driver.score -= 12;
                            } else {
                                driver.score -= Math.random() * 10;
                            }
                        });
                        return '¡Empieza a llover! Neumáticos incorrectos penalizan';
                    } else if (!isRaining && tire.wetWeather) {
                        const playerDriver = classification.find(d => d.name === playerName);
                        if (playerDriver) playerDriver.score -= 8;
                        return 'La pista se seca - Neumáticos de lluvia ya no son óptimos';
                    }
                    return null;
                }
            }
        };

        // Datos del compañero de equipo
        let teammateComparison = {
            qualifyingBattles: { player: 0, teammate: 0 },
            raceBattles: { player: 0, teammate: 0 },
            pointsGap: 0
        };

        const teams = {
            'red-bull': { name: 'Red Bull Racing', color: '#1E3A8A', drivers: ['Max Verstappen', 'Sergio Pérez'], power: 95, reputation: 95, aerodynamics: 92, reliability: 90 },
            'ferrari': { name: 'Scuderia Ferrari', color: '#DC2626', drivers: ['Charles Leclerc', 'Carlos Sainz'], power: 90, reputation: 90, aerodynamics: 94, reliability: 85 },
            'mercedes': { name: 'Mercedes-AMG', color: '#06B6D4', drivers: ['Lewis Hamilton', 'George Russell'], power: 88, reputation: 88, aerodynamics: 90, reliability: 92 },
            'mclaren': { name: 'McLaren', color: '#F97316', drivers: ['Lando Norris', 'Oscar Piastri'], power: 85, reputation: 85, aerodynamics: 88, reliability: 87 },
            'aston-martin': { name: 'Aston Martin', color: '#059669', drivers: ['Fernando Alonso', 'Lance Stroll'], power: 82, reputation: 82, aerodynamics: 85, reliability: 88 },
            'alpine': { name: 'Alpine', color: '#3B82F6', drivers: ['Pierre Gasly', 'Esteban Ocon'], power: 80, reputation: 80, aerodynamics: 82, reliability: 84 },
            'williams': { name: 'Williams', color: '#0EA5E9', drivers: ['Alex Albon', 'Logan Sargeant'], power: 75, reputation: 70, aerodynamics: 78, reliability: 82 },
            'alphatauri': { name: 'AlphaTauri', color: '#475569', drivers: ['Yuki Tsunoda', 'Nyck de Vries'], power: 78, reputation: 72, aerodynamics: 80, reliability: 80 },
            'alfa-romeo': { name: 'Alfa Romeo', color: '#991B1B', drivers: ['Valtteri Bottas', 'Zhou Guanyu'], power: 77, reputation: 70, aerodynamics: 79, reliability: 78 },
            'haas': { name: 'Haas F1', color: '#EF4444', drivers: ['Kevin Magnussen', 'Nico Hulkenberg'], power: 73, reputation: 65, aerodynamics: 75, reliability: 76 }
        };

        const circuitTypes = {
            'street': { name: 'Urbano', color: 'bg-gray-600', skillBonus: 'streetSpecialist', aeroImportance: 0.6, powerImportance: 0.4 },
            'oval': { name: 'Óvalo', color: 'bg-red-600', skillBonus: 'ovalSpecialist', aeroImportance: 0.3, powerImportance: 0.7 },
            'mountain': { name: 'Montaña', color: 'bg-green-600', skillBonus: 'mountainSpecialist', aeroImportance: 0.8, powerImportance: 0.2 },
            'traditional': { name: 'Tradicional', color: 'bg-blue-600', skillBonus: null, aeroImportance: 0.5, powerImportance: 0.5 }
        };

        const weatherConditions = {
            'sunny': { name: 'Soleado', icon: '☀️', modifier: 0, color: 'text-yellow-400', tireWearMultiplier: 1.0 },
            'cloudy': { name: 'Nublado', icon: '☁️', modifier: -2, color: 'text-gray-400', tireWearMultiplier: 0.9 },
            'rainy': { name: 'Lluvia', icon: '🌧️', modifier: -15, color: 'text-blue-400', skillBonus: 'rainMastery', tireWearMultiplier: 0.7 },
            'windy': { name: 'Viento', icon: '💨', modifier: -8, color: 'text-green-400', tireWearMultiplier: 1.1 },
            'hot': { name: 'Calor Extremo', icon: '🔥', modifier: -5, color: 'text-red-400', tireWearMultiplier: 1.3 }
        };

        const tireCompounds = {
            'soft': { name: 'Blando', color: 'text-red-400', speed: 18, durability: 20, degradation: 12, icon: '🔴', grip: 95 },
            'medium': { name: 'Medio', color: 'text-yellow-400', speed: 10, durability: 35, degradation: 6, icon: '🟡', grip: 85 },
            'hard': { name: 'Duro', color: 'text-gray-400', speed: 4, durability: 55, degradation: 3, icon: '⚪', grip: 75 },
            'intermediate': { name: 'Intermedio', color: 'text-green-400', speed: 8, durability: 40, degradation: 4, icon: '🟢', wetWeather: true, grip: 90 },
            'wet': { name: 'Lluvia', color: 'text-blue-400', speed: 0, durability: 45, degradation: 2, icon: '🔵', wetWeather: true, grip: 95 }
        };

        const calendar = [
            { name: 'GP de Bahrein', country: 'Bahrein', difficulty: 3, type: 'traditional', rainChance: 0.05, laps: 57 },
            { name: 'GP de Arabia Saudí', country: 'Arabia Saudí', difficulty: 4, type: 'street', rainChance: 0.02, laps: 50 },
            { name: 'GP de España', country: 'España', difficulty: 2, type: 'traditional', rainChance: 0.25, laps: 66 },
            { name: 'GP de Mónaco', country: 'Mónaco', difficulty: 5, type: 'street', rainChance: 0.15, laps: 78 },
            { name: 'GP de Italia', country: 'Italia', difficulty: 3, type: 'oval', rainChance: 0.20, laps: 53 },
            { name: 'GP de Abu Dhabi', country: 'EAU', difficulty: 4, type: 'traditional', rainChance: 0.01, laps: 58 },
            { name: 'GP de Montecarlo', country: 'Montecarlo', difficulty: 5, type: 'mountain', rainChance: 0.30, laps: 44 },
            { name: 'GP de Silverstone', country: 'Reino Unido', difficulty: 4, type: 'traditional', rainChance: 0.40, laps: 52 }
        ];

        // ============ SISTEMA DE DESARROLLO DEL COCHE ============
        const carDevelopment = {
            power: { name: 'Motor', level: 0, maxLevel: 10, cost: 100, improvement: 2 },
            aerodynamics: { name: 'Aerodinámica', level: 0, maxLevel: 10, cost: 120, improvement: 2 },
            reliability: { name: 'Fiabilidad', level: 0, maxLevel: 10, cost: 80, improvement: 2 },
            chassis: { name: 'Chasis', level: 0, maxLevel: 10, cost: 100, improvement: 1.5 }
        };

        // ============ SISTEMA DE ESTRATEGIA DE NEUMÁTICOS ============
        const pitStopStrategy = {
            planned: false,
            targetLap: 0,
            newCompound: 'medium'
        };

        // ============ OFERTAS DE EQUIPOS ============
        function generateTeamOffers(playerReputation, currentTeamId) {
            const offers = [];
            const playerPoints = gameData.player.points;
            const playerWins = gameData.raceResults.filter(r => r.position === 1).length;
            
            // Siempre incluir equipo actual
            const currentTeam = teams[currentTeamId];
            offers.push({
                teamId: currentTeamId,
                team: currentTeam,
                salary: 500000 + (playerPoints * 1000),
                duration: 2,
                isCurrentTeam: true
            });
            
            // Ofertas basadas en rendimiento
            Object.entries(teams).forEach(([teamId, team]) => {
                if (teamId === currentTeamId) return;
                
                const teamTier = team.reputation;
                const playerTier = playerReputation;
                const reputationDiff = teamTier - playerTier;
                
                // Probabilidad de oferta basada en rendimiento
                let offerChance = 0;
                if (playerWins >= 5) offerChance = 0.8;
                else if (playerWins >= 3) offerChance = 0.6;
                else if (playerPoints >= 100) offerChance = 0.4;
                else if (playerPoints >= 50) offerChance = 0.2;
                
                // Ajustar por diferencia de reputación
                if (reputationDiff > 20) offerChance *= 0.3;
                else if (reputationDiff > 10) offerChance *= 0.6;
                else if (reputationDiff < -10) offerChance = 0.9;
                
                if (Math.random() < offerChance) {
                    offers.push({
                        teamId: teamId,
                        team: team,
                        salary: (team.reputation * 10000) + (playerPoints * 800),
                        duration: reputationDiff > 0 ? 1 : 2
                    });
                }
            });
            
            return offers;
        }

        const driverSkills = {
            'Max Verstappen': 98, 'Sergio Pérez': 85, 'Charles Leclerc': 95, 'Carlos Sainz': 88,
            'Lewis Hamilton': 96, 'George Russell': 87, 'Lando Norris': 90, 'Oscar Piastri': 84,
            'Fernando Alonso': 94, 'Lance Stroll': 80, 'Pierre Gasly': 86, 'Esteban Ocon': 83,
            'Alex Albon': 82, 'Logan Sargeant': 75, 'Yuki Tsunoda': 81, 'Nyck de Vries': 78,
            'Valtteri Bottas': 85, 'Zhou Guanyu': 79, 'Kevin Magnussen': 80, 'Nico Hulkenberg': 83
        };

        // Lista de países con banderas
        const countries = {
            'España': '🇪🇸',
            'Estados Unidos': '🇺🇸',
            'Reino Unido': '🇬🇧',
            'Alemania': '🇩🇪',
            'Francia': '🇫🇷',
            'Italia': '🇮🇹',
            'Brasil': '🇧🇷',
            'México': '🇲🇽',
            'Argentina': '🇦🇷',
            'Japón': '🇯🇵',
            'China': '🇨🇳',
            'Canadá': '🇨🇦',
            'Australia': '🇦🇺',
            'Países Bajos': '🇳🇱',
            'Bélgica': '🇧🇪',
            'Suiza': '🇨🇭',
            'Austria': '🇦🇹',
            'Mónaco': '🇲🇨',
            'Rusia': '🇷🇺',
            'India': '🇮🇳'
        };

        // ============ SISTEMA DE LOGROS ============
        const achievements = {
            'first-win': { 
                name: 'Primera Victoria', 
                description: 'Gana tu primera carrera', 
                icon: '🏆', 
                unlocked: false,
                check: (data) => data.raceResults.some(r => r.position === 1)
            },
            'first-pole': { 
                name: 'Primera Pole', 
                description: 'Consigue tu primera pole position', 
                icon: '🥇', 
                unlocked: false,
                check: (data) => data.raceResults.some(r => r.qualifyingPos === 1)
            },
            'podium-streak': { 
                name: 'Racha de Podios', 
                description: 'Termina en el podio 3 carreras consecutivas', 
                icon: '🔥', 
                unlocked: false,
                check: (data) => {
                    let streak = 0;
                    for (let i = data.raceResults.length - 1; i >= 0; i--) {
                        if (data.raceResults[i].position <= 3) {
                            streak++;
                            if (streak >= 3) return true;
                        } else {
                            streak = 0;
                        }
                    }
                    return false;
                }
            },
            'win-streak': { 
                name: 'Imparable', 
                description: 'Gana 3 carreras consecutivas', 
                icon: '⚡', 
                unlocked: false,
                check: (data) => {
                    let streak = 0;
                    for (let i = data.raceResults.length - 1; i >= 0; i--) {
                        if (data.raceResults[i].position === 1) {
                            streak++;
                            if (streak >= 3) return true;
                        } else {
                            streak = 0;
                        }
                    }
                    return false;
                }
            },
            'rain-master': { 
                name: 'Maestro de la Lluvia', 
                description: 'Gana una carrera bajo lluvia', 
                icon: '🌧️', 
                unlocked: false,
                check: (data) => data.raceResults.some(r => r.position === 1 && r.weather === 'rainy')
            },
            'monaco-winner': { 
                name: 'Rey de Mónaco', 
                description: 'Gana en Mónaco', 
                icon: '👑', 
                unlocked: false,
                check: (data) => data.raceResults.some(r => r.position === 1 && r.race === 'GP de Mónaco')
            },
            'comeback-king': { 
                name: 'Rey de las Remontadas', 
                description: 'Gana una carrera saliendo desde P10 o peor', 
                icon: '🚀', 
                unlocked: false,
                check: (data) => data.raceResults.some(r => r.position === 1 && r.qualifyingPos >= 10)
            },
            'perfect-weekend': { 
                name: 'Fin de Semana Perfecto', 
                description: 'Pole position y victoria en la misma carrera', 
                icon: '💎', 
                unlocked: false,
                check: (data) => data.raceResults.some(r => r.position === 1 && r.qualifyingPos === 1)
            },
            'champion': { 
                name: 'Campeón del Mundo', 
                description: 'Gana un campeonato', 
                icon: '🏅', 
                unlocked: false,
                check: (data) => data.player.championships >= 1
            },
            'points-master': { 
                name: 'Acumulador de Puntos', 
                description: 'Consigue 200 puntos en una temporada', 
                icon: '💯', 
                unlocked: false,
                check: (data) => {
                    const seasonPoints = data.raceResults.reduce((sum, r) => sum + r.points, 0);
                    return seasonPoints >= 200;
                }
            },
            'development-guru': { 
                name: 'Gurú del Desarrollo', 
                description: 'Maximiza todas las mejoras del coche', 
                icon: '🔧', 
                unlocked: false,
                check: (data) => {
                    return Object.values(data.carUpgrades).every(level => level >= 10);
                }
            },
            'teammate-crusher': { 
                name: 'Dominio Total', 
                description: 'Vence a tu compañero en 7 de 8 carreras', 
                icon: '💪', 
                unlocked: false,
                check: (data) => {
                    if (!teammateComparison) return false;
                    return teammateComparison.raceBattles.player >= 7;
                }
            }
        };

        // ============ SISTEMA DE CLIMA DINÁMICO ============
        let weatherChangeEvent = null;

        function simulateWeatherChange(currentWeather, lap, totalLaps) {
            // Probabilidad de cambio aumenta en carreras largas
            const changeProbability = 0.15;
            const midRaceWindow = lap >= totalLaps * 0.3 && lap <= totalLaps * 0.7;
            
            if (midRaceWindow && Math.random() < changeProbability && !weatherChangeEvent) {
                const possibleWeathers = Object.keys(weatherConditions).filter(w => w !== currentWeather);
                const newWeather = possibleWeathers[Math.floor(Math.random() * possibleWeathers.length)];
                
                weatherChangeEvent = {
                    lap: lap,
                    from: currentWeather,
                    to: newWeather,
                    warning: lap - 2 // Avisar 2 vueltas antes
                };
                
                return weatherChangeEvent;
            }
            
            return null;
        }        

        // ============ SISTEMA DE GUARDADO ============
        function saveGame() {
            try {
                const saveData = {
                    gameData: gameData,
                    teammateComparison: teammateComparison,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('f1SimulatorSave', JSON.stringify(saveData));
                showNotification('Partida guardada correctamente', 'success');
                return true;
            } catch (error) {
                console.error('Error al guardar:', error);
                showNotification('Error al guardar la partida', 'error');
                return false;
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('f1SimulatorSave');
                if (!saved) return false;
                
                const saveData = JSON.parse(saved);
                gameData = saveData.gameData;
                teammateComparison = saveData.teammateComparison || {
                    qualifyingBattles: { player: 0, teammate: 0 },
                    raceBattles: { player: 0, teammate: 0 },
                    pointsGap: 0
                };

                // Inicializar logros si no existen
                if (!gameData.achievements) {
                    gameData.achievements = {};
                }
                if (!gameData.newAchievements) {
                    gameData.newAchievements = [];
                }
                
                showNotification('Partida cargada correctamente', 'success');
                return true;
            } catch (error) {
                console.error('Error al cargar:', error);
                showNotification('Error al cargar la partida', 'error');
                return false;
            }
        }

        function deleteSave() {
            if (confirm('¿Estás seguro de que quieres borrar tu progreso guardado?')) {
                localStorage.removeItem('f1SimulatorSave');
                showNotification('Progreso eliminado', 'info');
                return true;
            }
            return false;
        }

        function hasSavedGame() {
            return localStorage.getItem('f1SimulatorSave') !== null;
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ============ FINAL DE TEMPORADA ============
        function checkSeasonEnd() {
            return gameData.currentRace >= calendar.length;
        }

        function calculateFinalStandings() {
            const standings = [];
            
            Object.entries(gameData.driverStandings).forEach(([driver, data]) => {
                standings.push({
                    name: driver,
                    points: data.points,
                    wins: data.wins,
                    podiums: data.podiums,
                    team: data.team,
                    isPlayer: driver === gameData.player.name
                });
            });
            
            standings.sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.wins !== a.wins) return b.wins - a.wins;
                return b.podiums - a.podiums;
            });
            
            return standings;
        }

        function endSeason() {
            const finalStandings = calculateFinalStandings();
            const playerPosition = finalStandings.findIndex(d => d.isPlayer) + 1;
            
            if (playerPosition === 1) {
                gameData.player.championships++;
            }
            
            gameData.state = 'season-end';
            gameData.finalStandings = finalStandings;
            gameData.seasonPlayerPosition = playerPosition;
            
            saveGame();
            render();
        }

        function startNewSeason() {
            gameData.currentRace = 0;
            gameData.racePhase = 'practice';
            gameData.raceResults = [];
            gameData.raceClassification = [];
            gameData.raceTimes = [];
            initializeDriverStandings();
            gameData.driverStandings[gameData.player.name] = { 
                points: 0, 
                team: gameData.selectedTeam, 
                wins: 0, 
                podiums: 0 
            };
            teammateComparison = {
                qualifyingBattles: { player: 0, teammate: 0 },
                raceBattles: { player: 0, teammate: 0 },
                pointsGap: 0
            };
            gameData.currentWeather = generateWeather();
            // Mostrar ofertas de equipos
            gameData.state = 'team-offers';
            saveGame();
            render();
        }

        function acceptTeamOffer(teamId) {
            if (teamId !== gameData.selectedTeam) {
                // Cambiar de equipo, resetear mejoras del coche
                gameData.carUpgrades = { power: 0, aerodynamics: 0, reliability: 0, chassis: 0 };
                gameData.devBudget = 500;
                teams[gameData.selectedTeam].drivers[1] = 'Driver'; // Reemplazar jugador en equipo anterior
            }
            
            gameData.selectedTeam = teamId;
            teams[teamId].drivers[1] = gameData.player.name;
            
            // Ajustar reputación basada en el equipo
            const teamRep = teams[teamId].reputation;
            gameData.player.reputation = Math.min(100, Math.max(gameData.player.reputation, teamRep - 10));
            
            startNewSeason();
        }

        function renderCircuitMap(type) {
            const circuits = {
                'street': `
                    <svg viewBox="0 0 300 200" class="w-full">
                        <!-- Circuito urbano con curvas cerradas -->
                        <path class="circuit-path" d="M50,100 L80,100 L90,90 L90,60 L110,50 L150,50 L170,60 L180,80 L190,100 L210,110 L230,120 L240,140 L230,160 L210,170 L180,170 L150,165 L120,160 L90,150 L70,130 L60,110 Z"/>
                        <path class="circuit-inner" d="M58,105 L85,105 L93,95 L93,65 L110,58 L145,58 L163,68 L173,85 L183,105 L203,115 L220,125 L228,142 L220,158 L205,165 L175,165 L145,162 L118,158 L95,148 L75,132 Z"/>
                        
                        <!-- Línea de meta -->
                        <rect class="start-finish" x="48" y="95" width="8" height="10" rx="2"/>
                        <text x="35" y="92" font-size="10" fill="#10b981" font-weight="bold">META</text>
                        
                        <!-- Flechas de dirección -->
                        <path class="direction-arrow" d="M120,55 L125,50 L130,55 L125,53 Z"/>
                        <path class="direction-arrow" d="M185,90 L190,95 L185,100 L187,95 Z"/>
                        <path class="direction-arrow" d="M200,165 L195,170 L190,165 L195,167 Z"/>
                    </svg>
                `,
                'oval': `
                    <svg viewBox="0 0 300 200" class="w-full">
                        <!-- Circuito óvalo -->
                        <ellipse class="circuit-path" cx="150" cy="100" rx="120" ry="60"/>
                        <ellipse class="circuit-inner" cx="150" cy="100" rx="105" ry="48"/>
                        
                        <!-- Línea de meta -->
                        <rect class="start-finish" x="28" y="95" width="8" height="10" rx="2"/>
                        <text x="15" y="92" font-size="10" fill="#10b981" font-weight="bold">META</text>
                        
                        <!-- Flechas de dirección -->
                        <path class="direction-arrow" d="M150,35 L155,40 L145,40 Z"/>
                        <path class="direction-arrow" d="M270,100 L265,105 L265,95 Z"/>
                        <path class="direction-arrow" d="M150,165 L145,160 L155,160 Z"/>
                    </svg>
                `,
                'mountain': `
                    <svg viewBox="0 0 300 200" class="w-full">
                        <!-- Circuito de montaña con curvas pronunciadas -->
                        <path class="circuit-path" d="M50,100 Q80,80 110,90 Q140,100 150,80 Q160,60 180,70 Q200,80 220,100 Q240,120 230,145 Q220,170 190,165 Q160,160 140,170 Q120,180 100,160 Q80,140 70,120 Z"/>
                        <path class="circuit-inner" d="M58,102 Q85,85 108,93 Q135,102 147,85 Q157,68 177,75 Q195,83 213,102 Q230,118 223,142 Q215,162 188,160 Q162,157 143,165 Q125,173 105,158 Z"/>
                        
                        <!-- Línea de meta -->
                        <rect class="start-finish" x="48" y="95" width="8" height="10" rx="2"/>
                        <text x="35" y="92" font-size="10" fill="#10b981" font-weight="bold">META</text>
                        
                        <!-- Flechas de dirección -->
                        <path class="direction-arrow" d="M100,92 L105,87 L110,92 L105,90 Z"/>
                        <path class="direction-arrow" d="M155,75 L160,80 L155,85 L157,80 Z"/>
                        <path class="direction-arrow" d="M180,160 L175,165 L170,160 L175,162 Z"/>
                    </svg>
                `,
                'traditional': `
                    <svg viewBox="0 0 300 200" class="w-full">
                        <!-- Circuito tradicional mixto -->
                        <path class="circuit-path" d="M50,100 L100,100 Q120,100 130,85 Q140,70 160,70 L200,70 Q220,70 230,85 Q240,100 240,120 Q240,140 225,155 L180,155 Q160,155 150,140 L130,120 Q120,110 100,115 L70,130 Q55,135 50,120 Z"/>
                        <path class="circuit-inner" d="M58,102 L102,102 Q118,102 127,90 Q135,78 157,78 L195,78 Q212,78 220,90 Q230,102 230,120 Q230,135 220,145 L178,145 Q162,145 153,135 L133,118 Q125,112 105,117 Z"/>
                        
                        <!-- Línea de meta -->
                        <rect class="start-finish" x="48" y="95" width="8" height="10" rx="2"/>
                        <text x="35" y="92" font-size="10" fill="#10b981" font-weight="bold">META</text>
                        
                        <!-- Flechas de dirección -->
                        <path class="direction-arrow" d="M140,73 L145,78 L135,78 Z"/>
                        <path class="direction-arrow" d="M235,105 L240,110 L235,115 L237,110 Z"/>
                        <path class="direction-arrow" d="M150,148 L145,153 L140,148 L145,150 Z"/>
                    </svg>
                `
            };
            return circuits[type] || circuits['traditional'];
        }

        function getLevel() {
            return Math.floor(gameData.player.experience / 100) + 1;
        }

        function getAvailablePoints() {
            const earned = Math.floor(gameData.player.experience / 50);
            const used = Object.values(gameData.player.skills).reduce((sum, skill) => sum + (skill - 50), 0);
            return Math.max(0, earned - used);
        }

        function getPointsForPosition(pos) {
            const points = [25, 18, 15, 12, 10, 8, 6, 4, 2, 1];
            return pos <= 10 ? points[pos - 1] : 0;
        }

        function getSkillPointsForPosition(pos) {
            if (pos === 1) return 50;
            if (pos <= 3) return 40;
            if (pos <= 6) return 30;
            if (pos <= 10) return 20;
            return 10;
        }

        function generateWeather() {
            if (gameData.currentRace >= calendar.length) return 'sunny';
            const race = calendar[gameData.currentRace];
            const rand = Math.random();
            if (rand < race.rainChance) return 'rainy';
            else if (rand < race.rainChance + 0.15) return 'windy';
            else if (rand < race.rainChance + 0.25) return 'hot';
            else if (rand < race.rainChance + 0.35) return 'cloudy';
            return 'sunny';
        }

        function calculateTireWear(laps, tire, weather) {
            const baseDegradation = tire.degradation;
            const weatherMultiplier = weather.tireWearMultiplier;
            const totalWear = (laps / tire.durability) * baseDegradation * weatherMultiplier * 100;
            return Math.min(100, totalWear);
        }

        function calculatePitStops(laps, tire, weather) {
            const adjustedDurability = tire.durability / weather.tireWearMultiplier;
            const stopsNeeded = Math.ceil(laps / adjustedDurability) - 1;
            return Math.max(0, stopsNeeded);
        }

        function initializeDriverStandings() {
            gameData.driverStandings = {};
            Object.entries(teams).forEach(([teamId, team]) => {
                team.drivers.forEach(driver => {
                    gameData.driverStandings[driver] = { points: 0, team: teamId, wins: 0, podiums: 0 };
                });
            });
        }

        function newGame() {
            gameData.state = 'create-driver';
            render();
        }

        function continueGame() {
            if (loadGame()) {
                gameData.state = 'main-game';
                render();
            } else {
                alert('No se pudo cargar la partida guardada');
            }
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('show'));
        }

        function searchContracts() {
            const name = document.getElementById('player-name').value.trim();
            const age = parseInt(document.getElementById('player-age').value) || 20;
            const nationality = document.getElementById('player-nationality').value;

            if (name && nationality) {
                gameData.player.name = name;
                gameData.player.age = age;
                gameData.player.nationality = nationality;
                gameData.state = 'contract-offers';
                render();
            } else {
                alert('Por favor completa todos los campos');
            }
        }

        function signContract(teamId) {
            gameData.selectedTeam = teamId;
            teams[teamId].drivers[1] = gameData.player.name;
            gameData.state = 'main-game';
            gameData.currentWeather = generateWeather();
            gameData.devBudget = 500; // Presupuesto inicial
            gameData.carUpgrades = { power: 0, aerodynamics: 0, reliability: 0, chassis: 0 };
            initializeDriverStandings();
            gameData.driverStandings[gameData.player.name] = { points: 0, team: teamId, wins: 0, podiums: 0 };
            saveGame();
            render();
        }

        // ============ DESARROLLO DEL COCHE ============
        function getCarStats() {
            const baseTeam = teams[gameData.selectedTeam];
            return {
                power: baseTeam.power + (gameData.carUpgrades.power * carDevelopment.power.improvement),
                aerodynamics: baseTeam.aerodynamics + (gameData.carUpgrades.aerodynamics * carDevelopment.aerodynamics.improvement),
                reliability: baseTeam.reliability + (gameData.carUpgrades.reliability * carDevelopment.reliability.improvement),
                chassis: 50 + (gameData.carUpgrades.chassis * carDevelopment.chassis.improvement)
            };
        }

        function upgradeCar(component) {
            const upgrade = carDevelopment[component];
            const currentLevel = gameData.carUpgrades[component];
            const cost = upgrade.cost * (currentLevel + 1);
            
            if (currentLevel >= upgrade.maxLevel) {
                showNotification('Mejora al máximo nivel', 'info');
                return;
            }
            
            if (gameData.devBudget < cost) {
                showNotification('Presupuesto insuficiente', 'error');
                return;
            }
            
            gameData.carUpgrades[component]++;
            gameData.devBudget -= cost;
            showNotification(`${upgrade.name} mejorado a nivel ${gameData.carUpgrades[component]}`, 'success');
            saveGame();
            render();
        }

        function earnDevBudget(position) {
            const budgetEarned = Math.max(0, 150 - (position * 5));
            gameData.devBudget += budgetEarned;
            return budgetEarned;
        }

        // ============ FUNCIONES DE LOGROS ============
        function checkAchievements() {
            const newlyUnlocked = [];
            
            Object.entries(achievements).forEach(([id, achievement]) => {
                // Si ya está desbloqueado, saltar
                if (gameData.achievements[id]) return;
                
                // Verificar si se cumple la condición
                if (achievement.check(gameData)) {
                    gameData.achievements[id] = {
                        unlockedAt: new Date().toISOString(),
                        name: achievement.name,
                        icon: achievement.icon
                    };
                    newlyUnlocked.push({
                        id,
                        name: achievement.name,
                        description: achievement.description,
                        icon: achievement.icon
                    });
                }
            });
            
            if (newlyUnlocked.length > 0) {
                gameData.newAchievements = newlyUnlocked;
                showAchievementNotification(newlyUnlocked);
            }
        }

        function showAchievementNotification(achievements) {
            achievements.forEach((ach, index) => {
                setTimeout(() => {
                    const notification = document.createElement('div');
                    notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-yellow-600 to-orange-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 animate-fade-in border-2 border-yellow-400';
                    notification.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="text-4xl">${ach.icon}</div>
                            <div>
                                <div class="font-bold text-lg">¡LOGRO DESBLOQUEADO!</div>
                                <div class="text-sm">${ach.name}</div>
                                <div class="text-xs opacity-80">${ach.description}</div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        notification.style.transition = 'opacity 0.5s';
                        setTimeout(() => notification.remove(), 500);
                    }, 4000);
                }, index * 500);
            });
        }

        function getAchievementProgress() {
            const total = Object.keys(achievements).length;
            const unlocked = Object.keys(gameData.achievements).length;
            return { unlocked, total, percentage: Math.round((unlocked / total) * 100) };
        }        

        function goBack() {
            gameData.state = 'create-driver';
            render();
        }

        function upgradeSkill(skillName) {
            if (getAvailablePoints() > 0 && gameData.player.skills[skillName] < 100) {
                gameData.player.skills[skillName]++;
                render();
            }
        }

        function selectTireCompound(compound) {
            gameData.selectedTireCompound = compound;
            const race = calendar[gameData.currentRace];
            const weather = weatherConditions[gameData.currentWeather];
            const tire = tireCompounds[compound];
            gameData.tireWear = calculateTireWear(race.laps, tire, weather);
            gameData.pitStops = calculatePitStops(race.laps, tire, weather);
            render();
        }

        function conductTraining() {
            if (gameData.isProcessing || gameData.trainingDone) return;
            gameData.isProcessing = true;
            render();
            
            setTimeout(() => {
                let expGain = Math.floor(Math.random() * 30) + 30;
                const weather = weatherConditions[gameData.currentWeather];
                if (weather.skillBonus && gameData.player.skills[weather.skillBonus] > 70) {
                    expGain += 10;
                }
                gameData.player.experience += expGain;
                gameData.trainingDone = true;
                gameData.isProcessing = false;
                render();
            }, 2000);
        }

        function runQualifying() {
            if (gameData.isProcessing) return;
            gameData.racePhase = 'qualifying';
            gameData.isProcessing = true;
            render();
            
            setTimeout(() => {
                const race = calendar[gameData.currentRace];
                const circuitType = circuitTypes[race.type];
                const weather = weatherConditions[gameData.currentWeather];
                const carStats = getCarStats(); // Usar stats mejorados
                const tire = tireCompounds[gameData.selectedTireCompound];
                
                let basePerf = (gameData.player.skills.speed * 0.4) + (gameData.player.skills.control * 0.3) + (gameData.player.skills.strategy * 0.3);
                
                if (gameData.trainingDone) basePerf += 15;
                
                const carPerformance = (carStats.power * circuitType.powerImportance) + (carStats.aerodynamics * circuitType.aeroImportance);
                basePerf += carPerformance * 0.25;
                
                if (circuitType.skillBonus && gameData.player.skills[circuitType.skillBonus]) {
                    const specializationBonus = (gameData.player.skills[circuitType.skillBonus] - 50) * 0.4;
                    basePerf += specializationBonus;
                }
                
                if (weather.skillBonus && gameData.player.skills[weather.skillBonus]) {
                    const weatherBonus = (gameData.player.skills[weather.skillBonus] - 50) * 0.5;
                    basePerf += weatherBonus;
                }
                
                basePerf += tire.speed * 0.8;
                basePerf += weather.modifier;
                
                const randomness = (Math.random() - 0.5) * 15;
                const finalScore = basePerf + randomness;
                
                if (finalScore >= 90) gameData.qualifyingPos = Math.floor(Math.random() * 3) + 1;
                else if (finalScore >= 80) gameData.qualifyingPos = Math.floor(Math.random() * 5) + 4;
                else if (finalScore >= 70) gameData.qualifyingPos = Math.floor(Math.random() * 6) + 9;
                else gameData.qualifyingPos = Math.floor(Math.random() * 8) + 13;
                
                // ============ COMPARACIÓN EN CLASIFICACIÓN ============
                const teammate = teams[gameData.selectedTeam].drivers.find(d => d !== gameData.player.name);
                const teammateSkill = driverSkills[teammate] || 75;
                const teammatePos = Math.max(1, Math.min(20, Math.floor((100 - teammateSkill) / 5) + Math.floor(Math.random() * 6) - 3));
                
                if (gameData.qualifyingPos < teammatePos) {
                    teammateComparison.qualifyingBattles.player++;
                } else {
                    teammateComparison.qualifyingBattles.teammate++;
                }
                
                const expGain = gameData.qualifyingPos <= 3 ? 40 : gameData.qualifyingPos <= 6 ? 30 : 20;
                gameData.player.experience += expGain;
                gameData.isProcessing = false;
                
                saveGame(); // Auto-guardar
                render();
            }, 3000);
        }

        function startRace() {
            gameData.racePhase = 'race';
            gameData.isProcessing = true;
            render();
            setTimeout(() => simulateRace(), 2000);
        }

        function simulateRace() {
            const classification = [];
            const race = calendar[gameData.currentRace];
            const circuitType = circuitTypes[race.type];
            const weather = weatherConditions[gameData.currentWeather];
            const tire = tireCompounds[gameData.selectedTireCompound];
            const raceEventMessages = [];
            weatherChangeEvent = null;

            // Simular cambio de clima durante la carrera
            const weatherChange = simulateWeatherChange(gameData.currentWeather, Math.floor(race.laps * 0.5), race.laps);

            // Generar clasificación inicial (código existente)
            Object.entries(teams).forEach(([teamId, team]) => {
                team.drivers.forEach(driver => {
                    const isPlayer = driver === gameData.player.name;
                    let basePerf;
                    
                    if (isPlayer) {
                        const carStats = getCarStats(); // Usar stats mejorados
                        
                        const relevantSkills = [
                            gameData.player.skills.speed,
                            gameData.player.skills.control,
                            gameData.player.skills.strategy,
                            gameData.player.skills.overtaking
                        ];
                        basePerf = relevantSkills.reduce((sum, skill) => sum + skill, 0) / relevantSkills.length;
                        
                        if (gameData.trainingDone) basePerf += 12;
                        
                        if (gameData.qualifyingPos) {
                            const qualifyingBonus = Math.max(-15, (21 - gameData.qualifyingPos) * 2);
                            basePerf += qualifyingBonus;
                        }
                        
                        // Usar stats mejorados del coche
                        const carPerformance = (carStats.power * circuitType.powerImportance) + 
                                            (carStats.aerodynamics * circuitType.aeroImportance);
                        basePerf += carPerformance * 0.3;
                        
                        const reliabilityBonus = (carStats.reliability - 80) * 0.2;
                        basePerf += reliabilityBonus;
                        
                        // Bonus del chasis
                        basePerf += carStats.chassis * 0.15;
                        
                        if (circuitType.skillBonus) {
                            const specializationBonus = (gameData.player.skills[circuitType.skillBonus] - 50) * 0.6;
                            basePerf += specializationBonus;
                        }
                        
                        if (weather.skillBonus) {
                            const weatherBonus = (gameData.player.skills[weather.skillBonus] - 50) * 0.7;
                            basePerf += weatherBonus;
                        }
                        
                        const tireBonus = tire.speed * 0.9;
                        basePerf += tireBonus;

                        // Efecto de cambio de clima dinámico
                        if (weatherChange) {
                            const newWeather = weatherConditions[weatherChange.to];
                            const currentTire = tireCompounds[gameData.selectedTireCompound];
                            
                            // Si cambia a lluvia y no tienes neumáticos de lluvia
                            if (weatherChange.to === 'rainy' && !currentTire.wetWeather) {
                                basePerf -= 20;
                                raceEventMessages.push({
                                    icon: '⚠️',
                                    text: `¡Empieza a llover en vuelta ${weatherChange.lap}! Neumáticos incorrectos (-20 rendimiento)`
                                });
                            }
                            // Si deja de llover y tienes neumáticos de lluvia
                            else if (weatherChange.from === 'rainy' && currentTire.wetWeather && weatherChange.to !== 'rainy') {
                                basePerf -= 12;
                                raceEventMessages.push({
                                    icon: '☀️',
                                    text: `La pista se seca en vuelta ${weatherChange.lap}. Neumáticos de lluvia ya no son óptimos (-12)`
                                });
                            }
                            // Bonus si predijiste correctamente
                            else if (weatherChange.to === 'rainy' && currentTire.wetWeather) {
                                basePerf += 15;
                                raceEventMessages.push({
                                    icon: '🎯',
                                    text: `¡Decisión perfecta! Preparado para la lluvia (+15 rendimiento)`
                                });
                            }
                        }                        
                        
                        const pitPenalty = gameData.pitStops * 4;
                        basePerf -= pitPenalty;
                        
                        if (gameData.tireWear > 80) {
                            basePerf -= (gameData.tireWear - 80) * 0.5;
                        }
                        
                        // Sistema de pit stop estratégico
                        if (gameData.pitStopPlanned && race.laps > 30) {
                            const optimalLap = Math.floor(race.laps * 0.55);
                            const lapDifference = Math.abs(gameData.pitStopLap - optimalLap);
                            if (lapDifference < 5) {
                                basePerf += 8; // Bonus por pit stop bien calculado
                            }
                        }
                    } else {
                        basePerf = driverSkills[driver] || 75;
                        const aiTeam = teams[teamId];
                        const aiCarPerf = (aiTeam.power * circuitType.powerImportance) + 
                                        (aiTeam.aerodynamics * circuitType.aeroImportance);
                        basePerf += aiCarPerf * 0.2;
                        basePerf += (Math.random() - 0.5) * 12;
                    }
                    
                    const difficultyPenalty = race.difficulty * 2.5;
                    const weatherPenalty = Math.abs(weather.modifier) * 0.8;
                    const randomFactor = (Math.random() - 0.5) * 18;
                    
                    const finalScore = basePerf - difficultyPenalty - weatherPenalty + randomFactor;
                    
                    classification.push({ name: driver, team: teamId, score: finalScore, isPlayer });
                });
            });

            // ============ EVENTOS ALEATORIOS ============
            Object.entries(raceEvents).forEach(([eventId, event]) => {
                if (Math.random() < event.probability) {
                    const message = event.effect(classification, gameData.player.name, gameData);
                    if (message) {
                        raceEventMessages.push({ icon: event.icon, text: message });
                    }
                }
            });

            // Ordenar y asignar posiciones
            classification.sort((a, b) => b.score - a.score);
            classification.forEach((driver, index) => driver.position = index + 1);

            // Calcular resultados
            const playerResult = classification.find(d => d.isPlayer);
            const position = playerResult?.position || 20;
            const points = getPointsForPosition(position);
            const skillPoints = getSkillPointsForPosition(position);
            
            // Actualizar standings
            classification.forEach(driver => {
                const driverPoints = getPointsForPosition(driver.position);
                if (!gameData.driverStandings[driver.name]) {
                    gameData.driverStandings[driver.name] = { points: 0, team: driver.team, wins: 0, podiums: 0 };
                }
                gameData.driverStandings[driver.name].points += driverPoints;
                if (driver.position === 1) gameData.driverStandings[driver.name].wins++;
                if (driver.position <= 3) gameData.driverStandings[driver.name].podiums++;
            });
            
            // ============ COMPARACIÓN CON COMPAÑERO ============
            const teammate = teams[gameData.selectedTeam].drivers.find(d => d !== gameData.player.name);
            const teammateResult = classification.find(d => d.name === teammate);
            
            if (teammateResult) {
                if (position < teammateResult.position) {
                    teammateComparison.raceBattles.player++;
                } else {
                    teammateComparison.raceBattles.teammate++;
                }
                
                const playerPoints = gameData.driverStandings[gameData.player.name]?.points || 0;
                const teammatePoints = gameData.driverStandings[teammate]?.points || 0;
                teammateComparison.pointsGap = playerPoints - teammatePoints;
            }
            
            gameData.raceClassification = classification;
            gameData.raceTimes = [...classification];
            gameData.raceEvents = raceEventMessages;
            gameData.raceResults.push({
                race: race.name,
                position,
                points,
                qualifyingPos: gameData.qualifyingPos,
                weather: gameData.currentWeather,
                tireCompound: gameData.selectedTireCompound,
                pitStops: gameData.pitStops,
                circuitType: race.type,
                tireWear: gameData.tireWear,
                teammatePosition: teammateResult?.position || 20
            });
            
            gameData.player.experience += skillPoints;
            gameData.player.points = gameData.raceResults.reduce((sum, r) => sum + r.points, 0);
            // Ganar presupuesto de desarrollo
            const budgetEarned = earnDevBudget(position);
            gameData.raceResults[gameData.raceResults.length - 1].budgetEarned = budgetEarned;
            gameData.racePhase = 'results';
            gameData.isProcessing = false;
            
            checkAchievements(); // Verificar logros
            saveGame(); // Auto-guardar después de cada carrera
            render();
        }

        function nextRace() {
            gameData.currentRace++;
            
            // Verificar si es el final de la temporada
            if (checkSeasonEnd()) {
                endSeason();
                return;
            }
            
            gameData.racePhase = 'practice';
            gameData.trainingDone = false;
            gameData.qualifyingPos = null;
            gameData.currentWeather = generateWeather();
            gameData.selectedTireCompound = 'medium';
            gameData.tireWear = 0;
            gameData.pitStopPlanned = false;
            gameData.pitStopLap = 0;
            gameData.pitStopNewTire = 'medium';
            gameData.pitStops = 0;
            gameData.raceEvents = [];
            
            saveGame(); // Auto-guardar
            render();
        }

        function showStandings() {
            const standings = [];
            Object.entries(teams).forEach(([teamId, team]) => {
                team.drivers.forEach(driver => {
                    const isPlayer = driver === gameData.player.name;
                    let points = 0;
                    if (isPlayer) {
                        points = gameData.raceResults.reduce((sum, result) => sum + (result.points || 0), 0);
                    } else {
                        points = (gameData.driverStandings[driver] && gameData.driverStandings[driver].points) || 0;
                    }
                    standings.push({ name: driver, team: teamId, points: points, isPlayer });
                });
            });
            
            standings.sort((a, b) => b.points - a.points);
            
            const standingsHTML = standings.map((driver, index) => `
                <div class="p-3 rounded-lg flex justify-between items-center ${
                    driver.isPlayer ? 'bg-blue-900/50 border border-blue-400' : 'bg-gray-800'
                } mb-2">
                    <div class="flex items-center">
                        <span class="font-bold text-lg mr-3 ${
                            index === 0 ? 'text-yellow-400' :
                            index === 1 ? 'text-gray-300' :
                            index === 2 ? 'text-orange-400' : 'text-white'
                        }">${index + 1}º</span>
                        <div 
                            class="w-4 h-4 rounded-full mr-3"
                            style="background-color: ${teams[driver.team]?.color || '#666'}"
                        ></div>
                        <div>
                            <span class="font-semibold ${driver.isPlayer ? 'text-blue-300' : 'text-white'}">
                                ${driver.isPlayer ? countries[gameData.player.nationality] + ' ' : ''}${driver.name}
                            </span>
                            <div class="text-xs text-gray-400">${teams[driver.team]?.name || 'Sin equipo'}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-yellow-400">${driver.points} pts</div>
                        ${driver.isPlayer ? '<div class="text-xs text-blue-400">Tú</div>' : ''}
                    </div>
                </div>
            `).join('');
            
            document.getElementById('standingsContent').innerHTML = standingsHTML;
            document.getElementById('standingsModal').classList.add('show');
        }

        function showRaceTimes() {
            if (gameData.raceTimes.length === 0) return;
            
            const timesHTML = gameData.raceTimes.map((driver, index) => `
                <tr class="${driver.isPlayer ? 'bg-blue-900/50' : index % 2 === 0 ? 'bg-gray-800' : 'bg-gray-700'}">
                    <td class="px-4 py-2 font-bold ${
                        index === 0 ? 'text-yellow-400' :
                        index === 1 ? 'text-gray-300' :
                        index === 2 ? 'text-orange-400' : 'text-white'
                    }">P${driver.position}</td>
                    <td class="px-4 py-2">
                        <div class="flex items-center">
                            <div 
                                class="w-3 h-3 rounded-full mr-2"
                                style="background-color: ${teams[driver.team]?.color || '#666'}"
                            ></div>
                            <span class="${driver.isPlayer ? 'text-blue-300 font-bold' : 'text-white'}">
                                ${driver.name}
                            </span>
                        </div>
                    </td>
                    <td class="px-4 py-2 text-gray-300">${teams[driver.team]?.name}</td>
                </tr>
            `).join('');
            
            document.getElementById('raceTimesContent').innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-2 text-left">Pos</th>
                                <th class="px-4 py-2 text-left">Piloto</th>
                                <th class="px-4 py-2 text-left">Equipo</th>
                            </tr>
                        </thead>
                        <tbody>${timesHTML}</tbody>
                    </table>
                </div>
            `;
            document.getElementById('raceTimesModal').classList.add('show');
        }

        function showAchievements() {
            const progress = getAchievementProgress();
            
            const achievementsHTML = Object.entries(achievements).map(([id, achievement]) => {
                const isUnlocked = gameData.achievements[id];
                
                return `
                <div class="p-4 rounded-lg flex items-center gap-4 mb-3 ${isUnlocked ? 'bg-gradient-to-r from-yellow-900/30 to-orange-900/30 border border-yellow-600' : 'bg-gray-800 opacity-60'}">
                    <div class="text-4xl ${isUnlocked ? '' : 'grayscale opacity-40'}">
                        ${achievement.icon}
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-lg ${isUnlocked ? 'text-yellow-400' : 'text-gray-400'}">
                            ${achievement.name}
                        </div>
                        <div class="text-sm text-gray-400">
                            ${achievement.description}
                        </div>
                        ${isUnlocked ? `
                            <div class="text-xs text-gray-500 mt-1">
                                Desbloqueado: ${new Date(gameData.achievements[id].unlockedAt).toLocaleDateString()}
                            </div>
                        ` : ''}
                    </div>
                    ${isUnlocked ? '<div class="text-green-400 text-2xl">✓</div>' : '<div class="text-gray-600 text-2xl">🔒</div>'}
                </div>
                `;
            }).join('');
            
            document.getElementById('achievementsContent').innerHTML = `
                <div class="mb-6 text-center">
                    <div class="text-4xl font-bold text-yellow-400 mb-2">${progress.unlocked} / ${progress.total}</div>
                    <div class="text-gray-400 mb-3">Logros Desbloqueados</div>
                    <div class="w-full bg-gray-700 rounded-full h-4">
                        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 h-4 rounded-full transition-all" style="width: ${progress.percentage}%"></div>
                    </div>
                    <div class="text-sm text-gray-400 mt-2">${progress.percentage}% completado</div>
                </div>
                <div class="overflow-y-auto max-h-96">
                    ${achievementsHTML}
                </div>
            `;
            document.getElementById('achievementsModal').classList.add('show');
        }

        // ============ SISTEMA DE PESTAÑAS ============
        function switchTab(tabName) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Activar el tab seleccionado
            const selectedContent = document.getElementById(`tab-${tabName}`);
            const selectedButton = document.querySelector(`[data-tab="${tabName}"]`);
            
            if (selectedContent) selectedContent.classList.add('active');
            if (selectedButton) selectedButton.classList.add('active');
        }

        function getStatBadge(value) {
            if (value >= 90) return '<span class="stat-badge stat-high">Excelente</span>';
            if (value >= 80) return '<span class="stat-badge stat-medium">Bueno</span>';
            return '<span class="stat-badge stat-low">Bajo</span>';
        }

        // ============ FUNCIONES DE RENDERIZADO ============
        function renderMainMenu() {
            const hasSave = hasSavedGame();
            return `
            <div class="min-h-screen racing-bg flex items-center justify-center p-4">
                <div class="max-w-2xl w-full">
                    <div class="text-center fade-in">
                        <div class="mb-8">
                            <h1 class="text-7xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-600 via-yellow-500 to-red-600 pulse-glow">
                                F1 SIMULATOR
                            </h1>
                            <div class="text-2xl text-red-600 font-bold tracking-widest">2025 CHAMPIONSHIP EDITION</div>
                            <div class="mt-4 h-1 w-32 mx-auto bg-gradient-to-r from-transparent via-red-600 to-transparent"></div>
                        </div>
                        <div class="space-y-4 mt-12">
                            <button onclick="newGame()" class="w-full btn-primary glow-red py-6 rounded-xl font-bold text-xl transition-all transform hover:scale-105 uppercase tracking-wider">
                                NUEVA CARRERA
                            </button>
                            ${hasSave ? `
                                <button onclick="continueGame()" class="w-full bg-blue-600 hover:bg-blue-700 py-6 rounded-xl font-bold text-xl transition-all transform hover:scale-105 uppercase tracking-wider">
                                    CONTINUAR PARTIDA
                                </button>
                                <button onclick="if(deleteSave()) { render(); }" class="w-full bg-gray-700 hover:bg-gray-800 py-4 rounded-xl font-semibold text-lg transition-all uppercase tracking-wider">
                                    BORRAR PROGRESO
                                </button>
                            ` : ''}
                        </div>
                        <div class="mt-12 text-gray-400 text-sm uppercase tracking-widest">
                            Conviértete en el próximo campeón del mundo
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function renderDriverCreation() {
            return `
            <div class="min-h-screen p-4 racing-bg">
                <div class="max-w-2xl mx-auto fade-in">
                    <div class="text-center mb-8">
                        <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">CREA TU PILOTO</h1>
                        <p class="text-xl text-gray-300">Diseña tu carrera en la Fórmula 1</p>
                    </div>
                    <div class="racing-border rounded-xl p-8 space-y-6">
                        <div>
                            <label class="block text-lg font-semibold mb-3 text-red-500">Nombre del Piloto</label>
                            <input type="text" id="player-name" class="w-full p-4 bg-gray-900 border-2 border-red-600 rounded-lg text-white focus:border-yellow-500 focus:outline-none" placeholder="Ej: Carlos Rodríguez" maxlength="30"/>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-lg font-semibold mb-3 text-red-500">Edad</label>
                                <select id="player-age" class="w-full p-4 bg-gray-900 border-2 border-red-600 rounded-lg text-white focus:border-yellow-500 focus:outline-none">
                                    ${Array.from({length: 17}, (_, i) => i + 16).map(age => `
                                        <option value="${age}" ${age === 16 ? 'selected' : ''}>${age} años</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-lg font-semibold mb-3 text-red-500">Nacionalidad</label>
                                <select id="player-nationality" class="w-full p-4 bg-gray-900 border-2 border-red-600 rounded-lg text-white focus:border-yellow-500 focus:outline-none">
                                    <option value="">Selecciona país</option>
                                    ${Object.entries(countries).map(([country, flag]) => `
                                        <option value="${country}">${flag} ${country}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <button onclick="gameData.state = 'main-menu'; render();" class="flex-1 bg-gray-600 hover:bg-gray-700 p-4 rounded-lg font-semibold transition-all">VOLVER</button>
                            <button onclick="searchContracts()" class="flex-2 btn-primary glow-red p-4 rounded-lg font-bold transition-all">BUSCAR CONTRATOS</button>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (gameData.state === 'main-menu') {
                const hasSave = hasSavedGame();
                app.innerHTML = renderMainMenu();
            } else if (gameData.state === 'create-driver') {
                app.innerHTML = renderDriverCreation();
            } else if (gameData.state === 'contract-offers') {
                const offers = [
                    { teamId: 'williams', team: teams['williams'], salary: 250000, duration: 1 },
                    { teamId: 'haas', team: teams['haas'], salary: 300000, duration: 2 }
                ];
                app.innerHTML = `
                <div class="min-h-screen p-4 racing-bg">
                    <div class="max-w-4xl mx-auto fade-in">
                        <div class="text-center mb-8">
                            <h1 class="text-4xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">OFERTAS DE CONTRATO</h1>
                            <p class="text-xl text-gray-300">${countries[gameData.player.nationality] || ''} ${gameData.player.name}, estas escuderías te quieren</p>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            ${offers.map(offer => `
                                <div class="racing-border rounded-xl p-6 card-hover">
                                    <div class="flex items-center mb-4">
                                        <div class="w-8 h-8 rounded-full mr-4 team-badge" style="background-color: ${offer.team.color}"></div>
                                        <div>
                                            <h3 class="text-xl font-bold">${offer.team.name}</h3>
                                            <p class="text-sm text-gray-400">Potencia: ${offer.team.power}/100</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 mb-4 text-sm">
                                        <div class="flex justify-between">
                                            <span>Aerodinámica:</span>
                                            <span>${getStatBadge(offer.team.aerodynamics)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Fiabilidad:</span>
                                            <span>${getStatBadge(offer.team.reliability)}</span>
                                        </div>
                                    </div>
                                    <button onclick="signContract('${offer.teamId}')" class="w-full btn-primary glow-red p-3 rounded-lg font-semibold transition-all">FIRMAR CONTRATO</button>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-center mt-8">
                            <button onclick="goBack()" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-lg font-semibold transition-all">VOLVER</button>
                        </div>
                    </div>
                </div>
                `;
            } else if (gameData.state === 'main-game') {
                const currentTeam = teams[gameData.selectedTeam];
                const race = calendar[gameData.currentRace];
                const weather = weatherConditions[gameData.currentWeather];
                const tire = tireCompounds[gameData.selectedTireCompound];
                const circuitType = circuitTypes[race.type];
                
                app.innerHTML = `
                <div class="min-h-screen">
                    <div class="bg-black/80 backdrop-blur-sm border-b-2 border-red-600 p-4">
                        <div class="max-w-6xl mx-auto flex justify-between items-center flex-wrap gap-4">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full mr-3 team-badge" style="background-color: ${currentTeam.color}"></div>
                                <div>
                                    <h2 class="text-xl font-bold">${countries[gameData.player.nationality] || ''} ${gameData.player.name}</h2>
                                    <p class="text-gray-400 text-sm">${currentTeam.name}</p>
                                </div>
                            </div>
                            <div class="flex gap-6 text-sm">
                                <div class="text-center">
                                    <div class="font-bold text-yellow-400">${gameData.player.championships}</div>
                                    <div class="text-gray-400">Títulos</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold text-blue-400">${getLevel()}</div>
                                    <div class="text-gray-400">Nivel</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-bold text-green-400">${gameData.player.points || 0}</div>
                                    <div class="text-gray-400">Puntos</div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="saveGame()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-semibold text-sm">GUARDAR</button>
                                <button onclick="showStandings()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold text-sm">CLASIFICACIÓN</button>
                                <button onclick="showAchievements()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded font-semibold text-sm relative">
                                    LOGROS
                                    ${(() => {
                                        const progress = getAchievementProgress();
                                        return progress.unlocked > 0 ? `<span class="absolute -top-1 -right-1 bg-yellow-500 text-black text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">${progress.unlocked}</span>` : '';
                                    })()}
                                </button>
                            </div>
                        </div>
                        <div class="news-bar py-2 mt-2">
                            <div class="news-ticker text-white">${race.name} - ${race.country} - Clima: ${weather.name} ${weather.icon} - Vueltas: ${race.laps}</div>
                        </div>
                    </div>

                    <div class="max-w-7xl mx-auto p-2">
                        <div class="main-game-grid">
                            <!-- Columna Principal - Carrera -->
                            <div class="space-y-4">
                                <div class="racing-border rounded-xl">
                                    <h3 class="text-2xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">
                                        ${race.name}
                                    </h3>
                                    
                                    <!-- Tabs de información -->
                                    <div class="tab-container">
                                        <button class="tab-button active" data-tab="info" onclick="switchTab('info')">Info</button>
                                        <button class="tab-button" data-tab="circuit" onclick="switchTab('circuit')">Circuito</button>
                                        <button class="tab-button" data-tab="tires" onclick="switchTab('tires')">Neumáticos</button>
                                    </div>
                                    
                                    <!-- Tab: Información General -->
                                    <div id="tab-info" class="tab-content active">
                                        <div class="compact-grid mb-3">
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">País</div>
                                                <div class="compact-stat-value">${race.country}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Tipo</div>
                                                <div class="compact-stat-value">${circuitType.name}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Clima</div>
                                                <div class="compact-stat-value ${weather.color}">${weather.icon} ${weather.name}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Vueltas</div>
                                                <div class="compact-stat-value">${race.laps}</div>
                                            </div>
                                        </div>
                                        <div class="text-xs text-yellow-400 text-center p-2 bg-gray-900 rounded">
                                            ⚠️ El clima puede cambiar durante la carrera
                                        </div>
                                    </div>
                                    
                                    <!-- Tab: Circuito -->
                                    <div id="tab-circuit" class="tab-content">
                                        <div class="circuit-map-compact">
                                            ${renderCircuitMap(race.type)}
                                        </div>
                                    </div>
                                    
                                    <!-- Tab: Neumáticos -->
                                    <div id="tab-tires" class="tab-content">
                                        <div class="space-y-2">
                                            ${Object.entries(tireCompounds).map(([compound, data]) => {
                                                const selected = gameData.selectedTireCompound === compound;
                                                const estWear = calculateTireWear(race.laps, data, weather);
                                                const estStops = calculatePitStops(race.laps, data, weather);
                                                return `
                                                <div onclick="selectTireCompound('${compound}')" class="tire-compact ${selected ? 'selected' : ''}">
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-2xl">${data.icon}</span>
                                                        <div>
                                                            <div class="text-sm font-bold ${data.color}">${data.name}</div>
                                                            <div class="text-xs text-gray-400">+${data.speed} vel | ${data.grip}% agarre</div>
                                                        </div>
                                                    </div>
                                                    <div class="text-right">
                                                        <div class="text-xs text-gray-400">${estStops} parada${estStops !== 1 ? 's' : ''}</div>
                                                        <div class="text-xs ${estWear > 80 ? 'text-red-400' : 'text-green-400'}">${Math.round(estWear)}% desgaste</div>
                                                    </div>
                                                </div>
                                            `}).join('')}
                                        </div>
                                        
                                        ${gameData.racePhase === 'practice' || gameData.racePhase === 'qualifying' ? `
                                            <div class="bg-gray-800 p-2 rounded mt-3">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <input 
                                                        type="checkbox" 
                                                        id="planPitStop" 
                                                        ${gameData.pitStopPlanned ? 'checked' : ''}
                                                        onchange="gameData.pitStopPlanned = this.checked; render();"
                                                        class="w-4 h-4"
                                                    />
                                                    <label for="planPitStop" class="text-xs font-semibold">Estrategia de Pit Stop</label>
                                                </div>
                                                ${gameData.pitStopPlanned ? `
                                                    <input 
                                                        type="range" 
                                                        min="10" 
                                                        max="${race.laps - 10}" 
                                                        value="${gameData.pitStopLap || Math.floor(race.laps / 2)}"
                                                        onchange="gameData.pitStopLap = parseInt(this.value); render();"
                                                        class="w-full mb-1"
                                                    />
                                                    <div class="text-center text-xs text-yellow-400 mb-2">Vuelta ${gameData.pitStopLap || Math.floor(race.laps / 2)}</div>
                                                    <select 
                                                        onchange="gameData.pitStopNewTire = this.value; render();"
                                                        class="w-full p-1 bg-gray-900 border border-red-600 rounded text-xs text-white"
                                                    >
                                                        ${Object.entries(tireCompounds).map(([key, tire]) => `
                                                            <option value="${key}" ${gameData.pitStopNewTire === key ? 'selected' : ''}>
                                                                ${tire.icon} ${tire.name}
                                                            </option>
                                                        `).join('')}
                                                    </select>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <!-- Botones de acción -->
                                    <div class="mt-4">
                                        ${gameData.racePhase === 'practice' ? `
                                            <div class="grid grid-cols-2 gap-2">
                                                <button onclick="conductTraining()" ${gameData.trainingDone || gameData.isProcessing ? 'disabled' : ''} class="btn-primary glow-red p-3 rounded-lg font-semibold disabled:opacity-50 text-sm">
                                                    ${gameData.trainingDone ? '✓ COMPLETADO' : gameData.isProcessing ? 'ENTRENANDO...' : 'ENTRENAR'}
                                                </button>
                                                <button onclick="runQualifying()" class="bg-yellow-600 hover:bg-yellow-700 p-3 rounded-lg font-semibold text-sm">
                                                    CLASIFICACIÓN
                                                </button>
                                            </div>
                                        ` : gameData.racePhase === 'qualifying' && gameData.qualifyingPos ? `
                                            <div class="bg-gray-900 p-3 rounded-lg mb-3 text-center">
                                                <p class="text-sm mb-1">Tu posición:</p>
                                                <p class="text-3xl font-bold ${gameData.qualifyingPos <= 3 ? 'text-yellow-500' : 'text-red-500'}">P${gameData.qualifyingPos}</p>
                                            </div>
                                            <button onclick="startRace()" class="w-full btn-primary glow-red p-3 rounded-lg font-semibold">INICIAR CARRERA</button>
                                        ` : gameData.racePhase === 'results' ? `
                                            <div class="bg-gray-900 p-4 rounded-lg mb-3 text-center">
                                                <p class="text-sm text-gray-400 mb-1">Posición Final</p>
                                                <p class="text-3xl font-bold mb-2 ${gameData.raceResults[gameData.raceResults.length - 1].position <= 3 ? 'text-yellow-500' : 'text-red-500'}">
                                                    P${gameData.raceResults[gameData.raceResults.length - 1].position}
                                                </p>
                                                <div class="flex justify-center gap-4 text-sm">
                                                    <span class="text-yellow-400">${gameData.raceResults[gameData.raceResults.length - 1].points} pts</span>
                                                    <span class="text-green-400">+${gameData.raceResults[gameData.raceResults.length - 1].budgetEarned || 0} I+D</span>
                                                </div>
                                                ${gameData.raceResults[gameData.raceResults.length - 1].teammatePosition ? `
                                                    <div class="mt-2 pt-2 border-t border-gray-700 text-xs">
                                                        <span class="text-gray-400">Compañero: </span>
                                                        <span class="${gameData.raceResults[gameData.raceResults.length - 1].position < gameData.raceResults[gameData.raceResults.length - 1].teammatePosition ? 'text-green-400' : 'text-red-400'}">
                                                            P${gameData.raceResults[gameData.raceResults.length - 1].teammatePosition}
                                                        </span>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            
                                            ${gameData.raceEvents && gameData.raceEvents.length > 0 ? `
                                                <div class="bg-gray-900 p-2 rounded-lg mb-3 max-h-32 overflow-y-auto">
                                                    <h4 class="text-xs font-bold mb-2 text-yellow-500">EVENTOS</h4>
                                                    ${gameData.raceEvents.map(event => `
                                                        <div class="flex items-center gap-2 text-xs p-1 bg-gray-800 rounded mb-1">
                                                            <span>${event.icon}</span>
                                                            <span class="text-gray-300">${event.text}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                            
                                            <div class="grid grid-cols-2 gap-2">
                                                <button onclick="showRaceTimes()" class="bg-purple-600 hover:bg-purple-700 p-2 rounded-lg font-semibold text-sm">TIEMPOS</button>
                                                <button onclick="nextRace()" class="btn-primary glow-red p-2 rounded-lg font-semibold text-sm">
                                                    ${gameData.currentRace + 1 >= calendar.length ? 'FINALIZAR' : 'SIGUIENTE'}
                                                </button>
                                            </div>
                                        ` : '<div class="text-center py-4"><div class="spinner w-10 h-10 border-4 border-red-600 border-t-transparent rounded-full mx-auto"></div></div>'}
                                    </div>
                                </div>
                                
                                <!-- Características del coche compacto -->
                                <div class="racing-border rounded-xl">
                                    <h3 class="text-lg font-bold mb-2 text-yellow-500">COCHE</h3>
                                    ${(() => {
                                        const carStats = getCarStats();
                                        const baseTeam = teams[gameData.selectedTeam];
                                        return `
                                        <div class="compact-grid">
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Potencia</div>
                                                <div class="compact-stat-value text-green-400">${Math.round(carStats.power)}</div>
                                                <div class="text-xs text-gray-500 line-through">${baseTeam.power}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Aero</div>
                                                <div class="compact-stat-value text-green-400">${Math.round(carStats.aerodynamics)}</div>
                                                <div class="text-xs text-gray-500 line-through">${baseTeam.aerodynamics}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Fiabilidad</div>
                                                <div class="compact-stat-value text-green-400">${Math.round(carStats.reliability)}</div>
                                                <div class="text-xs text-gray-500 line-through">${baseTeam.reliability}</div>
                                            </div>
                                            <div class="compact-stat">
                                                <div class="compact-stat-label">Chasis</div>
                                                <div class="compact-stat-value text-green-400">${Math.round(carStats.chassis)}</div>
                                            </div>
                                        </div>
                                        `;
                                    })()}
                                </div>
                            </div>
                            
                            <!-- Columna Central - Habilidades -->
                            <div class="space-y-4">
                                <div class="racing-border rounded-xl">
                                    <h3 class="text-lg font-bold mb-3 text-yellow-500">HABILIDADES</h3>
                                    ${Object.entries(gameData.player.skills).map(([skill, value]) => `
                                        <div class="mb-2">
                                            <div class="flex justify-between mb-1">
                                                <span class="text-xs">${skill}</span>
                                                <div class="flex items-center gap-1">
                                                    <span class="text-xs font-bold">${value}</span>
                                                    <button onclick="upgradeSkill('${skill}')" ${getAvailablePoints() === 0 || value >= 100 ? 'disabled' : ''} class="w-5 h-5 bg-red-600 hover:bg-red-700 disabled:bg-gray-600 rounded text-xs font-bold leading-none">+</button>
                                                </div>
                                            </div>
                                            <div class="w-full bg-gray-700 rounded-full h-1.5">
                                                <div class="progress-bar h-1.5 rounded-full" style="width: ${value}%"></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                    <div class="mt-3 pt-3 border-t border-gray-700 text-center">
                                        <p class="text-xs text-gray-400">Disponibles: <span class="font-bold text-yellow-400">${getAvailablePoints()}</span></p>
                                    </div>
                                </div>
                                
                                <!-- VS Compañero compacto -->
                                <div class="racing-border rounded-xl">
                                    <h3 class="text-lg font-bold mb-2 text-yellow-500">VS COMPAÑERO</h3>
                                    <div class="text-center mb-2">
                                        <div class="text-xs text-gray-400">${teams[gameData.selectedTeam].drivers.find(d => d !== gameData.player.name)}</div>
                                    </div>
                                    <div class="compact-grid text-xs">
                                        <div class="compact-stat">
                                            <div class="compact-stat-label">Clasificación</div>
                                            <div class="compact-stat-value ${teammateComparison.qualifyingBattles.player > teammateComparison.qualifyingBattles.teammate ? 'text-green-400' : 'text-red-400'}">
                                                ${teammateComparison.qualifyingBattles.player}-${teammateComparison.qualifyingBattles.teammate}
                                            </div>
                                        </div>
                                        <div class="compact-stat">
                                            <div class="compact-stat-label">Carreras</div>
                                            <div class="compact-stat-value ${teammateComparison.raceBattles.player > teammateComparison.raceBattles.teammate ? 'text-green-400' : 'text-red-400'}">
                                                ${teammateComparison.raceBattles.player}-${teammateComparison.raceBattles.teammate}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-2 text-xs">
                                        <span class="text-gray-400">Puntos: </span>
                                        <span class="font-bold ${teammateComparison.pointsGap > 0 ? 'text-green-400' : 'text-red-400'}">
                                            ${teammateComparison.pointsGap > 0 ? '+' : ''}${teammateComparison.pointsGap}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Columna Derecha - Desarrollo -->
                            <div class="racing-border rounded-xl">
                                <h3 class="text-lg font-bold mb-3 text-yellow-500">I+D</h3>
                                <div class="text-center mb-3">
                                    <div class="text-xs text-gray-400">Presupuesto</div>
                                    <div class="text-2xl font-bold text-green-400">${gameData.devBudget}</div>
                                </div>
                                <div class="space-y-2">
                                    ${Object.entries(carDevelopment).map(([key, upgrade]) => {
                                        const currentLevel = gameData.carUpgrades[key];
                                        const cost = upgrade.cost * (currentLevel + 1);
                                        const isMaxed = currentLevel >= upgrade.maxLevel;
                                        const canAfford = gameData.devBudget >= cost;
                                        
                                        return `
                                        <div class="bg-gray-900 p-2 rounded-lg">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-xs font-semibold">${upgrade.name}</span>
                                                <span class="text-xs ${isMaxed ? 'text-green-400' : 'text-gray-400'}">
                                                    ${currentLevel}/${upgrade.maxLevel}
                                                </span>
                                            </div>
                                            <div class="w-full bg-gray-700 rounded-full h-1 mb-1">
                                                <div class="bg-gradient-to-r from-red-600 to-yellow-500 h-1 rounded-full" style="width: ${(currentLevel / upgrade.maxLevel) * 100}%"></div>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span class="text-xs text-gray-400">${cost} pts</span>
                                                <button 
                                                    onclick="upgradeCar('${key}')" 
                                                    ${isMaxed || !canAfford || gameData.racePhase !== 'practice' ? 'disabled' : ''}
                                                    class="text-xs px-2 py-1 rounded ${isMaxed ? 'bg-gray-600' : canAfford ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-600'} disabled:opacity-50 disabled:cursor-not-allowed"
                                                >
                                                    ${isMaxed ? 'MAX' : '↑'}
                                                </button>
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                                <div class="mt-2 text-xs text-gray-400 text-center">
                                    ${gameData.racePhase === 'practice' ? '✓ Disponible ahora' : '⏸ Solo en práctica'}
                                </div>
                            </div>
                        </div>
                    </div>                    

                </div>
                
                `;
            }else if (gameData.state === 'season-end') {
                const standings = gameData.finalStandings || [];
                const playerPos = gameData.seasonPlayerPosition || 1;
                const isChampion = playerPos === 1;
                
                app.innerHTML = `
                <div class="min-h-screen racing-bg p-4">
                    <div class="max-w-4xl mx-auto fade-in">
                        <div class="text-center mb-8">
                            ${isChampion ? `
                                <h1 class="text-6xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-yellow-500 to-yellow-600 animate-pulse">
                                    ¡CAMPEÓN DEL MUNDO!
                                </h1>
                                <div class="text-3xl text-yellow-500 mb-4">🏆 TEMPORADA 2025 🏆</div>
                            ` : `
                                <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">
                                    FIN DE TEMPORADA
                                </h1>
                                <div class="text-2xl ${playerPos <= 3 ? 'text-yellow-500' : playerPos <= 10 ? 'text-blue-500' : 'text-gray-400'} mb-4">
                                    Posición Final: ${playerPos}º
                                </div>
                            `}
                        </div>
                        
                        <div class="racing-border rounded-xl p-6 mb-6">
                            <h2 class="text-2xl font-bold mb-4 text-yellow-500">CLASIFICACIÓN FINAL</h2>
                            <div class="space-y-2">
                                ${standings.slice(0, 10).map((driver, idx) => `
                                    <div class="p-3 rounded-lg flex justify-between items-center ${
                                        driver.isPlayer ? 'bg-blue-900/50 border-2 border-blue-400' : 
                                        idx === 0 ? 'bg-yellow-900/30' :
                                        idx === 1 ? 'bg-gray-700/30' :
                                        idx === 2 ? 'bg-orange-900/30' : 'bg-gray-800'
                                    }">
                                        <div class="flex items-center gap-3">
                                            <span class="font-bold text-2xl ${
                                                idx === 0 ? 'text-yellow-400' :
                                                idx === 1 ? 'text-gray-300' :
                                                idx === 2 ? 'text-orange-400' : 'text-white'
                                            }">${idx + 1}º</span>
                                            <div 
                                                class="w-4 h-4 rounded-full"
                                                style="background-color: ${teams[driver.team]?.color || '#666'}"
                                            ></div>
                                            <div>
                                                <span class="font-semibold ${driver.isPlayer ? 'text-blue-300' : 'text-white'}">
                                                    ${driver.isPlayer ? countries[gameData.player.nationality] + ' ' : ''}${driver.name}
                                                </span>
                                                <div class="text-xs text-gray-400">${teams[driver.team]?.name}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-yellow-400">${driver.points} pts</div>
                                            <div class="text-xs text-gray-400">${driver.wins} victorias</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="racing-border rounded-xl p-6 mb-6">
                            <h3 class="text-xl font-bold mb-4 text-yellow-500">ESTADÍSTICAS DE LA TEMPORADA</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-gray-900 p-4 rounded-lg text-center">
                                    <div class="text-3xl font-bold text-yellow-400">${gameData.raceResults.filter(r => r.position === 1).length}</div>
                                    <div class="text-sm text-gray-400">Victorias</div>
                                </div>
                                <div class="bg-gray-900 p-4 rounded-lg text-center">
                                    <div class="text-3xl font-bold text-blue-400">${gameData.raceResults.filter(r => r.position <= 3).length}</div>
                                    <div class="text-sm text-gray-400">Podios</div>
                                </div>
                                <div class="bg-gray-900 p-4 rounded-lg text-center">
                                    <div class="text-3xl font-bold text-green-400">${gameData.raceResults.filter(r => r.position <= 10).length}</div>
                                    <div class="text-sm text-gray-400">Puntos</div>
                                </div>
                                <div class="bg-gray-900 p-4 rounded-lg text-center">
                                    <div class="text-3xl font-bold text-purple-400">${(gameData.raceResults.reduce((sum, r) => sum + r.position, 0) / gameData.raceResults.length).toFixed(1)}</div>
                                    <div class="text-sm text-gray-400">Posición Media</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="racing-border rounded-xl p-6 mb-6">
                            <h3 class="text-xl font-bold mb-4 text-yellow-500">VS COMPAÑERO DE EQUIPO</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span>Clasificaciones:</span>
                                    <span class="font-bold ${teammateComparison.qualifyingBattles.player > teammateComparison.qualifyingBattles.teammate ? 'text-green-400' : 'text-red-400'}">
                                        ${teammateComparison.qualifyingBattles.player} - ${teammateComparison.qualifyingBattles.teammate}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Carreras:</span>
                                    <span class="font-bold ${teammateComparison.raceBattles.player > teammateComparison.raceBattles.teammate ? 'text-green-400' : 'text-red-400'}">
                                        ${teammateComparison.raceBattles.player} - ${teammateComparison.raceBattles.teammate}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>Diferencia de puntos:</span>
                                    <span class="font-bold ${teammateComparison.pointsGap > 0 ? 'text-green-400' : 'text-red-400'}">
                                        ${teammateComparison.pointsGap > 0 ? '+' : ''}${teammateComparison.pointsGap}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="gameData.state = 'main-menu'; render();" class="bg-gray-600 hover:bg-gray-700 p-4 rounded-lg font-semibold transition-all">
                                MENÚ PRINCIPAL
                            </button>
                            <button onclick="startNewSeason()" class="btn-primary glow-red p-4 rounded-lg font-bold transition-all">
                                NUEVA TEMPORADA
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }else if (gameData.state === 'team-offers') {
                const offers = generateTeamOffers(gameData.player.reputation, gameData.selectedTeam);
                
                app.innerHTML = `
                <div class="min-h-screen racing-bg p-4">
                    <div class="max-w-4xl mx-auto fade-in">
                        <div class="text-center mb-8">
                            <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500">
                                OFERTAS DE EQUIPOS
                            </h1>
                            <p class="text-xl text-gray-300">Temporada ${gameData.player.championships > 0 ? gameData.player.championships + 1 : 2}</p>
                            <p class="text-lg text-gray-400 mt-2">Tu reputación: ${gameData.player.reputation}/100</p>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            ${offers.map(offer => {
                                const salaryFormatted = (offer.salary / 1000).toFixed(0);
                                return `
                                <div class="racing-border rounded-xl p-6 card-hover ${offer.isCurrentTeam ? 'border-blue-500' : ''}">
                                    <div class="flex items-center mb-4">
                                        <div class="w-10 h-10 rounded-full mr-4 team-badge" style="background-color: ${offer.team.color}"></div>
                                        <div>
                                            <h3 class="text-xl font-bold">${offer.team.name}</h3>
                                            ${offer.isCurrentTeam ? '<span class="text-xs text-blue-400">Tu equipo actual</span>' : ''}
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                                        <div class="bg-gray-900 p-3 rounded-lg">
                                            <div class="text-gray-400 mb-1">Potencia</div>
                                            <div class="font-bold">${offer.team.power}/100</div>
                                        </div>
                                        <div class="bg-gray-900 p-3 rounded-lg">
                                            <div class="text-gray-400 mb-1">Aerodinámica</div>
                                            <div class="font-bold">${offer.team.aerodynamics}/100</div>
                                        </div>
                                        <div class="bg-gray-900 p-3 rounded-lg">
                                            <div class="text-gray-400 mb-1">Fiabilidad</div>
                                            <div class="font-bold">${offer.team.reliability}/100</div>
                                        </div>
                                        <div class="bg-gray-900 p-3 rounded-lg">
                                            <div class="text-gray-400 mb-1">Reputación</div>
                                            <div class="font-bold">${offer.team.reputation}/100</div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gray-900 p-4 rounded-lg mb-4">
                                        <div class="flex justify-between mb-2">
                                            <span class="text-gray-400">Salario anual:</span>
                                            <span class="text-green-400 font-bold">$${salaryFormatted}K</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">Duración:</span>
                                            <span class="text-yellow-400 font-bold">${offer.duration} ${offer.duration === 1 ? 'año' : 'años'}</span>
                                        </div>
                                    </div>
                                    
                                    <button onclick="acceptTeamOffer('${offer.teamId}')" class="w-full ${offer.isCurrentTeam ? 'bg-blue-600 hover:bg-blue-700' : 'btn-primary glow-red'} p-3 rounded-lg font-semibold transition-all">
                                        ${offer.isCurrentTeam ? 'RENOVAR CONTRATO' : 'ACEPTAR OFERTA'}
                                    </button>
                                </div>
                            `}).join('')}
                        </div>
                        
                        ${offers.length === 1 ? `
                            <div class="text-center text-gray-400 mb-6">
                                <p>No hay otras ofertas disponibles esta temporada.</p>
                                <p class="text-sm mt-2">Mejora tu rendimiento para atraer equipos mejores.</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                `;
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => render(), 500);
        });
        
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) closeModal();
        });
    </script>
</body>
</html>
